<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dummy - Weather's Weird Side</title>
  <link rel="icon" href="dummy_logo.png"/>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{--red:#dc2626;--blue:#3b82f6;--green:#10b981;--amber:#f59e0b;--gray:#f3f4f6;--dark:#0f172a;--muted:#64748b;--card:#ffffff}
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;background:var(--gray);color:var(--dark)}

    header{background:var(--card);border-bottom:3px solid var(--red);padding:1rem;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:1000}
    .logo{display:flex;align-items:center;gap:.75rem}
    .logo img{height:40px;width:auto}
    h1{font-size:1.5rem;font-weight:900;color:var(--red);letter-spacing:-.02em}

    .location-control{display:flex;gap:.5rem;align-items:center;background:var(--gray);padding:.5rem 1rem;border-radius:999px}
    .location-control input{border:none;background:none;outline:none;width:200px}

    .tabs{display:flex;background:var(--card);padding:.5rem;gap:.5rem}
    .tab{padding:.75rem 1.5rem;border:0;background:transparent;font-weight:700;cursor:pointer;border-radius:.5rem;transition:.2s}
    .tab:hover{background:var(--gray)}
    .tab.active{background:var(--red);color:#fff}

    .content{max-width:1200px;margin:0 auto;padding:1rem}
    .section{display:none}
    .section.active{display:block}

    .card{background:var(--card);border-radius:1rem;padding:1.5rem;margin:1rem 0;box-shadow:0 4px 20px rgba(0,0,0,.08)}

    .metrics{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:1rem;margin:1.5rem 0}
    .metric{text-align:center;padding:1rem;background:var(--gray);border-radius:.75rem}
    .metric-value{font-size:2rem;font-weight:900;color:var(--red)}
    .metric-label{font-size:.75rem;text-transform:uppercase;color:var(--muted);margin-top:.25rem}

    .map{height:500px;border-radius:1rem;overflow:hidden;margin:1rem 0}

    .insight{background:linear-gradient(90deg,rgba(59,130,246,.1),transparent);border-left:3px solid var(--blue);padding:1rem;margin:1rem 0;border-radius:0 .5rem .5rem 0}
    .data-age{position:absolute;top:1rem;right:1rem;padding:.25rem .75rem;background:rgba(255,255,255,.9);border-radius:999px;font-size:.75rem;color:var(--muted)}

    .twin-card{background:var(--gray);padding:1rem;border-radius:.75rem;margin:.5rem 0;display:flex;justify-content:space-between;align-items:center}

    .loading{display:inline-block;width:20px;height:20px;border:3px solid rgba(0,0,0,.1);border-top-color:var(--red);border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    .timeline{display:flex;gap:.5rem;overflow:auto;padding:.25rem 0 .5rem}
    .bucket{min-width:96px;background:#f1f5f9;border:1px solid #e2e8f0;border-radius:10px;padding:.6rem;text-align:center}
    .bucket strong{display:block;font-size:.9rem}
    .bucket .tval{font-size:1.2rem;font-weight:900;color:var(--red)}
    .bucket .mini{font-size:.7rem;color:#64748b}

    /* emoji pins (no white halo) */
    .emoji-pin{font-size:22px;line-height:22px;text-align:center;transform:translate(-50%,-50%);filter:drop-shadow(0 1px 2px rgba(0,0,0,.25))}
    .pill-btn{border:1px solid #e2e8f0;background:#fff;border-radius:999px;padding:.35rem .7rem;font-weight:700;cursor:pointer}
    .pill-btn:hover{background:#f8fafc}
  </style>
</head>
<body>

<header>
  <div class="logo">
    <img src="dummy_logo.png" alt="DUMMY" onerror="this.style.display='none'">
    <h1>DUMMY</h1>
  </div>
  <div class="location-control">
    <span>üìç</span>
    <input type="text" id="locationInput" placeholder="Click map or enter coords">
    <button class="pill-btn" onclick="setLocation()">Set</button>
  </div>
</header>

<nav class="tabs">
  <button class="tab active" onclick="switchTab(event,'local')">Your Weather</button>
  <button class="tab" onclick="switchTab(event,'twins')">Weather Twins</button>
  <button class="tab" onclick="switchTab(event,'gradient')">Weather Gradient</button>
  <button class="tab" onclick="switchTab(event,'roulette')">Weather Roulette</button>
</nav>

<div class="content">
  <!-- Your Weather -->
  <section id="local" class="section active">
    <div class="card" style="position:relative">
      <div class="data-age" id="dataAge">Data: -- min old</div>
      <h2>Your Exact Weather</h2>
      <p style="color:var(--muted);margin-top:.5rem">Click the map to change location</p>

      <div class="metrics">
        <div class="metric"><div class="metric-value" id="temp">--¬∞</div><div class="metric-label">Temperature</div></div>
        <div class="metric"><div class="metric-value" id="wetbulb">--¬∞</div><div class="metric-label">Wet Bulb</div></div>
        <div class="metric"><div class="metric-value" id="dewpoint">--¬∞</div><div class="metric-label">Dew Point</div></div>
        <div class="metric"><div class="metric-value" id="vpd">-- kPa</div><div class="metric-label">VPD</div></div>
        <div class="metric"><div class="metric-value" id="spread">--¬∞</div><div class="metric-label">T‚ÄìTd Spread</div></div>
        <div class="metric"><div class="metric-value" id="pressure">-- hPa</div><div class="metric-label">Pressure</div></div>
      </div>

      <div class="insight" id="moistureInsight">Analyzing moisture dynamics‚Ä¶</div>
      <div class="insight" id="condensationRisk">Condensation risk assessment‚Ä¶</div>
      <div class="insight" id="firepitHint">Checking tonight‚Äôs fire-pit potential‚Ä¶</div>

      <h3 style="margin-top:.5rem">Dew Point Forecast</h3>
      <p style="color:var(--muted);margin:.25rem 0 .5rem">Next 12 hours</p>
      <div id="dewTimeline" class="timeline"></div>
      <p style="color:var(--muted);margin:.5rem 0 .25rem">Next 5 days (min / max)</p>
      <div id="dewDays" class="timeline"></div>

      <h3 style="margin-top:1rem">Fire Pit Forecast</h3>
      <p style="color:var(--muted);margin:.25rem 0 .5rem">Best evenings this week for outdoor fires (6‚Äì11 PM)</p>
      <div id="fireDays" class="timeline"></div>

      <div id="localMap" class="map"></div>
    </div>
  </section>

  <!-- Weather Twins -->
  <section id="twins" class="section">
    <div class="card">
      <h2>Weather Twins</h2>
      <p style="color:var(--muted)">US places experiencing your weather profile right now</p>
      <div id="twinsList"><p style="text-align:center;color:var(--muted)">Click the tab to search for twins‚Ä¶</p></div>
      <div id="twinsMap" class="map"></div>
    </div>
  </section>

  <!-- Weather Gradient -->
  <section id="gradient" class="section">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <h2>Weather Gradient Explorer</h2>
          <p style="color:var(--muted)">Click two points to draw a weather cross-section; colored line shows temps</p>
        </div>
        <button class="pill-btn" onclick="clearGradient()">Clear</button>
      </div>
      <div id="gradientMap" class="map"></div>
      <div id="gradientChart" style="margin-top:1rem">
        <p style="text-align:center;color:var(--muted)">Click two points on the map to see the cross-section</p>
      </div>
    </div>
  </section>

  <!-- Weather Roulette -->
  <section id="roulette" class="section">
    <div class="card">
      <h2>Weather Roulette</h2>
      <p style="color:var(--muted)">Click anywhere on the map for a 3-way comparison (US only)</p>
      <div id="rouletteMap" class="map"></div>
      <div id="rouletteResults"><p style="text-align:center;color:var(--muted)">Click on the map to spin the weather roulette!</p></div>
    </div>
  </section>
</div>

<script>
/* ------------- helpers: time & US mask ------------- */
const fmtTime = iso => new Date(iso).toLocaleTimeString('en-US',{hour:'numeric'});
const localDateStr = d => new Date(d).toLocaleDateString('en-CA'); // YYYY-MM-DD
function approxUSLower48(lat, lon){
  if(lat<25 || lat>49.5 || lon<-125 || lon>-66) return false;
  if(lat<28.6 && lon>-97 && lon<-80) return false;  // Gulf shelf
  if(lon>-78 && lat<34.6) return false;             // SE Atlantic shelf
  if(lat<31.3 && lon>-117 && lon<-98) return false; // N. Mexico fringe
  return true;
}

/* ------------- throttled reverse geocode (US only) ------------- */
const geocodeCache=new Map();let geocodeQueue=Promise.resolve();
async function nameIfUSLand(lat, lon, withState=false){
  if(!approxUSLower48(lat,lon)) return null;
  const key=`${lat.toFixed(3)},${lon.toFixed(3)}_${withState}`;
  if(geocodeCache.has(key)) return geocodeCache.get(key);
  return geocodeQueue = geocodeQueue.then(async()=>{
    await new Promise(r=>setTimeout(r,120));
    try{
      const url=`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=12&addressdetails=1&accept-language=en&countrycodes=us`;
      const r=await fetch(url); if(!r.ok) { geocodeCache.set(key,null); return null; }
      const j=await r.json(); const a=j.address||{};
      const waterWords=['Ocean','Gulf','Bay','Sound','Sea','Lagoon'];
      if(waterWords.some(w=>j.display_name?.includes(w))) { geocodeCache.set(key,null); return null; }
      let label=(a.city||a.town||a.village||a.hamlet||a.county||'').toString();
      if(!label && a.state) label=a.state; if(!label){ geocodeCache.set(key,null); return null; }
      if(withState && a.state) label=`${label}, ${a.state}`;
      geocodeCache.set(key,label); return label;
    }catch{ geocodeCache.set(key,null); return null; }
  });
}

/* ------------- weather service ------------- */
class Weather{
  constructor(){this.cache=new Map();this.CACHE=5*60*1000;}
  async get(lat,lon){
    const key=`${lat.toFixed(2)},${lon.toFixed(2)}`;const c=this.cache.get(key);
    if(c && Date.now()-c.t<this.CACHE) return c.d;
    try{
      const url=`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,dew_point_2m,surface_pressure,wind_speed_10m&temperature_unit=fahrenheit&wind_speed_unit=mph`;
      const r=await fetch(url);
      if(r.ok){
        const d=await r.json();
        const out={temp:Math.round(d.current.temperature_2m),dewpoint:Math.round(d.current.dew_point_2m),humidity:d.current.relative_humidity_2m,pressure:Math.round(d.current.surface_pressure),wind:Math.round(d.current.wind_speed_10m),timestamp:new Date(),source:'Open-Meteo'};
        this.cache.set(key,{d:out,t:Date.now()});return out;
      }
    }catch(e){console.error(e)}
    return {temp:72,dewpoint:55,humidity:50,pressure:1013,wind:5,timestamp:new Date(),source:'Fallback'};
  }
  async hourly(lat,lon){
    const url=`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=dew_point_2m,temperature_2m,wind_speed_10m,precipitation_probability,cloud_cover&daily=sunset&temperature_unit=fahrenheit&wind_speed_unit=mph&timezone=auto`;
    const r=await fetch(url); const j=await r.json();
    const hours=(j.hourly.time||[]).map((t,i)=>({time:t,dp:Math.round(j.hourly.dew_point_2m?.[i]??NaN),temp:Math.round(j.hourly.temperature_2m?.[i]??NaN),wind:Math.round(j.hourly.wind_speed_10m?.[i]??0),pop:j.hourly.precipitation_probability?.[i]??null,clouds:j.hourly.cloud_cover?.[i]??null}));
    // group by local date, but only from today forward
    const today=localDateStr(new Date());
    const byDay=new Map();
    hours.forEach(h=>{const d=localDateStr(h.time); if(d<today) return; if(!byDay.has(d)) byDay.set(d,[]); byDay.get(d).push(h);});
    const days=[...byDay.entries()].slice(0,7).map(([date,hourData])=>({
      date,
      dow:new Date(date).toLocaleDateString('en-US',{weekday:'short'}),
      min:Math.min(...hourData.map(h=>h.dp).filter(v=>!isNaN(v))),
      max:Math.max(...hourData.map(h=>h.dp).filter(v=>!isNaN(v))),
      hours:hourData
    }));
    return {hours,days};
  }
}
const weather=new Weather();

/* ------------- calcs ------------- */
function wetBulb(tF,rh){const C=(tF-32)*5/9;const wb=C*Math.atan(0.151977*Math.sqrt(rh+8.313659))+Math.atan(C+rh)-Math.atan(rh-1.676331)+0.00391838*Math.pow(rh,1.5)*Math.atan(0.023101*rh)-4.686035;return Math.round(wb*9/5+32);}
function vpd(tF,rh){const C=(tF-32)*5/9;const svp=0.6108*Math.exp(17.27*C/(C+237.3));const avp=svp*rh/100;return (svp-avp).toFixed(2);}
const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
function tempColor(t){const tn=clamp((t-10)/90,0,1);const hue=240-240*tn;return `hsl(${hue} 85% 50%)`;}

/* ------------- state ------------- */
let userLocation={lat:40.7128,lon:-74.0060};
let maps={};

/* ------------- Your Weather panel ------------- */
async function updateLocal(){
  const d=await weather.get(userLocation.lat,userLocation.lon);
  document.getElementById('temp').textContent=`${d.temp}¬∞`;
  document.getElementById('dewpoint').textContent=`${d.dewpoint}¬∞`;
  document.getElementById('wetbulb').textContent=`${wetBulb(d.temp,d.humidity)}¬∞`;
  document.getElementById('vpd').textContent=`${vpd(d.temp,d.humidity)}`;
  document.getElementById('spread').textContent=`${d.temp-d.dewpoint}¬∞`;
  document.getElementById('pressure').textContent=`${d.pressure}`;
  const age=Math.round((Date.now()-d.timestamp)/60000);
  document.getElementById('dataAge').textContent=`Data: ${age} min old (${d.source})`;

  const spread=d.temp-d.dewpoint;
  const moist=spread<5?'‚ö†Ô∏è Near saturation ‚Äî fog/mist likely'
              :spread<10?'Very humid ‚Äî condensation on cold surfaces'
              :spread<20?'Comfortable moisture levels'
              :'Dry air ‚Äî static electricity likely';
  const dv=vpd(d.temp,d.humidity);
  document.getElementById('moistureInsight').innerHTML=`<strong>Moisture Status:</strong> ${moist}<br><strong>VPD ${dv} kPa:</strong> ${dv<0.5?'Air is saturated':dv>2?'Air is very thirsty':'Moderate moisture demand'}`;

  const surfaces=[{name:'Windows',temp:d.temp-15},{name:'Walls',temp:d.temp-8},{name:'Metal objects',temp:d.temp-20}];
  const risks=surfaces.filter(s=>s.temp<=d.dewpoint).map(s=>s.name);
  document.getElementById('condensationRisk').innerHTML=risks.length?`‚ö†Ô∏è <strong>Condensation likely on:</strong> ${risks.join(', ')}`:`‚úì <strong>No condensation risk</strong> ‚Äî all surfaces above dew point`;

  const fc=await weather.hourly(userLocation.lat,userLocation.lon);

  // 12h dew timeline starting at next hour
  const now=new Date();const nextIdx=fc.hours.findIndex(h=>new Date(h.time)>now);
  const next12=(nextIdx>=0?fc.hours.slice(nextIdx,nextIdx+12):fc.hours.slice(0,12));
  const tl=document.getElementById('dewTimeline'); tl.innerHTML='';
  next12.forEach(h=>{
    const el=document.createElement('div');el.className='bucket';
    el.innerHTML=`<strong>${fmtTime(h.time)}</strong><div class="tval">${h.dp}¬∞</div><div class="mini">${(h.pop??'‚Äì')}% precip ‚Ä¢ ${h.wind} mph</div>`;
    tl.appendChild(el);
  });

  // next 5 days (today forward)
  const days=document.getElementById('dewDays'); days.innerHTML='';
  fc.days.slice(0,5).forEach(dy=>{
    const el=document.createElement('div');el.className='bucket';
    el.innerHTML=`<strong>${dy.dow}</strong><div class="tval">${dy.min}¬∞ ‚Äì ${dy.max}¬∞</div><div class="mini">min / max dew</div>`;
    days.appendChild(el);
  });

  // evening fire-pit scoring (6‚Äì11 PM local)
  const firePitDays=document.getElementById('fireDays'); firePitDays.innerHTML='';
  fc.days.slice(0,7).forEach(day=>{
    const evening=day.hours.filter(h=>{const hr=new Date(h.time).getHours();return hr>=18&&hr<=23;});
    if(!evening.length) return;
    const avg=(arr,sel)=>Math.round(arr.reduce((a,b)=>a+sel(b),0)/arr.length);
    const avgDew=avg(evening,h=>h.dp);
    const avgTemp=avg(evening,h=>h.temp);
    const maxWind=Math.max(...evening.map(h=>h.wind));
    const maxPop=Math.max(...evening.map(h=>h.pop??0));
    const avgClouds=avg(evening,h=>h.clouds??50);

    // score (0‚Äì100) ‚Äì heavier weight for dew (ideal 40‚Äì55)
    let score=100;
    if(avgDew<40) score-= (40-avgDew)*2.5;    // too dry
    if(avgDew>55) score-= (avgDew-55)*2.5;    // too humid
    if(maxWind>10) score-= (maxWind-10)*3;
    if(maxWind>20) score=0;
    score-= maxPop*0.9;
    if(avgClouds>30) score-= (avgClouds-30)*0.5;
    if(avgTemp<55) score-= (55-avgTemp);
    if(avgTemp>75) score-= (avgTemp-75)*0.5;
    score=clamp(Math.round(score),0,100);

    let rating='‚ùå',color='#dc2626';
    if(score>=80){rating='üî•üî•üî•';color='#10b981'}
    else if(score>=60){rating='üî•üî•';color='#f59e0b'}
    else if(score>=40){rating='üî•';color='#64748b'}

    const el=document.createElement('div');el.className='bucket';el.style.minWidth='110px';
    el.innerHTML=`<strong>${day.dow}</strong>
      <div style="font-size:1.5rem">${rating}</div>
      <div class="mini" style="color:${color}">${score}% ideal</div>
      <div class="mini" style="font-size:.62rem">${avgTemp}¬∞F ‚Ä¢ ${maxWind}mph<br>${maxPop}% rain ‚Ä¢ ${avgClouds}% clouds</div>`;
    firePitDays.appendChild(el);
  });

  // tonight hint
  const tonight=fc.hours.filter(h=>localDateStr(h.time)===localDateStr(new Date()) && new Date(h.time).getHours()>=18 && new Date(h.time).getHours()<=23);
  if(tonight.length){
    const avgDew=Math.round(tonight.reduce((a,b)=>a+b.dp,0)/tonight.length);
    const maxWind=Math.max(...tonight.map(h=>h.wind));
    const maxPop=Math.max(...tonight.map(h=>h.pop??0));
    const good=(avgDew>=40&&avgDew<=55)&&maxWind<=12&&maxPop<25;
    document.getElementById('firepitHint').innerHTML=good?`üî• <strong>Good fire-pit tonight:</strong> avg dew ${avgDew}¬∞, wind ‚â§${maxWind} mph, precip ‚â§${maxPop}%`:`ü™µ <strong>Meh for fire-pit:</strong> avg dew ${avgDew}¬∞, wind up to ${maxWind} mph, precip up to ${maxPop}%`;
  }else{
    document.getElementById('firepitHint').textContent='Fire-pit check: evening data not available yet.';
  }
}

/* ------------- Twins ------------- */
async function findTwins(){
  const me=await weather.get(userLocation.lat,userLocation.lon);
  const list=document.getElementById('twinsList');
  list.innerHTML='<div class="loading" style="margin:20px auto;display:block"></div>';

  if(maps.twins){
    maps.twins.eachLayer(l=>{ if(l instanceof L.Marker || l instanceof L.CircleMarker) maps.twins.removeLayer(l); });
  }

  const grid=[];
  for(let lat=26;lat<=48;lat+=3){ for(let lon=-124;lon<=-67;lon+=4){ if(approxUSLower48(lat,lon)) grid.push({lat,lon}); } }

  const candidates=[];
  for(const p of grid){
    const w=await weather.get(p.lat,p.lon);
    const sim=Math.abs(w.temp-me.temp)+Math.abs(w.dewpoint-me.dewpoint)+Math.abs(w.pressure-me.pressure)/10;
    if(sim<10) candidates.push({lat:p.lat,lon:p.lon,weather:w,similarity:sim});
  }
  candidates.sort((a,b)=>a.similarity-b.similarity);

  const named=[];
  for(const c of candidates){
    const nm=await nameIfUSLand(c.lat,c.lon,true);
    if(nm){ named.push({...c,name:nm}); if(named.length>=12) break; }
  }

  if(!named.length){ list.innerHTML='<p style="text-align:center;color:var(--muted)">No close US land twins found.</p>'; return; }

  list.innerHTML = named.slice(0,6).map(t=>`
    <div class="twin-card">
      <div><strong>${t.name}</strong><br>${t.weather.temp}¬∞F / ${t.weather.dewpoint}¬∞ dew / ${t.weather.pressure} hPa</div>
      <div style="color:var(--green);font-weight:bold">${Math.max(0,Math.min(100,Math.round(100 - t.similarity*10)))}% match</div>
    </div>`).join('');

  if(maps.twins){
    const youName=await nameIfUSLand(userLocation.lat,userLocation.lon,true) || 'Your location';
    L.marker([userLocation.lat,userLocation.lon]).bindPopup(`You: <strong>${youName}</strong>`).addTo(maps.twins);
    named.forEach(t=>{
      L.circleMarker([t.lat,t.lon],{radius:8,color:'#10b981',fillOpacity:.6})
        .bindPopup(`<strong>${t.name}</strong><br>${t.weather.temp}¬∞F / ${t.weather.dewpoint}¬∞ dew`)
        .addTo(maps.twins);
    });
    setTimeout(()=>maps.twins.invalidateSize(),0);
  }
}

/* ------------- Gradient Explorer ------------- */
let gradientClicks=[], gradientSegs=[], gradientDots=[];
function clearGradient(){
  gradientClicks=[]; gradientSegs.forEach(s=>maps.gradient.removeLayer(s)); gradientSegs=[];
  gradientDots.forEach(s=>maps.gradient.removeLayer(s)); gradientDots=[];
  document.getElementById('gradientChart').innerHTML='<p style="text-align:center;color:var(--muted)">Click two points on the map to see the cross-section</p>';
}
async function gradientClick(e){
  const {lat, lng:lon}=e.latlng;
  gradientClicks.push([lat,lon]);
  if(gradientClicks.length===1){
    // show start pin
    const dot=L.circleMarker([lat,lon],{radius:6,color:'#111',weight:1,fillColor:'#fff',fillOpacity:1}).addTo(maps.gradient);
    gradientDots.push(dot);
    document.getElementById('gradientChart').innerHTML='<p style="text-align:center;color:var(--muted)">Start set. Click an end point‚Ä¶</p>';
    return;
  }
  if(gradientClicks.length>=2){
    const [a,b]=gradientClicks;
    // sample 20 points along line
    const samples=[]; const N=20;
    for(let i=0;i<=N;i++){
      const t=i/N; const slat=a[0]+(b[0]-a[0])*t; const slon=a[1]+(b[1]-a[1])*t;
      samples.push({lat:slat,lon:slon});
    }
    document.getElementById('gradientChart').innerHTML='<div class="loading" style="margin:20px auto;display:block"></div>';

    // fetch weather
    const data=[];
    for(const s of samples){ const w=await weather.get(s.lat,s.lon); data.push({...s,...w}); }

    // draw colored path on map
    gradientSegs.forEach(s=>maps.gradient.removeLayer(s)); gradientSegs=[];
    gradientDots.forEach(s=>maps.gradient.removeLayer(s)); gradientDots=[];
    for(let i=0;i<data.length-1;i++){
      const mid=(data[i].temp+data[i+1].temp)/2;
      const seg=L.polyline([[data[i].lat,data[i].lon],[data[i+1].lat,data[i+1].lon]],{color:tempColor(mid),weight:6,opacity:.85}).addTo(maps.gradient);
      gradientSegs.push(seg);
    }
    data.forEach(d=>{
      const dot=L.circleMarker([d.lat,d.lon],{radius:4,color:'#fff',weight:1,fillColor:tempColor(d.temp),fillOpacity:1})
        .bindTooltip(`${Math.round(d.temp)}¬∞ / dew ${Math.round(d.dewpoint)}¬∞`,{sticky:true})
        .addTo(maps.gradient);
      gradientDots.push(dot);
    });

    // bars below map
    buildGradientChart(data);

    // ready for next line
    gradientClicks=[];
  }
}
function buildGradientChart(data){
  const chart=document.getElementById('gradientChart');
  const maxT=Math.max(...data.map(d=>d.temp)), minT=Math.min(...data.map(d=>d.temp));
  const maxD=Math.max(...data.map(d=>d.dewpoint)), minD=Math.min(...data.map(d=>d.dewpoint));
  let html='<div style="background:#f8f9fa;padding:1rem;border-radius:.5rem;font-family:system-ui">';
  html+='<h4 style="margin:0 0 .75rem">Weather Cross-Section</h4>';
  html+='<div style="margin-bottom:1rem"><strong style="color:#dc2626">Temperature (¬∞F)</strong>';
  html+='<div style="display:flex;align-items:flex-end;height:110px;gap:4px;margin:.5rem 0">';
  data.forEach(d=>{const h=((d.temp-minT)/(maxT-minT||1))*110; html+=`<div title="${d.temp}¬∞" style="flex:1;background:#dc2626;height:${h}px;position:relative"><span style="position:absolute;bottom:-18px;font-size:10px;left:50%;transform:translateX(-50%)">${d.temp}</span></div>`;});
  html+='</div></div>';
  html+='<div><strong style="color:#3b82f6">Dew Point (¬∞F)</strong>';
  html+='<div style="display:flex;align-items:flex-end;height:110px;gap:4px;margin:.5rem 0">';
  data.forEach(d=>{const h=((d.dewpoint-minD)/(maxD-minD||1))*110; html+=`<div title="${d.dewpoint}¬∞" style="flex:1;background:#3b82f6;height:${h}px;position:relative"><span style="position:absolute;bottom:-18px;font-size:10px;left:50%;transform:translateX(-50%)">${d.dewpoint}</span></div>`;});
  html+='</div></div>';
  html+='</div>';
  chart.innerHTML=html;
}

/* ------------- Roulette (US only + emoji markers) ------------- */
function divEmoji(emoji){return L.divIcon({className:'emoji-pin',html:emoji,iconSize:[22,22],iconAnchor:[11,11]});}
async function roulette(lat,lon){
  if(!approxUSLower48(lat,lon)) return;
  const clicked=await weather.get(lat,lon);
  // find opposite
  let opp=null,maxDiff=-1;
  for(let la=26;la<=48;la+=5){for(let lo=-124;lo<=-67;lo+=6){if(!approxUSLower48(la,lo))continue;const w=await weather.get(la,lo);const diff=Math.abs(w.temp-clicked.temp)+Math.abs(w.dewpoint-clicked.dewpoint);if(diff>maxDiff){maxDiff=diff;opp={lat:la,lon:lo,weather:w};}}}
  // wildcard
  let wlat, wlon; do{wlat=26+Math.random()*22; wlon=-124+Math.random()*57;}while(!approxUSLower48(wlat,wlon));
  const wild=await weather.get(wlat,wlon);

  // names
  const clickName=await nameIfUSLand(lat,lon,true)||`${lat.toFixed(2)}, ${Math.abs(lon).toFixed(2)}¬∞W`;
  const oppName=await nameIfUSLand(opp.lat,opp.lon,true)||`${opp.lat.toFixed(2)}, ${Math.abs(opp.lon).toFixed(2)}¬∞W`;
  const wildName=await nameIfUSLand(wlat,wlon,true)||`${wlat.toFixed(2)}, ${Math.abs(wlon).toFixed(2)}¬∞W`;

  // map pins
  if(maps.roulette){
    maps.roulette.eachLayer(l=>{ if(l._emoji) maps.roulette.removeLayer(l); });
    const a=L.marker([lat,lon],{icon:divEmoji('üìç')}).addTo(maps.roulette); a._emoji=true;
    const b=L.marker([opp.lat,opp.lon],{icon:divEmoji('üîÑ')}).addTo(maps.roulette); b._emoji=true;
    const c=L.marker([wlat,wlon],{icon:divEmoji('üé≤')}).addTo(maps.roulette); c._emoji=true;
  }

  document.getElementById('rouletteResults').innerHTML=`
    <h3>üìç Your Click: ${clickName}</h3>
    <div class="twin-card"><div>${clicked.temp}¬∞F / ${clicked.dewpoint}¬∞ dew / ${clicked.pressure} hPa</div></div>
    <h3>üîÑ Weather Opposite: ${oppName}</h3>
    <div class="twin-card"><div>${opp.weather.temp}¬∞F / ${opp.weather.dewpoint}¬∞ dew / ${opp.weather.pressure} hPa</div><div style="color:var(--amber);font-weight:bold">${maxDiff}¬∞ different!</div></div>
    <h3>üé≤ Wildcard: ${wildName}</h3>
    <div class="twin-card"><div>${wild.temp}¬∞F / ${wild.dewpoint}¬∞ dew / ${wild.pressure} hPa</div></div>
  `;
}

/* ------------- maps, tabs, location ------------- */
function initMaps(){
  // local
  maps.local=L.map('localMap').setView([userLocation.lat,userLocation.lon],9);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap contributors'}).addTo(maps.local);
  const localMarker=L.marker([userLocation.lat,userLocation.lon]).addTo(maps.local);
  maps.local.on('click',async e=>{userLocation={lat:e.latlng.lat,lon:e.latlng.lng};localMarker.setLatLng(e.latlng);document.getElementById('locationInput').value=`${userLocation.lat.toFixed(4)}, ${userLocation.lon.toFixed(4)}`;await updateLocal();});

  // twins
  maps.twins=L.map('twinsMap').setView([39,-98],4);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap contributors'}).addTo(maps.twins);

  // gradient
  maps.gradient=L.map('gradientMap').setView([39,-98],4);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap contributors'}).addTo(maps.gradient);
  maps.gradient.on('click',gradientClick);

  // roulette
  maps.roulette=L.map('rouletteMap').setView([39,-98],4);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap contributors'}).addTo(maps.roulette);
  maps.roulette.on('click',e=>roulette(e.latlng.lat,e.latlng.lng));
}
window.switchTab=function(evt,tab){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  evt.target.classList.add('active');
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.getElementById(tab).classList.add('active');
  setTimeout(()=>{ if(maps[tab]) maps[tab].invalidateSize(); },100);
  if(tab==='twins') findTwins();
};
window.setLocation=async function(){
  const input=document.getElementById('locationInput').value.trim();
  const parts=input.split(',').map(s=>parseFloat(s));
  if(parts.length===2 && !isNaN(parts[0]) && !isNaN(parts[1])){
    userLocation={lat:parts[0],lon:parts[1]};
    if(maps.local){
      maps.local.setView([userLocation.lat,userLocation.lon],9);
      maps.local.eachLayer(l=>{ if(l instanceof L.Marker) l.setLatLng([userLocation.lat,userLocation.lon]); });
    }
    await updateLocal();
  }else{ alert('Enter: latitude, longitude (e.g., 40.7128, -74.0060)'); }
};
function getUserLocation(){
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(async pos=>{
      userLocation={lat:pos.coords.latitude,lon:pos.coords.longitude};
      document.getElementById('locationInput').value=`${userLocation.lat.toFixed(4)}, ${userLocation.lon.toFixed(4)}`;
      if(maps.local){
        maps.local.setView([userLocation.lat,userLocation.lon],9);
        maps.local.eachLayer(l=>{ if(l instanceof L.Marker) l.setLatLng([userLocation.lat,userLocation.lon]); });
      }
      await updateLocal();
    },err=>console.log('Geolocation error:',err));
  }
}

/* ------------- boot ------------- */
window.addEventListener('DOMContentLoaded', async ()=>{
  initMaps();
  getUserLocation();
  updateLocal(); // default NYC first render
});
</script>
</body>
</html>
