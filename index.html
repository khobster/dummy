<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dummy - Weather's Weird Side</title>
  <link rel="icon" href="dummy_logo.png"/>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --red:#dc2626; --blue:#3b82f6; --green:#10b981; --amber:#f59e0b;
      --gray:#f3f4f6; --dark:#0f172a; --muted:#64748b; --card:#ffffff; --tooltip:#111827;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;background:var(--gray);color:var(--dark)}

    header{background:var(--card);border-bottom:3px solid var(--red);padding:1rem;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:1000}
    .logo{display:flex;align-items:center;gap:.75rem}
    .logo img{height:40px;width:auto}
    h1{font-size:1.5rem;font-weight:900;color:var(--red);letter-spacing:-.02em}

    .location-control{display:flex;gap:.5rem;align-items:center;background:var(--gray);padding:.5rem 1rem;border-radius:999px}
    .location-control input{border:none;background:none;outline:none;width:240px}

    .tabs{display:flex;background:var(--card);padding:.5rem;gap:.5rem}
    .tab{padding:.75rem 1.5rem;border:0;background:transparent;font-weight:700;cursor:pointer;border-radius:.5rem;transition:.2s}
    .tab:hover{background:var(--gray)}
    .tab.active{background:var(--red);color:#fff}

    .content{max-width:1200px;margin:0 auto;padding:1rem}
    .section{display:none}
    .section.active{display:block}

    .card{background:var(--card);border-radius:1rem;padding:1.25rem;margin:1rem 0;box-shadow:0 4px 20px rgba(0,0,0,.08)}
    .metrics{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:1rem;margin:1rem 0}
    .metric{text-align:center;padding:1rem;background:#f8fafc;border:1px solid #e5e7eb;border-radius:.75rem}
    .metric-value{font-size:2rem;font-weight:900;color:var(--red)}
    .metric-label{font-size:.75rem;text-transform:uppercase;color:var(--muted);margin-top:.25rem}

    .insight{background:linear-gradient(90deg,rgba(59,130,246,.08),transparent);border-left:3px solid var(--blue);padding:1rem;margin:.8rem 0;border-radius:0 .5rem .5rem 0}
    .data-age{position:absolute;top:1rem;right:1rem;padding:.25rem .75rem;background:rgba(255,255,255,.9);border-radius:999px;font-size:.75rem;color:var(--muted)}

    .timeline{display:flex;gap:.5rem;overflow:auto;padding:.25rem 0 .5rem}
    .bucket{min-width:92px;background:#f1f5f9;border:1px solid #e2e8f0;border-radius:10px;padding:.5rem;text-align:center}
    .bucket strong{display:block;font-size:.9rem}
    .bucket .tval{font-size:1.2rem;font-weight:900;color:var(--red)}
    .bucket .mini{font-size:.7rem;color:#64748b}

    .map{height:560px;border-radius:1rem;overflow:hidden;margin:1rem 0}

    /* ===== Outcome meters v2 ===== */
    .outcomes{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:.9rem;margin-top:.5rem}
    .out{background:#f8fafc;border:1px solid #e2e8f0;border-radius:.9rem;padding:.9rem}
    .out h4{font-size:1rem;margin:0 0 .45rem;display:flex;gap:.5rem;align-items:center;justify-content:space-between}
    .scoretag{font-weight:700;font-size:.85rem;color:#0f172a}
    .gauge{display:flex;align-items:center;gap:.5rem}
    .g-track{position:relative;height:12px;flex:1;border-radius:999px;
      background:linear-gradient(90deg,#ef4444 0 25%,#f59e0b 25% 50%,#84cc16 50% 75%,#10b981 75% 100%);
      box-shadow:inset 0 0 0 1px #e2e8f0}
    .g-tick{position:absolute;top:0;bottom:0;width:1px;background:#ffffffaa}
    .g-tick.t25{left:25%}.g-tick.t50{left:50%}.g-tick.t75{left:75%}
    .g-pointer{position:absolute;top:50%;transform:translate(-50%,-50%);width:14px;height:14px;border-radius:50%;
      background:#111827;border:2px solid #fff;box-shadow:0 1px 3px rgba(0,0,0,.25)}
    .scale-labels{display:flex;justify-content:space-between;font-size:.72rem;color:#64748b;margin:.3rem .1rem 0}
    .mini{font-size:.82rem;color:#475569;margin-top:.4rem}
    .reasons{margin-top:.45rem;display:flex;flex-wrap:wrap;gap:.35rem}
    .badge{font-size:.72rem;line-height:1;border-radius:999px;padding:.22rem .45rem;border:1px solid #e2e8f0;background:#fff}
    .badge.negative{border-color:#fecaca;background:#fff1f2}
    .badge.positive{border-color:#bbf7d0;background:#f0fdf4}

    /* ===== Radar toolbar + telestrator ===== */
    .toolbar{display:flex;flex-wrap:wrap;gap:.5rem;align-items:center;margin:.25rem 0 0}
    .toolbtn{padding:.4rem .6rem;border:1px solid #e5e7eb;background:#fff;border-radius:.5rem;cursor:pointer}
    .toolbtn.active{background:#111827;color:#fff}
    .toolsep{width:1px;height:26px;background:#e5e7eb}
    .toolrow{display:flex;gap:.5rem;align-items:center}
    .colorchip{width:20px;height:20px;border-radius:50%;border:1px solid #e2e8f0;cursor:pointer}
    .arrowhead{font-size:18px; color:#111827; transform-origin:center center}
    .scrub{flex:1; min-width:160px}

    input[type=range]{accent-color:#111827}
    select{border:1px solid #e5e7eb;border-radius:.5rem;padding:.3rem .45rem;background:#fff}
  </style>
</head>
<body>

<header>
  <div class="logo">
    <img src="dummy_logo.png" alt="DUMMY" onerror="this.style.display='none'">
    <h1>DUMMY</h1>
  </div>
  <div class="location-control">
    <span>üìç</span>
    <input type="text" id="locationInput" placeholder="Click map or enter coords (lat, lon)">
    <button onclick="setLocation()">Set</button>
  </div>
</header>

<nav class="tabs">
  <button class="tab active" onclick="switchTab(event,'local')">Your Weather</button>
  <button class="tab" onclick="switchTab(event,'radar')">Radar (Draw)</button>
</nav>

<div class="content">
  <!-- Your Weather -->
  <section id="local" class="section active">
    <div class="card" style="position:relative">
      <div class="data-age" id="dataAge">Data: -- min old</div>
      <h2>Your Exact Weather</h2>
      <p style="color:var(--muted);margin-top:.5rem">Click the map or enter coordinates to change location.</p>

      <div class="metrics">
        <div class="metric"><div class="metric-value" id="temp">--¬∞</div><div class="metric-label">Temperature</div></div>
        <div class="metric"><div class="metric-value" id="dewpoint">--¬∞</div><div class="metric-label">Dew Point</div></div>
        <div class="metric"><div class="metric-value" id="wetbulb">--¬∞</div><div class="metric-label">Wet Bulb</div></div>
        <div class="metric"><div class="metric-value" id="vpd">-- kPa</div><div class="metric-label">VPD</div></div>
        <div class="metric"><div class="metric-value" id="spread">--¬∞</div><div class="metric-label">T‚ÄìTd Spread</div></div>
        <div class="metric"><div class="metric-value" id="pressure">-- hPa</div><div class="metric-label">Pressure</div></div>
      </div>

      <div class="insight" id="moistureInsight">Analyzing moisture dynamics‚Ä¶</div>
      <div class="insight" id="firepitHint">Checking tonight‚Äôs fire-pit potential‚Ä¶</div>

      <h3 style="margin-top:.5rem">Outcomes (for humans)</h3>
      <div class="outcomes" id="outcomesMeters"></div>

      <h3 style="margin-top:1rem">Dew Point Forecast</h3>
      <p style="color:var(--muted);margin:.25rem 0 .5rem">Next 12 hours</p>
      <div id="dewTimeline" class="timeline"></div>
      <p style="color:var(--muted);margin:.5rem 0 .25rem">Next 5 days (min / max)</p>
      <div id="dewDays" class="timeline"></div>

      <h3 style="margin-top:1rem">Fire Pit Forecast</h3>
      <p style="color:var(--muted);margin:.25rem 0 .5rem">Best evenings this week for outdoor fires</p>
      <div id="fireDays" class="timeline"></div>

      <div id="localMap" class="map"></div>
    </div>
  </section>

  <!-- Radar + telestrator with animation -->
  <section id="radar" class="section">
    <div class="card">
      <h2>Radar (Draw)</h2>
      <div class="toolrow toolbar">
        <!-- draw tools -->
        <button class="toolbtn active" id="tool-pen">‚úèÔ∏è Pen</button>
        <button class="toolbtn" id="tool-hand">üñê Hand</button>
        <button class="toolbtn" id="tool-arrow">‚û§ Arrow</button>
        <button class="toolbtn" id="tool-rect">‚ñ≠ Box</button>
        <button class="toolbtn" id="tool-circle">‚óØ Circle</button>
        <button class="toolbtn" id="tool-text">‚úé Text</button>
        <span class="toolsep"></span>
        <div class="toolrow">
          <span style="font-size:.85rem;color:#475569">Color</span>
          <div class="colorchip" data-color="#111827" style="background:#111827"></div>
          <div class="colorchip" data-color="#dc2626" style="background:#dc2626"></div>
          <div class="colorchip" data-color="#2563eb" style="background:#2563eb"></div>
          <div class="colorchip" data-color="#16a34a" style="background:#16a34a"></div>
          <div class="colorchip" data-color="#f59e0b" style="background:#f59e0b"></div>
        </div>
        <div class="toolrow" style="margin-left:.5rem">
          <span style="font-size:.85rem;color:#475569">Width</span>
          <input id="penWidth" type="range" min="2" max="12" step="1" value="4">
        </div>
        <span class="toolsep"></span>
        <button class="toolbtn" id="tool-undo">‚Ü∂ Undo</button>
        <button class="toolbtn" id="tool-clear">üóë Clear</button>
      </div>

      <div class="toolrow toolbar" style="margin-top:.5rem">
        <!-- animation controls -->
        <button class="toolbtn" id="rv-prev" title="Previous frame">‚óÄÔ∏é</button>
        <button class="toolbtn" id="rv-play" title="Play/Pause">‚ñ∂Ô∏é Play</button>
        <button class="toolbtn" id="rv-next" title="Next frame">‚ñ∂Ô∏é</button>
        <div class="toolrow" style="margin-left:.5rem">
          <span style="font-size:.85rem;color:#475569">Speed</span>
          <select id="rv-speed">
            <option value="1000">1√ó</option>
            <option value="600" selected>1.5√ó</option>
            <option value="400">2.5√ó</option>
          </select>
        </div>
        <input id="rv-slider" class="scrub" type="range" min="0" max="0" value="0">
        <span style="margin-left:.5rem;font-size:.85rem;color:#475569" id="radarTime">Radar: ‚Äî</span>
      </div>

      <div id="radarMap" class="map"></div>
    </div>
  </section>
</div>

<script>
/* ========= Utilities ========= */
async function fetchJSON(url, timeoutMs=9000){
  const ctrl = new AbortController(); const t=setTimeout(()=>ctrl.abort('timeout'), timeoutMs);
  try{ const r=await fetch(url,{signal:ctrl.signal}); if(!r.ok) throw new Error('HTTP '+r.status); return await r.json(); }
  finally{ clearTimeout(t); }
}
const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
const fmtTime = iso => new Date(iso).toLocaleTimeString('en-US',{hour:'numeric'});
function wetBulb(tF,rh){const C=(tF-32)*5/9;const wb=C*Math.atan(0.151977*Math.sqrt(rh+8.313659))+Math.atan(C+rh)-Math.atan(rh-1.676331)+0.00391838*Math.pow(rh,1.5)*Math.atan(0.023101*rh)-4.686035;return Math.round(wb*9/5+32);}
function vpd(tF,rh){const C=(tF-32)*5/9;const svp=0.6108*Math.exp(17.27*C/(C+237.3));const avp=svp*(rh??50)/100;return (svp-avp).toFixed(2);}
function dewpointFromTRH(tF, rh){const tC=(tF-32)*5/9;const a=17.625,b=243.04;const g=Math.log(Math.max(1e-6,rh/100))+(a*tC)/(b+tC);const dC=(b*g)/(a-g);return dC*9/5+32;}
const dateKeyInTz=(iso,tz)=> new Date(iso).toLocaleDateString('en-CA',{timeZone:tz});
const todayKeyInTz=(tz)=> new Date().toLocaleDateString('en-CA',{timeZone:tz});

/* ========= Weather service ========= */
class Weather{
  constructor(){ this.cache=new Map(); this.CACHE=5*60*1000; }
  async get(lat,lon){
    const key=`${lat.toFixed(2)},${lon.toFixed(2)}`; const c=this.cache.get(key);
    if(c && Date.now()-c.t<this.CACHE) return c.d;
    try{
      const p=await fetchJSON(`https://api.weather.gov/points/${lat.toFixed(4)},${lon.toFixed(4)}`,8000);
      const st=await fetchJSON(p.properties.observationStations,8000);
      for(const f of (st.features||[]).slice(0,6)){
        const id=f.properties?.stationIdentifier; if(!id) continue;
        try{
          const ob=await fetchJSON(`https://api.weather.gov/stations/${id}/observations/latest`,8000);
          const pr=ob.properties||{};
          const tC=pr.temperature?.value, tdC=pr.dewpoint?.value, pPa=pr.barometricPressure?.value, rh=pr.relativeHumidity?.value;
          if(tC!=null && pPa!=null){
            let dpF=(tdC!=null)?(tdC*9/5+32):dewpointFromTRH(tC*9/5+32, rh??50);
            let out={ temp:Math.round(tC*9/5+32), dewpoint:Math.round(dpF), humidity:Math.round(rh??50),
              pressure:Math.round(pPa/100), wind:Math.round(((pr.windSpeed?.value)||0)*2.237),
              timestamp:new Date(pr.timestamp||Date.now()), source:'NOAA' };
            if(out.humidity<97 && Math.abs(out.temp - out.dewpoint)<=0) out.dewpoint=Math.round(dewpointFromTRH(out.temp,out.humidity));
            this.cache.set(key,{d:out,t:Date.now()}); return out;
          }
        }catch{}
      }
    }catch{}
    try{
      const j=await fetchJSON(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,dew_point_2m,surface_pressure,wind_speed_10m&temperature_unit=fahrenheit&wind_speed_unit=mph`,9000);
      let out={ temp:Math.round(j.current.temperature_2m), dewpoint:Math.round(j.current.dew_point_2m),
        humidity:j.current.relative_humidity_2m, pressure:Math.round(j.current.surface_pressure),
        wind:Math.round(j.current.wind_speed_10m), timestamp:new Date(), source:'Open-Meteo' };
      if(out.humidity<97 && Math.abs(out.temp - out.dewpoint)<=0) out.dewpoint=Math.round(dewpointFromTRH(out.temp,out.humidity));
      this.cache.set(key,{d:out,t:Date.now()}); return out;
    }catch{}
    return {temp:72,dewpoint:55,humidity:50,pressure:1013,wind:5,timestamp:new Date(),source:'Fallback'};
  }
  async hourly(lat,lon){
    const j=await fetchJSON(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=dew_point_2m&hourly=dew_point_2m,temperature_2m,relative_humidity_2m,wind_speed_10m,precipitation_probability,cloud_cover&temperature_unit=fahrenheit&wind_speed_unit=mph&timezone=auto`,9000);
    const hours=(j.hourly.time||[]).map((t,i)=>{
      const temp=Math.round(j.hourly.temperature_2m?.[i]??NaN);
      const rh=j.hourly.relative_humidity_2m?.[i]??null;
      let dp=Math.round(j.hourly.dew_point_2m?.[i]??NaN);
      if(Number.isNaN(dp) || (rh!=null && rh<97 && Math.abs(dp-temp)<=0)){
        if(rh!=null && Number.isFinite(temp)) dp=Math.round(dewpointFromTRH(temp,rh));
      }
      return {time:t, temp, dp, wind:Math.round(j.hourly.wind_speed_10m?.[i]??0), pop:j.hourly.precipitation_probability?.[i]??0, clouds:j.hourly.cloud_cover?.[i]??null};
    });
    return {hours, omCurrentDp:j.current?.dew_point_2m!=null?Math.round(j.current.dew_point_2m):null, tz:j.timezone||'UTC'};
  }
}
const weather=new Weather();

/* ========= State & maps ========= */
let userLocation={lat:33.0318,lon:-79.7287}; // Huger, SC default
let maps={}; let drawState=null; let drawLayer=null; let shapes=[];

/* ========= Outcomes ========= */
function gradeLabel(s){ if(s>=85) return ['Perfect','positive']; if(s>=70) return ['Good','positive']; if(s>=50) return ['Okay','neutral']; return ['Nope','negative']; }
function makeGaugeCard(id, icon, title, baseDesc, extremes){
  const el=document.createElement('div'); el.className='out';
  el.innerHTML = `
    <h4>${icon} ${title}<span class="scoretag" id="${id}-score">‚Äî</span></h4>
    <div class="gauge">
      <div class="g-track" id="${id}-track">
        <div class="g-tick t25"></div><div class="g-tick t50"></div><div class="g-tick t75"></div>
        <div class="g-pointer" id="${id}-ptr" style="left:0%"></div>
      </div>
    </div>
    <div class="scale-labels">
      <span>${extremes[0]}</span><span>${extremes[1]}</span><span>${extremes[2]}</span><span>${extremes[3]}</span>
    </div>
    <div class="mini" id="${id}-desc">${baseDesc}</div>
    <div class="reasons" id="${id}-reasons"></div>
  `;
  return el;
}
function setGauge(id, score, desc, reasons){
  score=Math.max(0,Math.min(100,Math.round(score)));
  const ptr=document.getElementById(`${id}-ptr`), tag=document.getElementById(`${id}-score`), dEl=document.getElementById(`${id}-desc`), rEl=document.getElementById(`${id}-reasons`);
  if(!ptr||!tag) return;
  ptr.style.left=`${score}%`;
  const [grade]=gradeLabel(score); tag.textContent=`${score} ‚Ä¢ ${grade}`;
  dEl.textContent=desc;
  rEl.innerHTML=''; (reasons||[]).forEach(({text,good})=>{ const s=document.createElement('span'); s.className=`badge ${good===true?'positive':good===false?'negative':''}`; s.textContent=text; rEl.appendChild(s); });
}
function suggestClothes(t){ if(t<=35) return 'Heavy coat, hat, gloves'; if(t<=50) return 'Jacket + layers'; if(t<=60) return 'Light jacket / long sleeves'; if(t<=70) return 'Breathable tee + shorts'; if(t<=80) return 'Tee + shorts, light colors'; if(t<=90) return 'Very light, hydrate'; return 'Minimal & shade; avoid peak heat'; }
function renderOutcomeMeters(curr, next6){
  const wrap=document.getElementById('outcomesMeters'); wrap.innerHTML='';
  const maxPop=Math.max(...next6.map(h=>h.pop??0),0);
  /* CHANGED: forecast-only wind with a reasonable cap */
  const maxWind = Math.min(40, Math.max(...next6.map(h => h.wind ?? 0), 0));
  const R={ t:v=>({text:`${v}¬∞F`,good:v>=60&&v<=78}), dp:v=>({text:`Td ${v}¬∞`,good:v>=40&&v<=60}), wind:v=>({text:`Wind ${v} mph`,good:v<=12}), pop:v=>({text:`${v}% rain`,good:v<25}) };

  // Windows Open (strict humidity)
  let s1=100;
  if(curr.temp<55) s1-=(55-curr.temp)*2;
  if(curr.temp>78) s1-=(curr.temp-78)*1.5;
  if(curr.dewpoint<35) s1-=(35-curr.dewpoint)*2;
  if(curr.dewpoint>60) s1-=(curr.dewpoint-60)*4;
  if(curr.dewpoint>=70) s1=Math.min(s1,20);
  if(maxWind>18) s1-=(maxWind-18)*2.5;
  s1-=(maxPop||0)*0.6;
  s1=clamp(s1,0,100);
  const c1=makeGaugeCard('m1','ü™ü','Windows Open','Comfort with outside air in the house.',['gosh no','meh','nice','goshdarnit absolutely']); wrap.appendChild(c1);
  setGauge('m1',s1,'Comfort window for the next few hours.',[R.t(curr.temp),R.dp(curr.dewpoint),R.wind(maxWind),R.pop(maxPop)]);

  // Windows-Down Drive
  let s2=100; if(curr.temp<50) s2-=(50-curr.temp)*2; if(curr.temp>82) s2-=(curr.temp-82)*2; if(curr.dewpoint>68) s2-=(curr.dewpoint-68)*2; s2-=maxPop*0.9; s2=clamp(s2,0,100);
  const c2=makeGaugeCard('m2','üöó','Windows-Down Drive','Open-air cruising comfort.',['Windows up','Borderline','Fun','Breezy bliss']); wrap.appendChild(c2);
  setGauge('m2',s2,'Road-feel with windows down.',[R.t(curr.temp),R.dp(curr.dewpoint),R.pop(maxPop)]);

  // Run Outside
  let s3=100; if(curr.temp<40) s3-=(40-curr.temp)*2.5; if(curr.temp>78) s3-=(curr.temp-78)*3; if(curr.dewpoint>65) s3-=(curr.dewpoint-65)*2.5; if(maxWind>20) s3-=(maxWind-20)*3; s3-=maxPop*1.0; s3=clamp(s3,0,100);
  const c3=makeGaugeCard('m3','üèÉ','Run Outside','Temp, humidity, wind & rain risk.',['Sluggish','Decent','Good','PR day']); wrap.appendChild(c3);
  setGauge('m3',s3,'Running comfort for the next few hours.',[R.t(curr.temp),R.dp(curr.dewpoint),R.wind(maxWind),R.pop(maxPop)]);

  // Clothes Comfort (CHANGED: humidity + wind penalties)
  let s4=100;
  if(curr.temp<60) s4-=(60-curr.temp)*1.2;
  if(curr.temp>80) s4-=(curr.temp-80)*1.5;
  if(curr.dewpoint>62) s4-=(curr.dewpoint-62)*2.0;     /* changed */
  if(maxWind>18) s4-=(maxWind-18)*1.5;                 /* changed */
  s4=clamp(s4,0,100);
  const wear=suggestClothes(curr.temp); const c4=makeGaugeCard('m4','üëï','Clothes Comfort',wear,['Bundled','Layered','Light','T-shirt']); wrap.appendChild(c4);
  setGauge('m4',s4, wear, [R.t(curr.temp),R.dp(curr.dewpoint),R.wind(maxWind)]);
}

/* ========= Local panel ========= */
async function updateLocal(){
  const d=await weather.get(userLocation.lat,userLocation.lon);
  document.getElementById('temp').textContent=`${d.temp}¬∞`;
  document.getElementById('dewpoint').textContent=`${d.dewpoint}¬∞`;
  document.getElementById('wetbulb').textContent=`${wetBulb(d.temp,d.humidity)}¬∞`;
  document.getElementById('vpd').textContent=`${vpd(d.temp,d.humidity)}`;
  document.getElementById('spread').textContent=`${d.temp-d.dewpoint}¬∞`;
  document.getElementById('pressure').textContent=`${d.pressure}`;
  const age=Math.max(0,Math.round((Date.now()-d.timestamp)/60000));
  document.getElementById('dataAge').textContent=`Data: ${age} min old (${d.source})`;

  const dv=vpd(d.temp,d.humidity);
  const spread=d.temp-d.dewpoint;
  const moist=spread<5?'‚ö†Ô∏è Near saturation ‚Äî fog/mist likely'
              :spread<10?'Very humid ‚Äî condensation risk'
              :spread<20?'Comfortable moisture'
              :'Dry air ‚Äî static likely';
  document.getElementById('moistureInsight').innerHTML=
    `<strong>Moisture Status:</strong> ${moist}<br><strong>VPD ${dv} kPa:</strong> ${dv<0.5?'Air is saturated':dv>2?'Air is very thirsty':'Moderate'}`;

  let fc=await weather.hourly(userLocation.lat,userLocation.lon);
  const biasRaw=(fc.omCurrentDp!=null && Number.isFinite(d.dewpoint))?(d.dewpoint-fc.omCurrentDp):0;
  const bias=clamp(biasRaw,-8,8);
  const corrected=fc.hours.map((h,i)=>({...h, dp: Math.round(clamp(h.dp + (i<18?1:(i<48?0.6:0.3))*bias, -40, 85))}));

  const tl=document.getElementById('dewTimeline'); tl.innerHTML='';
  const now=new Date();
  const next12=corrected.filter(h=>new Date(h.time)>now).slice(0,12);
  (next12.length?next12:corrected.slice(0,12)).forEach(h=>{
    const el=document.createElement('div'); el.className='bucket';
    el.innerHTML=`<strong>${fmtTime(h.time)}</strong><div class="tval">${h.dp}¬∞</div><div class="mini">${h.pop??0}% rain ‚Ä¢ ${h.wind} mph</div>`;
    tl.appendChild(el);
  });

  const tz=fc.tz||'UTC'; const startKey=todayKeyInTz(tz);
  const groups=new Map();
  corrected.forEach(h=>{ const k=dateKeyInTz(h.time,tz); if(k>=startKey){ if(!groups.has(k)) groups.set(k,[]); groups.get(k).push(h); }});
  const dayKeys=[...groups.keys()].sort();
  const days=document.getElementById('dewDays'); days.innerHTML='';
  dayKeys.slice(0,5).forEach(k=>{
    const arr=groups.get(k)||[]; if(!arr.length) return;
    const min=Math.min(...arr.map(x=>x.dp)), max=Math.max(...arr.map(x=>x.dp));
    const el=document.createElement('div'); el.className='bucket';
    el.innerHTML=`<strong>${new Date(k+'T12:00:00').toLocaleDateString('en-US',{weekday:'short',timeZone:tz})}</strong><div class="tval">${min}¬∞ ‚Äì ${max}¬∞</div><div class="mini">min / max dew</div>`;
    days.appendChild(el);
  });

  const fireEl=document.getElementById('fireDays'); fireEl.innerHTML='';
  dayKeys.forEach(k=>{
    const arr=(groups.get(k)||[]).filter(h=>{
      const hr=new Date(h.time).toLocaleString('en-US',{hour:'2-digit',hour12:false,timeZone:tz});
      const H=parseInt(hr,10); return H>=18 && H<=23;
    });
    if(!arr.length) return;

    const avgDew=Math.round(arr.reduce((a,b)=>a+b.dp,0)/arr.length);
    const avgTemp=Math.round(arr.reduce((a,b)=>a+b.temp,0)/arr.length);
    const maxWind=Math.max(...arr.map(h=>h.wind));
    const maxPop=Math.max(...arr.map(h=>h.pop??0));
    const avgClouds=Math.round(arr.reduce((a,b)=>a+(Number.isFinite(b.clouds)?b.clouds:50),0)/arr.length);

    let score=100;
    if(avgDew<35) score-= (35-avgDew)*2.5;
    if(avgDew>55) score-= (avgDew-55)*2.5;
    if(maxWind>10) score-= (maxWind-10)*3;
    if(maxWind>20) score=0;
    score-= maxPop*0.8;
    if(avgClouds>30) score-= (avgClouds-30)*0.5;
    if(avgTemp<55) score-= (55-avgTemp);
    if(avgTemp>75) score-= (avgTemp-75)*0.5;
    score=Math.max(0,Math.min(100,score));

    let rating='',color='';
    if(score>=80){rating='üî•üî•üî•';color='#10b981';}
    else if(score>=60){rating='üî•üî•';color='#f59e0b';}
    else if(score>=40){rating='üî•';color:'#64748b';}
    else {rating='‚ùå';color:'#dc2626';}

    const el=document.createElement('div');
    el.className='bucket'; el.style.minWidth='110px';
    el.innerHTML=`<strong>${new Date(k+'T12:00:00').toLocaleDateString('en-US',{weekday:'short', timeZone: tz})}</strong>
      <div style="font-size:1.5rem">${rating}</div>
      <div class="mini" style="color:${color}">${Math.round(score)}% ideal</div>
      <div class="mini" style="font-size:.6rem">${avgTemp}¬∞F ‚Ä¢ ${maxWind}mph<br>${maxPop}% rain ‚Ä¢ ${avgClouds}% clouds</div>`;
    fireEl.appendChild(el);
  });

  const tonightKey=dayKeys[0];
  if(tonightKey){
    const arr=(groups.get(tonightKey)||[]).filter(h=>{
      const hr=new Date(h.time).toLocaleString('en-US',{hour:'2-digit',hour12:false,timeZone:tz}); const H=parseInt(hr,10); return H>=18&&H<=23;
    });
    if(arr.length){
      const avgDP=Math.round(arr.reduce((a,b)=>a+b.dp,0)/arr.length);
      const maxWind=Math.max(...arr.map(h=>h.wind)), maxPop=Math.max(...arr.map(h=>h.pop??0));
      const good=(avgDP>=35&&avgDP<=55)&&maxWind<=12&&maxPop<25;
      document.getElementById('firepitHint').innerHTML= good
        ? `üî• <strong>Good fire-pit tonight:</strong> avg dew ${avgDP}¬∞, wind ‚â§${maxWind} mph, precip ‚â§${maxPop}%`
        : `ü™µ <strong>Meh for fire-pit:</strong> avg dew ${avgDP}¬∞, wind up to ${maxWind} mph, precip up to ${maxPop}%`;
    }else document.getElementById('firepitHint').textContent='Fire-pit check: evening data not available yet.';
  }

  renderOutcomeMeters(d, corrected.slice(0,6));
}

/* ========= Maps ========= */
function initMaps(){
  // Local map + global marker (so Set updates the pin)
  maps.local=L.map('localMap').setView([userLocation.lat,userLocation.lon],9);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap'}).addTo(maps.local);
  maps.localMarker = L.marker([userLocation.lat,userLocation.lon]).addTo(maps.local);
  maps.local.on('click',async e=>{
    userLocation={lat:e.latlng.lat,lon:e.latlng.lng};
    maps.localMarker.setLatLng(e.latlng);
    document.getElementById('locationInput').value=`${userLocation.lat.toFixed(4)}, ${userLocation.lon.toFixed(4)}`;
    await updateLocal();
  });

  // Radar map
  maps.radar=L.map('radarMap',{zoomControl:true}).setView([userLocation.lat,userLocation.lon],7);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap'}).addTo(maps.radar);

  drawLayer=L.layerGroup().addTo(maps.radar);
}

/* ========= RainViewer animation ========= */
let rv={frames:[], layers:[], index:0, timer:null, speed:600, pastCount:0};
async function loadRadarFrames(){
  try{
    const data=await fetchJSON('https://api.rainviewer.com/public/weather-maps.json',9000);
    const past=(data.radar?.past||[]).slice(-8);
    const future=(data.radar?.nowcast||[]).slice(0,12);
    rv.frames=[...past, ...future];
    rv.pastCount=past.length;

    rv.layers.forEach(l=>maps.radar.removeLayer(l));
    rv.layers = rv.frames.map(f=>{
      const url=`https://tilecache.rainviewer.com/v2/radar/${f.path}/256/{z}/{x}/{y}/2/1_1.png`;
      return L.tileLayer(url,{opacity:0,zIndex:3});
    });
    rv.layers.forEach(l=>l.addTo(maps.radar));

    const slider=document.getElementById('rv-slider');
    slider.max=String(rv.frames.length-1);
    slider.value=String(rv.pastCount-1);
    rv.index=rv.pastCount-1;
    updateRadarTime();
    showFrame(rv.index);
  }catch{
    document.getElementById('radarTime').textContent='Radar: unavailable';
  }
}
function showFrame(i){
  rv.layers.forEach((l,idx)=>l.setOpacity(idx===i?0.88:0));
  rv.index=i;
  document.getElementById('rv-slider').value=String(i);
  updateRadarTime();
}
function updateRadarTime(){
  const f=rv.frames[rv.index]; if(!f){ document.getElementById('radarTime').textContent='Radar: ‚Äî'; return; }
  const ts=new Date(f.time*1000);
  const kind = rv.index < rv.pastCount ? 'past' : 'forecast';
  document.getElementById('radarTime').textContent=`Radar: ${ts.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})} (${kind})`;
}
function play(){
  if(rv.timer) return;
  document.getElementById('rv-play').textContent='‚è∏ Pause';
  rv.timer=setInterval(()=>{ nextFrame(); }, rv.speed);
}
function pause(){
  if(rv.timer){ clearInterval(rv.timer); rv.timer=null; }
  document.getElementById('rv-play').textContent='‚ñ∂Ô∏é Play';
}
function nextFrame(){ showFrame( (rv.index+1) % rv.frames.length ); }
function prevFrame(){ showFrame( (rv.index-1+rv.frames.length) % rv.frames.length ); }

/* ========= Telestrator (with Hand tool) ========= */
let tool='pen', drawColor='#111827', drawWidth=4;
function setActiveTool(id){
  document.querySelectorAll('.toolbtn').forEach(b=>b.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}
function startDraw(e){
  if(!maps.radar) return;
  // Disable map interactions while drawing
  maps.radar.dragging.disable();
  maps.radar.doubleClickZoom.disable();
  maps.radar.scrollWheelZoom.disable();
  maps.radar.boxZoom.disable();
  maps.radar.keyboard.disable();

  const ll=e.latlng; drawState={tool, color:drawColor, width:drawWidth, points:[ll]};
  if(tool==='pen'){ drawState.shape=L.polyline([ll],{color:drawColor,weight:drawWidth,opacity:1}).addTo(drawLayer); }
  else if(tool==='rect'){ drawState.shape=L.rectangle([ll,ll],{color:drawColor,weight:drawWidth,fill:false}).addTo(drawLayer); }
  else if(tool==='circle'){ drawState.shape=L.circle(ll,{color:drawColor,weight:drawWidth,fill:false,radius:1}).addTo(drawLayer); }
  else if(tool==='arrow'){ drawState.shape=L.polyline([ll,ll],{color:drawColor,weight:drawWidth}).addTo(drawLayer); }
}
function moveDraw(e){
  if(!drawState) return;
  const ll=e.latlng; const pts=drawState.points; pts.push(ll);
  if(tool==='pen'){ drawState.shape.setLatLngs(pts); }
  else if(tool==='rect'){ drawState.shape.setBounds(L.latLngBounds(pts[0],ll)); }
  else if(tool==='circle'){ const r=maps.radar.distance(pts[0],ll); drawState.shape.setRadius(r); }
  else if(tool==='arrow'){ drawState.shape.setLatLngs([pts[0],ll]); }
}
function endDraw(e){
  if(!drawState){
    // ensure interactions are enabled
    maps.radar.dragging.enable();
    maps.radar.doubleClickZoom.enable();
    maps.radar.scrollWheelZoom.enable();
    maps.radar.boxZoom.enable();
    maps.radar.keyboard.enable();
    return;
  }
  const ll=e.latlng; const pts=drawState.points; pts.push(ll);

  if(tool==='text'){
    const txt=prompt('Label text:'); if(txt){ const m=L.marker(ll,{icon:L.divIcon({className:'',html:`<div style="font-weight:700;color:${drawColor};text-shadow:0 1px 2px #fff">${txt}</div>`})}).addTo(drawLayer); shapes.push(m); }
  }else if(tool==='arrow'){
    const a=maps.radar.latLngToLayerPoint(pts[pts.length-2]), b=maps.radar.latLngToLayerPoint(pts[pts.length-1]);
    const angle=Math.atan2(b.y-a.y,b.x-a.x)*180/Math.PI;
    const head=L.marker(pts[pts.length-1],{icon:L.divIcon({className:'',html:`<div class="arrowhead" style="transform:rotate(${angle}deg);color:${drawColor}">‚û§</div>`}),interactive:false});
    head.addTo(drawLayer); shapes.push(head); shapes.push(drawState.shape);
  }else{ shapes.push(drawState.shape); }

  drawState=null;
  // Re-enable interactions after drawing
  maps.radar.dragging.enable();
  maps.radar.doubleClickZoom.enable();
  maps.radar.scrollWheelZoom.enable();
  maps.radar.boxZoom.enable();
  maps.radar.keyboard.enable();
}
function bindTelestrator(){
  document.getElementById('tool-pen').onclick=()=>{ tool='pen'; setActiveTool('tool-pen'); };
  document.getElementById('tool-hand').onclick=()=>{ tool='hand'; setActiveTool('tool-hand');
    // Fully enable map interactions in hand mode
    maps.radar.dragging.enable();
    maps.radar.doubleClickZoom.enable();
    maps.radar.scrollWheelZoom.enable();
    maps.radar.boxZoom.enable();
    maps.radar.keyboard.enable();
  };
  document.getElementById('tool-arrow').onclick=()=>{ tool='arrow'; setActiveTool('tool-arrow'); };
  document.getElementById('tool-rect').onclick=()=>{ tool='rect'; setActiveTool('tool-rect'); };
  document.getElementById('tool-circle').onclick=()=>{ tool='circle'; setActiveTool('tool-circle'); };
  document.getElementById('tool-text').onclick=()=>{ tool='text'; setActiveTool('tool-text'); };
  document.getElementById('penWidth').oninput=(e)=>{ drawWidth=parseInt(e.target.value,10)||4; };
  document.querySelectorAll('.colorchip').forEach(c=>c.onclick=()=>{ drawColor=c.dataset.color; });
  document.getElementById('tool-undo').onclick=()=>{ const last=shapes.pop(); if(last){ drawLayer.removeLayer(last);} };
  document.getElementById('tool-clear').onclick=()=>{ drawLayer.clearLayers(); shapes=[]; };

  // Skip drawing in hand mode; let Leaflet pan/zoom normally
  maps.radar.on('mousedown', e => {
    if(tool==='hand') return; // pan/zoom only
    if(tool!=='text') startDraw(e); else { startDraw(e); endDraw(e); }
  });
  maps.radar.on('mousemove', moveDraw);
  maps.radar.on('mouseup', endDraw);
  maps.radar.on('mouseleave', () => {
    if(drawState){
      drawState=null;
      maps.radar.dragging.enable();
      maps.radar.doubleClickZoom.enable();
      maps.radar.scrollWheelZoom.enable();
      maps.radar.boxZoom.enable();
      maps.radar.keyboard.enable();
    }
  });
}

/* ========= Animation controls wiring ========= */
function bindRadarControls(){
  const playBtn=document.getElementById('rv-play');
  document.getElementById('rv-prev').onclick=()=>{ pause(); prevFrame(); };
  document.getElementById('rv-next').onclick=()=>{ pause(); nextFrame(); };
  playBtn.onclick=()=>{ if(rv.timer) pause(); else play(); };
  document.getElementById('rv-speed').onchange=(e)=>{ rv.speed=parseInt(e.target.value,10)||600; if(rv.timer){ pause(); play(); } };
  document.getElementById('rv-slider').oninput=(e)=>{ pause(); showFrame(parseInt(e.target.value,10)||0); };
}

/* ========= Tabs / location ========= */
window.switchTab=function(evt, tab){
  document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
  evt.target.classList.add('active');
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.getElementById(tab).classList.add('active');
  setTimeout(()=>{ if(maps[tab]) maps[tab].invalidateSize(); }, 80);
  if(tab==='radar'){ loadRadarFrames(); }
};
window.setLocation=async function(){
  const input=document.getElementById('locationInput').value; const parts=input.split(',').map(s=>parseFloat(s.trim()));
  if(parts.length===2 && !isNaN(parts[0]) && !isNaN(parts[1])){
    userLocation={lat:parts[0],lon:parts[1]};
    // update map views
    maps.local.setView([userLocation.lat,userLocation.lon],9);
    if (maps.localMarker) maps.localMarker.setLatLng([userLocation.lat,userLocation.lon]); // keep pin in sync
    maps.radar.setView([userLocation.lat,userLocation.lon],7);
    await updateLocal(); await loadRadarFrames();
  }else alert('Enter as: latitude, longitude');
};

/* ========= Init ========= */
window.addEventListener('DOMContentLoaded', async ()=>{
  initMaps();
  bindTelestrator();
  bindRadarControls();
  document.getElementById('locationInput').value = `${userLocation.lat.toFixed(4)}, ${userLocation.lon.toFixed(4)}`;
  await updateLocal();
  await loadRadarFrames();
});
</script>
</body>
</html>
