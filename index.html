<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dummy - Weather Where You Want It</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --dummy-red:#dc2626;
      --bg:#f3f4f6;
      --text:#0f172a;
      --muted:#6b7280;

      /* added color pops */
      --teal:#14b8a6;
      --amber:#f59e0b;
      --blue:#3b82f6;
      --emerald:#10b981;

      --card:#ffffff;
      --shadow:0 8px 30px rgba(0,0,0,.08);
      --ring: 0 0 0 3px rgba(220,38,38,.15);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Inter,system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);line-height:1.6}

    /* Header */
    header{
      background: radial-gradient(1200px 300px at 15% -20%, rgba(59,130,246,.15), transparent 60%),
                  radial-gradient(800px 300px at 85% -40%, rgba(20,184,166,.15), transparent 60%),
                  var(--card);
      padding:1.25rem 2rem;border-bottom:3px solid var(--dummy-red);box-shadow:var(--shadow);position:sticky;top:0;z-index:5
    }
    .header-content{display:flex;justify-content:space-between;align-items:center;gap:1rem}
    .brand{display:flex;align-items:center;gap:.75rem}
    .brand img{width:44px;height:62px;object-fit:contain;filter:drop-shadow(0 6px 16px rgba(0,0,0,.2))}
    h1{font-weight:900;letter-spacing:-.02em;color:var(--dummy-red)}

    .location-display{display:flex;align-items:center;gap:.5rem;background:linear-gradient(90deg,#eef2ff,#ecfeff);padding:.5rem 1rem;border-radius:999px;font-size:.9rem;color:#334155;border:1px solid #e2e8f0}
    .location-display .dot{width:10px;height:10px;background:var(--dummy-red);border-radius:50%;animation:pulse 2s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}

    /* Tabs */
    .tabs{display:flex;gap:6px;padding:.75rem 1rem;background:var(--card);box-shadow:var(--shadow);position:sticky;top:84px;z-index:4}
    .tab{padding:.7rem 1.1rem;border:0;border-radius:999px;background:#eef2ff;color:#1e293b;font-weight:800;letter-spacing:.05em;text-transform:uppercase;font-size:.78rem;cursor:pointer;transition:.2s}
    .tab:hover{transform:translateY(-2px)}
    .tab.active{background:#ffdfe0;color:#7f1d1d;box-shadow:var(--ring)}

    /* Layout */
    .content{max-width:1200px;margin:0 auto;padding:1.25rem}
    .section{display:none;animation:fade .25s ease}
    .section.active{display:block}
    @keyframes fade{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}

    .card{background:var(--card);border-radius:18px;padding:1.5rem 1.5rem 1.25rem;box-shadow:var(--shadow);margin:1rem 0}
    .card h2{color:var(--dummy-red);margin-bottom:.25rem}
    .sub{color:var(--muted);margin-bottom:1rem}

    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(170px,1fr));gap:.85rem}
    .pill{background:#f8fafc;border:1px solid #e2e8f0;border-radius:14px;padding:1rem;text-align:center}
    .metric{font-size:2.15rem;font-weight:900}
    .label{font-size:.72rem;color:var(--muted);letter-spacing:.08em;text-transform:uppercase}

    .dew-explain{margin-top:.5rem;font-size:.85rem;color:#475569;background:linear-gradient(90deg,#ecfeff,transparent);border-left:4px solid var(--teal);padding:.5rem .75rem;border-radius:10px}

    .timeline{display:flex;gap:.6rem;overflow:auto;padding:.5rem 0}
    .bucket{min-width:128px;background:#f1f5f9;border:1px solid #e2e8f0;border-radius:12px;padding:.75rem;text-align:center}
    .bucket strong{display:block;font-size:.95rem}
    .bucket .tval{font-size:1.6rem;font-weight:900;color:var(--dummy-red)}
    .badge{display:inline-block;margin-top:.25rem;padding:.15rem .5rem;border-radius:999px;font-size:.72rem;background:#fff;border:1px solid #e2e8f0}

    .map-container{height:520px;border-radius:16px;overflow:hidden;border:2px solid #e2e8f0;margin-top:1rem}

    .season-controls{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:.75rem;margin:1rem 0}
    .season-btn{padding:1rem;border:2px solid #e2e8f0;background:#fff;border-radius:14px;font-weight:800;cursor:pointer;transition:.15s;text-align:center}
    .season-btn:hover{transform:translateY(-2px)}
    .season-btn.active{background:linear-gradient(180deg,#ffe4e6,#fff);border-color:#fecaca;color:#7f1d1d}
    .season-btn .icon{font-size:1.6rem;display:block;margin-bottom:.35rem}

    .legend{display:flex;gap:1rem;flex-wrap:wrap;margin:.5rem 0 1rem}
    .legend-item{display:flex;align-items:center;gap:.5rem}
    .dot{width:16px;height:16px;border-radius:50%;border:2px solid #fff;box-shadow:0 2px 8px rgba(0,0,0,.15)}

    .arbitrage{display:grid;grid-template-columns:1fr auto 1fr;gap:1rem;align-items:center}
    .locard{background:#f8fafc;border:1px solid #e2e8f0;border-radius:14px;padding:1.25rem;text-align:center}
    .locard h3{color:var(--blue)}
    .temp{font-size:2.6rem;font-weight:900;margin:.25rem 0}
    .vs{font-weight:900;color:var(--dummy-red)}
    .spin{margin-top:.75rem;padding:1rem 1.75rem;border:0;border-radius:999px;background:linear-gradient(90deg,#ef4444,#f97316);color:#fff;font-weight:900;letter-spacing:.05em;cursor:pointer;box-shadow:0 12px 30px rgba(239,68,68,.25);transition:.15s}
    .spin:hover{transform:scale(1.03)}
    .result{margin-top:1rem;background:#f1f5f9;border:1px solid #e2e8f0;border-radius:12px;padding:1rem;text-align:center;font-weight:700}

    .loading{display:inline-block;width:20px;height:20px;border:3px solid #e5e7eb;border-top-color:var(--dummy-red);border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* --- Goldilocks Hot List --- */
    .hotlist{
      display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
      gap:.6rem;margin-top:.6rem
    }
    .hotcard{
      background:#f8fafc;border:1px solid #e2e8f0;border-radius:12px;
      padding:.75rem .9rem;display:flex;justify-content:space-between;align-items:center
    }
    .hotcard .meta{font-size:.9rem;color:#475569}

    /* Canvas overlay fix */
    .dummy-temp-surface{
      position:absolute;
      top:0;
      left:0;
      pointer-events:none;
      z-index:400;
      image-rendering:auto;
    }

    @media(max-width:768px){
      .tabs{top:76px}
      .arbitrage{grid-template-columns:1fr}
      .content{padding:1rem}
      h1{font-size:1.6rem}
    }
  </style>
</head>
<body>
<header>
  <div class="header-content">
    <div class="brand">
      <!-- Add dummy_logo.png to your repo root -->
      <img src="dummy_logo.png" alt="Dummy logo" />
      <h1>DUMMY</h1>
    </div>
    <div class="location-display">
      <div class="dot"></div>
      <span id="locationText">Finding you...</span>
    </div>
  </div>
</header>

<nav class="tabs">
  <button class="tab active" onclick="switchTab(event,'hyperlocal')">Hyperlocal</button>
  <button class="tab" onclick="switchTab(event,'chase')">Chase Season</button>
  <button class="tab" onclick="switchTab(event,'goldilocks')">Goldilocks</button>
  <button class="tab" onclick="switchTab(event,'arbitrage')">Arbitrage</button>
</nav>

<div class="content">

  <!-- Hyperlocal -->
  <section id="hyperlocal" class="section active">
    <div class="card">
      <h2>Your Exact Weather</h2>
      <p class="sub">Neighborhood-adjusted using elevation + best available station</p>

      <div class="grid">
        <div class="pill">
          <div class="metric" id="temp">--¬∞</div>
          <div class="label">Temperature</div>
        </div>
        <div class="pill">
          <div class="metric" id="feels">--¬∞</div>
          <div class="label">Feels Like</div>
        </div>
        <div class="pill">
          <div class="metric" id="dew">--¬∞</div>
          <div class="label">Dew Point</div>
          <div class="dew-explain" id="dewExplain">
            Dew point is the temp air must cool to for saturation. <strong>~55¬∞F</strong> feels dry, <strong>60‚Äì65¬∞</strong> a bit humid, <strong>70¬∞+</strong> feels tropical.
          </div>
        </div>
        <div class="pill">
          <div class="metric" id="wind">-- mph</div>
          <div class="label">Wind</div>
        </div>
        <div class="pill">
          <div class="metric" id="precipNow">--%</div>
          <div class="label">Precip Chance (Now‚Üí1h)</div>
        </div>
      </div>

      <h3 style="color:var(--dummy-red);margin:.6rem 0 .35rem">Next 6 Hours</h3>
      <div id="timeline" class="timeline"></div>

      <!-- Dew Insights -->
      <div id="dewInsights" style="margin-top:.5rem;background:#f8fafc;border:1px solid #e2e8f0;border-radius:12px;padding:.75rem 1rem;color:#334155"></div>

      <div id="dataSource" class="badge" style="margin-top:.5rem">Source: loading‚Ä¶</div>
    </div>
  </section>

  <!-- Chase Season -->
  <section id="chase" class="section">
    <div class="card">
      <h2>Chase the Season</h2>
      <p class="sub">Scouring the map (including smaller towns) for your vibe right now.</p>

      <div class="season-controls">
        <button class="season-btn active" onclick="showSeason(event,'beach')"><span class="icon">üèñÔ∏è</span>Beach Weather</button>
        <button class="season-btn" onclick="showSeason(event,'sweater')"><span class="icon">üß•</span>Sweater Weather</button>
        <button class="season-btn" onclick="showSeason(event,'snow')"><span class="icon">‚ùÑÔ∏è</span>Snow Day</button>
        <button class="season-btn" onclick="showSeason(event,'firepit')"><span class="icon">üî•</span>Fire Pit Night</button>
      </div>

      <div id="seasonMap" class="map-container"></div>
      <div id="seasonResults" style="margin-top:.5rem"></div>
    </div>
  </section>

  <!-- Goldilocks -->
  <section id="goldilocks" class="section">
    <div class="card">
      <h2>Goldilocks Zones</h2>
      <p class="sub">Just-right pockets (and where it‚Äôs too hot vs. too cold)</p>

      <div class="legend">
        <div class="legend-item"><span class="dot" style="background:var(--emerald)"></span>Perfect 65‚Äì75¬∞</div>
        <div class="legend-item"><span class="dot" style="background:var(--teal)"></span>Balmy 60‚Äì64¬∞ / 76‚Äì80¬∞</div>
        <div class="legend-item"><span class="dot" style="background:var(--amber)"></span>Crisp 50‚Äì59¬∞</div>
        <div class="legend-item"><span class="dot" style="background:#ef4444"></span>Too Hot &gt; 80¬∞</div>
        <div class="legend-item"><span class="dot" style="background:#6366f1"></span>Too Cold &lt; 50¬∞</div>
      </div>

      <!-- Mode toggle -->
      <div style="display:flex;gap:.5rem;flex-wrap:wrap;margin:.25rem 0 .5rem">
        <button class="season-btn active" id="btnSwaths" onclick="setGoldiMode('swaths')">Swaths</button>
        <button class="season-btn" id="btnGradient" onclick="setGoldiMode('gradient')">Gradient</button>
      </div>

      <div id="goldilocksMap" class="map-container"></div>
      <!-- FOMO / enticing ‚Äúgo now‚Äù cards -->
      <div id="goldilocksList" class="hotlist"></div>
    </div>
  </section>

  <!-- Arbitrage -->
  <section id="arbitrage" class="section">
    <div class="card">
      <h2>Weather Arbitrage</h2>
      <p class="sub">Your place vs. a random city ‚Äî but with dew point, wind, and ‚Äúinteresting bits.‚Äù</p>

      <div class="arbitrage">
        <div class="locard">
          <h3>YOU</h3>
          <div class="temp" id="yourTemp">--¬∞</div>
          <div id="yourDP" class="badge">Dew: --¬∞</div>
          <div id="yourX" style="margin-top:.3rem;color:#475569"></div>
        </div>
        <div class="vs">VS</div>
        <div class="locard">
          <h3 id="compareCity">???</h3>
          <div class="temp" id="compareTemp">--¬∞</div>
          <div id="compareDP" class="badge">Dew: --¬∞</div>
          <div id="compareX" style="margin-top:.3rem;color:#475569"></div>
        </div>
      </div>

      <button class="spin" onclick="spinArbitrage()">Spin for New City</button>
      <div id="arbitrageResult" class="result">Click spin to compare your weather!</div>
    </div>
  </section>
</div>

<script type="module">
/* ===================== Utils ===================== */
const fmtTime = (isoOrDate)=>{
  const d = typeof isoOrDate === 'string' ? new Date(isoOrDate) : isoOrDate;
  return d.toLocaleTimeString('en-US',{hour:'numeric'}); // 12-hr like 3 PM
};

function dewFeeling(dp){
  if(dp<50) return 'dry';
  if(dp<56) return 'pleasant';
  if(dp<61) return 'noticeably humid';
  if(dp<66) return 'humid';
  if(dp<71) return 'muggy';
  return 'oppressive';
}

// Magnus formula for dew point (F)
function dewPointF(tempF, rh){
  const T = (tempF - 32) * 5/9;
  const a = 17.625, b = 243.04;
  const gamma = Math.log(rh/100) + (a*T)/(b+T);
  const TdC = (b*gamma)/(a-gamma);
  return Math.round((TdC * 9/5) + 32);
}

/* ========= Color ramp + interpolation helpers (Gradient) ========= */
const RAMP = [
  {t:20,  c:[59,130,246]},   // blue
  {t:40,  c:[99,102,241]},   // indigo
  {t:55,  c:[16,185,129]},   // emerald
  {t:70,  c:[52,211,153]},   // light-teal
  {t:80,  c:[245,158,11]},   // amber
  {t:95,  c:[239,68,68]},    // red
  {t:100, c:[239,68,68]}
];
const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
function lerp(a,b,t){return a+(b-a)*t}
function colorForTemp(tF, alpha=0.55){
  const t = clamp(tF, RAMP[0].t, RAMP[RAMP.length-1].t);
  let i=0; while(i<RAMP.length-1 && !(t>=RAMP[i].t && t<=RAMP[i+1].t)) i++;
  const a=RAMP[i], b=RAMP[i+1];
  const u=(t-a.t)/(b.t-a.t||1);
  const r=Math.round(lerp(a.c[0],b.c[0],u));
  const g=Math.round(lerp(a.c[1],b.c[1],u));
  const bch=Math.round(lerp(a.c[2],b.c[2],u));
  return `rgba(${r},${g},${bch},${alpha})`;
}

/* Fine grid for smoother interpolation */
const FINE_LAT_STEP = 1.5;
const FINE_LON_STEP = 2.0;
function fineGridUSA(){
  const pts=[];
  for(let lat=25; lat<=49; lat+=FINE_LAT_STEP){
    for(let lon=-124; lon<=-67; lon+=FINE_LON_STEP){
      pts.push({lat:+lat.toFixed(2), lon:+lon.toFixed(2)});
    }
  }
  return pts;
}

/* Quick & light IDW */
function idwTemp(lat, lon, points, k=8, power=2){
  const arr = points.map(p=>{
    const dlat = lat - p.lat, dlon = lon - p.lon;
    const d = Math.hypot(dlat, dlon);
    return {d:d||1e-6, t:p.temp};
  }).sort((a,b)=>a.d-b.d).slice(0,k);

  let wSum=0, tSum=0;
  for(const n of arr){
    const w = 1/Math.pow(n.d,power);
    wSum += w; tSum += w*n.t;
  }
  return tSum/(wSum||1);
}

/* ================== Weather Service ================== */
class DummyWeather {
  constructor(){
    this.cache = new Map();
    this.CACHE_DURATION = 5*60*1000;
  }

  async getWeather(lat, lon){
    const key = `${lat.toFixed(2)},${lon.toFixed(2)}`;
    if(this.cache.has(key)){
      const c = this.cache.get(key);
      if(Date.now()-c.time < this.CACHE_DURATION) return c.data;
    }

    // Try NOAA for CONUS
    if(lat>24 && lat<50 && lon>-125 && lon<-66){
      try{
        const p = await fetch(`https://api.weather.gov/points/${lat.toFixed(4)},${lon.toFixed(4)}`,{headers:{'User-Agent':'dummy.app (github pages)'}});
        if(p.ok){
          const pd = await p.json();
          const hourlyUrl = pd.properties.forecastHourly;
          const hr = await fetch(hourlyUrl,{headers:{'User-Agent':'dummy.app (github pages)'}});
          if(hr.ok){
            const fc = await hr.json();
            const now = fc.properties.periods[0];
            const hours = fc.properties.periods.slice(0,6);

            const rh = (now.relativeHumidity && now.relativeHumidity.value!=null) ? now.relativeHumidity.value : 50;
            const dewGuess = (now.dewpoint && now.dewpoint.value!=null)
              ? Math.round((now.dewpoint.value * 9/5) + 32) // C -> F
              : dewPointF(now.temperature, rh);

            const data = {
              temp: now.temperature,
              feelsLike: now.temperature,
              humidity: rh,
              dew: dewGuess,
              windSpeed: parseInt(now.windSpeed)||0,
              windGust: now.windGust ? parseInt(now.windGust) : null,
              precipProbNow: (now.probabilityOfPrecipitation && now.probabilityOfPrecipitation.value!=null) ? now.probabilityOfPrecipitation.value : null,
              description: now.shortForecast,
              hourly: hours.map(h=>{
                const hrh = h.relativeHumidity?.value ?? rh;
                const hdew = (h.dewpoint && h.dewpoint.value!=null)
                  ? Math.round((h.dewpoint.value * 9/5) + 32)
                  : dewPointF(h.temperature, hrh);
                return {
                  time:h.startTime,
                  temp:h.temperature,
                  wind: parseInt(h.windSpeed)||0,
                  pop: (h.probabilityOfPrecipitation && h.probabilityOfPrecipitation.value!=null) ? h.probabilityOfPrecipitation.value : null,
                  desc:h.shortForecast,
                  dew: hdew
                };
              }),
              source:'NOAA'
            };
            this.cache.set(key,{data,time:Date.now()});
            return data;
          }
        }
      }catch(e){ /* fall through */ }
    }

    // Open-Meteo fallback (worldwide)
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,apparent_temperature,relative_humidity_2m,dew_point_2m,precipitation,precipitation_probability,wind_speed_10m&hourly=temperature_2m,precipitation_probability,precipitation,wind_speed_10m,dew_point_2m,weather_code&temperature_unit=fahrenheit&wind_speed_unit=mph&timezone=auto`;
    const r = await fetch(url);
    const j = await r.json();

    const rh = j.current.relative_humidity_2m;
    const dew = (j.current.dew_point_2m!=null) ? Math.round(j.current.dew_point_2m) : dewPointF(j.current.temperature_2m, rh);

    const data = {
      temp: Math.round(j.current.temperature_2m),
      feelsLike: Math.round(j.current.apparent_temperature),
      humidity: rh,
      dew: dew,
      windSpeed: Math.round(j.current.wind_speed_10m||0),
      windGust: null,
      precipProbNow: j.current.precipitation_probability ?? null,
      description: null,
      hourly: j.hourly.time.slice(0,6).map((t,i)=>({
        time:t,
        temp: Math.round(j.hourly.temperature_2m[i]),
        wind: Math.round(j.hourly.wind_speed_10m[i]||0),
        pop: j.hourly.precipitation_probability?.[i] ?? null,
        desc: null,
        dew: Math.round(j.hourly.dew_point_2m?.[i] ?? dewPointF(j.hourly.temperature_2m[i], rh))
      })),
      source:'Open-Meteo'
    };
    this.cache.set(key,{data,time:Date.now()});
    return data;
  }

  // ===== Hyperlocal (elevation adjust) =====
  async getHyperlocalWeather(lat, lon){
    const base = await this.getWeather(lat, lon);
    const elevationFt = await this.getElevation(lat, lon);
    const elevationAdjust = ((elevationFt - 0) / 1000) * -5.4;
    const adjustedTemp = Math.round(base.temp + elevationAdjust);
    return {...base, temp: adjustedTemp, precision:'Neighborhood-adjusted'};
  }

  async getElevation(lat, lon){
    const resp = await fetch(`https://api.open-elevation.com/api/v1/lookup?locations=${lat},${lon}`);
    const data = await resp.json();
    return (data.results?.[0]?.elevation ?? 0) * 3.28084; // meters ‚Üí feet
  }
}

/* ================== App State ================== */
const weather = new DummyWeather();
let userLocation=null, currentTab='hyperlocal', seasonMap=null, goldilocksMap=null;

/* ============== Geocoding helpers with cache ============== */
const geocodeCache=new Map();
const cacheKey=(lat,lon)=>`${lat.toFixed(2)},${lon.toFixed(2)}`;

async function reverseTown(lat, lon){
  const key=cacheKey(lat,lon);
  if(geocodeCache.has(key)) return geocodeCache.get(key);
  try{
    const r=await fetch(`https://geocoding-api.open-meteo.com/v1/reverse?latitude=${lat}&longitude=${lon}&count=1&language=en`);
    if(r.ok){
      const j=await r.json();
      const g=j.results?.[0];
      if(g){
        const name=[g.name,g.admin1].filter(Boolean).join(', ');
        geocodeCache.set(key,name); return name;
      }
    }
  }catch{}
  try{
    const r=await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`);
    const j=await r.json();
    const name=j.address?.town||j.address?.city||j.address?.village||j.address?.county||key;
    geocodeCache.set(key,name); return name;
  }catch{ return key; }
}

/* ============== Geolocation & place label ============== */
async function getUserLocation(){
  return new Promise(resolve=>{
    if(navigator.geolocation){
      navigator.geolocation.getCurrentPosition(async pos=>{
        userLocation={lat:pos.coords.latitude,lon:pos.coords.longitude};
        try{
          const r=await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${userLocation.lat}&lon=${userLocation.lon}&format=json`);
          const j=await r.json();
          const place=j.address?.city||j.address?.town||j.address?.village||'Your Location';
          document.getElementById('locationText').textContent=place;
        }catch{document.getElementById('locationText').textContent=`${userLocation.lat.toFixed(2)}¬∞, ${userLocation.lon.toFixed(2)}¬∞`}
        resolve(userLocation);
      }, async ()=>{
        try{
          const r=await fetch('https://ipapi.co/json/');
          const j=await r.json();
          userLocation={lat:j.latitude,lon:j.longitude};
          document.getElementById('locationText').textContent=`${j.city}, ${j.region}`;
        }catch{
          userLocation={lat:40.7128,lon:-74.0060};
          document.getElementById('locationText').textContent='New York, NY';
        }
        resolve(userLocation);
      });
    }else{
      userLocation={lat:40.7128,lon:-74.0060};
      document.getElementById('locationText').textContent='New York, NY';
      resolve(userLocation);
    }
  });
}

/* ================== Hyperlocal panel ================== */
async function updateHyperlocal(){
  if(!userLocation) return;
  const data = await weather.getHyperlocalWeather(userLocation.lat, userLocation.lon);

  const nowDew = data.dew ?? dewPointF(data.temp, data.humidity);
  document.getElementById('temp').textContent = `${data.temp}¬∞`;
  document.getElementById('feels').textContent = `${data.feelsLike}¬∞`;
  document.getElementById('dew').textContent = `${nowDew}¬∞`;
  document.getElementById('wind').textContent = `${data.windSpeed} mph`;
  document.getElementById('precipNow').textContent = (data.precipProbNow!=null ? data.precipProbNow : '‚Äî') + (data.precipProbNow!=null ? '%' : '');

  // Dynamic dew explainer
  const feel = dewFeeling(nowDew);
  document.getElementById('dewExplain').innerHTML =
    `Dew point is the temp air must cool to for saturation. Today feels <strong>${feel}</strong> at <strong>${nowDew}¬∞</strong>. 
     Quick guide: <strong>~55¬∞</strong> dry ‚Ä¢ <strong>60‚Äì65¬∞</strong> a bit humid ‚Ä¢ <strong>70¬∞+</strong> tropical.`;

  document.getElementById('dataSource').textContent = `Source: ${data.source} ‚Ä¢ ${data.precision||'Best-available'}`;

  // Timeline with dew, wind, precip
  const tl = document.getElementById('timeline'); tl.innerHTML='';
  (data.hourly||[]).forEach(h=>{
    const el=document.createElement('div');
    el.className='bucket';
    const dp = h.dew ?? dewPointF(h.temp, data.humidity);
    el.innerHTML = `
      <strong>${fmtTime(h.time)}</strong>
      <div class="tval">${h.temp}¬∞</div>
      <div class="badge">Dew ${dp}¬∞</div>
      <div class="badge">Wind ${h.wind ?? 0} mph</div>
      ${h.pop!=null ? `<div class="badge">${h.pop}% precip</div>`:''}
    `;
    tl.appendChild(el);
  });

  // Dew insights summary (trend + worst hour + rain note)
  if(data.hourly && data.hourly.length){
    const dps = data.hourly.map(h=> h.dew ?? dewPointF(h.temp, data.humidity));
    const trend = dps[dps.length-1] - dps[0];
    const maxDP = Math.max(...dps);
    const maxIdx = dps.indexOf(maxDP);
    const maxTime = fmtTime(data.hourly[maxIdx].time);
    const rainHour = data.hourly.find(h=> (h.pop??0) >= 50);
    const rainNote = rainHour ? `Rain likely around <strong>${fmtTime(rainHour.time)}</strong> (~${rainHour.pop}%).` : `Low rain risk next 6h.`;

    document.getElementById('dewInsights').innerHTML =
      `Dew point ${trend>0 ? 'rising' : (trend<0 ? 'falling' : 'steady')} ${Math.abs(trend)}¬∞ through the next 6 hours. 
       Muggiest hour peaks near <strong>${maxTime}</strong> (~<strong>${maxDP}¬∞</strong>, ${dewFeeling(maxDP)}). ${rainNote}`;
  }else{
    document.getElementById('dewInsights').textContent = '';
  }
}

/* ================== Chase Season ================== */
function gridPointsUSA(){
  const pts=[];
  const latStart=25, latEnd=49, lonStart=-124, lonEnd=-67;
  const latStep=3, lonStep=3.5;
  for(let lat=latStart; lat<=latEnd; lat+=latStep){
    for(let lon=lonStart; lon<=lonEnd; lon+=lonStep){
      pts.push({lat:+lat.toFixed(2), lon:+lon.toFixed(2)});
    }
  }
  return pts;
}

async function findSeasonLocations(type){
  const pts = gridPointsUSA();
  const matches=[];
  await Promise.all(pts.map(async p=>{
    const d = await weather.getWeather(p.lat,p.lon);
    let ok=false;
    switch(type){
      case 'beach':   ok = d.temp>=75 && d.temp<=92 && (d.dew ?? dewPointF(d.temp,d.humidity))<=73; break;
      case 'sweater': ok = d.temp>=55 && d.temp<=68 && (d.windSpeed<=15); break;
      case 'snow':    ok = d.temp<=32; break;
      case 'firepit': ok = d.temp>=45 && d.temp<=60 && (d.windSpeed<=12) && (d.precipProbNow==null || d.precipProbNow<20); break;
    }
    if(ok){
      matches.push({lat:p.lat,lon:p.lon,temp:d.temp,dew:d.dew ?? dewPointF(d.temp,d.humidity)});
    }
  }));
  return matches;
}

/* ================== Goldilocks (swaths + gradient) ================== */
let goldiMode = 'swaths';
let tempSurfaceLayer = null;
let goldiRects = [];

async function computeGoldilocksCells(){
  const pts = fineGridUSA();
  return Promise.all(pts.map(async p=>{
    const d = await weather.getWeather(p.lat,p.lon);
    return { lat:p.lat, lon:p.lon, temp:d.temp, wind:d.windSpeed||0,
             dew: d.dew ?? dewPointF(d.temp, d.humidity) };
  }));
}

/* Canvas overlay for gradient surface */
class TempSurface extends L.Layer{
  constructor(){ super(); this._points=null; this._step=6; }
  onAdd(map){
    this._map=map;
    this._canvas=L.DomUtil.create('canvas','dummy-temp-surface');
    const size=map.getSize();
    this._canvas.width=size.x; this._canvas.height=size.y;
    map.getPanes().overlayPane.appendChild(this._canvas);
    this._redraw = this._redraw.bind(this);
    map.on('moveend zoomend resize', this._redraw);
    this._redraw();
  }
  onRemove(map){
    map.off('moveend zoomend resize', this._redraw);
    L.DomUtil.remove(this._canvas);
  }
  setData(points){ this._points=points; this._redraw(); }
  _redraw(){
    if(!this._map || !this._canvas || !this._points) return;
    const ctx=this._canvas.getContext('2d');
    const size=this._map.getSize();
    this._canvas.width=size.x; this._canvas.height=size.y;
    ctx.clearRect(0,0,size.x,size.y);

    const step=this._step;
    for(let y=0; y<size.y; y+=step){
      for(let x=0; x<size.x; x+=step){
        const latlng=this._map.containerPointToLatLng([x+step/2,y+step/2]);
        const lat=latlng.lat, lon=latlng.lng;
        if(lat<24 || lat>50 || lon<-125 || lon>-66) continue; // limit to CONUS-ish
        const t = idwTemp(lat,lon,this._points,8,2);
        ctx.fillStyle = colorForTemp(t, 0.55);
        ctx.fillRect(x,y,step,step);
      }
    }
  }
}

async function updateGoldilocksMap(){
  const cells = await computeGoldilocksCells();

  if(goldiMode==='gradient'){
    // remove swaths
    goldiRects.forEach(r=>goldilocksMap.removeLayer(r));
    goldiRects = [];

    if(!tempSurfaceLayer){ 
      tempSurfaceLayer = new TempSurface().addTo(goldilocksMap); 
    }
    tempSurfaceLayer.setData(cells.map(c=>({lat:c.lat,lon:c.lon,temp:c.temp})));

  }else{
    // remove gradient
    if(tempSurfaceLayer){ 
      goldilocksMap.removeLayer(tempSurfaceLayer); 
      tempSurfaceLayer=null; 
    }

    // clear rectangles
    goldiRects.forEach(r=>goldilocksMap.removeLayer(r));
    goldiRects = [];

    cells.forEach(c=>{
      let color = '#6366f1'; // cold (indigo)
      if(c.temp>=65 && c.temp<=75) color='#10b981';       // emerald
      else if((c.temp>=60&&c.temp<65)||(c.temp>75&&c.temp<=80)) color='#14b8a6'; // teal
      else if(c.temp>=50&&c.temp<60) color='#f59e0b';     // amber
      else if(c.temp>80) color='#ef4444';                 // red

      const bounds=[[c.lat-FINE_LAT_STEP/2,c.lon-FINE_LON_STEP/2],
                     [c.lat+FINE_LAT_STEP/2,c.lon+FINE_LON_STEP/2]];
      const rect=L.rectangle(bounds,{
        stroke:false,
        fill:true,
        fillOpacity:.52,
        fillColor:color
      }).addTo(goldilocksMap);
      
      rect.on('click', async ()=>{
        const town = await reverseTown(c.lat,c.lon);
        rect.bindPopup(`<strong>${town}</strong><br>${c.temp}¬∞F ‚Ä¢ Dew ${c.dew}¬∞ ‚Ä¢ Wind ${c.wind} mph`).openPopup();
      });
      goldiRects.push(rect);
    });
  }

  // FOMO list: best-feel perfect spots
  const hot = cells
    .filter(c=>c.temp>=65 && c.temp<=75)
    .sort((a,b)=> (a.dew-b.dew) || (a.wind-b.wind))
    .slice(0,8);
  const named = await Promise.all(hot.map(async h=>({ ...h, town: await reverseTown(h.lat,h.lon) })));
  const list = document.getElementById('goldilocksList');
  list.innerHTML = named.map(n=>`
    <div class="hotcard">
      <div>
        <div style="font-weight:800">${n.town}</div>
        <div class="meta">Right now: ${n.temp}¬∞ ‚Ä¢ Dew ${n.dew}¬∞ ‚Ä¢ ${n.wind} mph</div>
      </div>
      <div style="font-weight:900;color:var(--dummy-red)">Go üëÄ</div>
    </div>`).join('');
}

window.setGoldiMode = function(mode){
  goldiMode = mode;
  document.getElementById('btnSwaths').classList.toggle('active', mode==='swaths');
  document.getElementById('btnGradient').classList.toggle('active', mode==='gradient');
  if(goldilocksMap) updateGoldilocksMap();
};

/* ================== Arbitrage ================== */
const CITIES = [
  {name:'Miami, FL',lat:25.7617,lon:-80.1918},{name:'Anchorage, AK',lat:61.2181,lon:-149.9003},
  {name:'Phoenix, AZ',lat:33.4484,lon:-112.0740},{name:'Seattle, WA',lat:47.6062,lon:-122.3321},
  {name:'Denver, CO',lat:39.7392,lon:-104.9903},{name:'Chicago, IL',lat:41.8781,lon:-87.6298},
  {name:'New Orleans, LA',lat:29.9511,lon:-90.0715},{name:'Boston, MA',lat:42.3601,lon:-71.0589},
  {name:'San Francisco, CA',lat:37.7749,lon:-122.4194},{name:'Minneapolis, MN',lat:44.9778,lon:-93.2650},
  {name:'Las Vegas, NV',lat:36.1699,lon:-115.1398},{name:'Portland, ME',lat:43.6591,lon:-70.2568},
  {name:'Nashville, TN',lat:36.1627,lon:-86.7816},{name:'Salt Lake City, UT',lat:40.7608,lon:-111.8910},
  {name:'San Diego, CA',lat:32.7157,lon:-117.1611},{name:'Detroit, MI',lat:42.3314,lon:-83.0458},
  {name:'Houston, TX',lat:29.7604,lon:-95.3698},{name:'Atlanta, GA',lat:33.7490,lon:-84.3880},
  {name:'Portland, OR',lat:45.5152,lon:-122.6784},{name:'Honolulu, HI',lat:21.3099,lon:-157.8581}
];

window.spinArbitrage = async function(){
  if(!userLocation) return;
  const you = await weather.getWeather(userLocation.lat,userLocation.lon);
  const city = CITIES[Math.floor(Math.random()*CITIES.length)];
  const them = await weather.getWeather(city.lat,city.lon);

  const yourDP = you.dew ?? dewPointF(you.temp,you.humidity);
  const theirDP = them.dew ?? dewPointF(them.temp,them.humidity);

  document.getElementById('yourTemp').textContent = `${you.temp}¬∞`;
  document.getElementById('yourDP').textContent = `Dew: ${yourDP}¬∞`;
  document.getElementById('yourX').textContent = `Wind ${you.windSpeed} mph${you.windGust?` (gusts ${you.windGust}+)`:''}`;

  document.getElementById('compareCity').textContent = city.name.toUpperCase();
  document.getElementById('compareTemp').textContent = `${them.temp}¬∞`;
  document.getElementById('compareDP').textContent = `Dew: ${theirDP}¬∞`;
  document.getElementById('compareX').textContent = `Wind ${them.windSpeed} mph${them.windGust?` (gusts ${them.windGust}+)`:''}`;

  const tDiff = Math.abs(you.temp - them.temp);
  const dpDiff = Math.abs(yourDP - theirDP);
  let line = (you.temp===them.temp) ? `Exact same temperature!` :
             (you.temp>them.temp) ? `You're ${tDiff}¬∞ warmer than ${city.name}` :
                                     `You're ${tDiff}¬∞ cooler than ${city.name}`;
  if(dpDiff>=6){
    line += yourDP<theirDP ? ` (feels drier by dew point)` : ` (feels muggier by dew point)`;
  }
  if((you.windSpeed - them.windSpeed) > 10) line += ` ‚Ä¢ Much breezier your side`;
  if((them.windSpeed - you.windSpeed) > 10) line += ` ‚Ä¢ Much breezier there`;
  document.getElementById('arbitrageResult').textContent = line;
};

/* ============== Tabs & Views ============== */
window.switchTab = function(evt,tab){
  currentTab = tab;
  document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
  evt.target.classList.add('active');
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.getElementById(tab).classList.add('active');

  if(tab==='chase' && !seasonMap){
    seasonMap = L.map('seasonMap').setView([39.8,-98.6],4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap'}).addTo(seasonMap);
  }
  if(tab==='goldilocks' && !goldilocksMap){
    goldilocksMap = L.map('goldilocksMap').setView([39.8,-98.6],4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap'}).addTo(goldilocksMap);
    updateGoldilocksMap();
  }
};

/* Season UI */
window.showSeason = async function(evt,type){
  document.querySelectorAll('.season-btn').forEach(b=>b.classList.remove('active'));
  evt.target.classList.add('active');
  const results = document.getElementById('seasonResults');
  results.innerHTML = '<div class="loading"></div> Finding locations...';

  const locs = await findSeasonLocations(type);

  // Clear markers
  if(seasonMap){
    seasonMap.eachLayer(l=>{
      if(l instanceof L.Marker || l instanceof L.CircleMarker) seasonMap.removeLayer(l);
    });
  }

  // Name results (limit for snappiness)
  const NAMING_LIMIT = 60;
  const named = await Promise.all(locs.slice(0,NAMING_LIMIT).map(async loc=>{
    const name = await reverseTown(loc.lat, loc.lon);
    return {...loc, name};
  }));

  named.forEach(loc=>{
    L.circleMarker([loc.lat,loc.lon],{
      radius:9, fillColor:'#dc2626', color:'#fff', weight:2, fillOpacity:.9
    }).bindPopup(`<strong>${loc.name}</strong><br>${loc.temp}¬∞F ‚Ä¢ Dew ${loc.dew}¬∞`).addTo(seasonMap);
  });

  if(named.length){
    results.innerHTML = `<h3 style="color:var(--dummy-red);margin:.5rem 0">${named.length} good spots right now:</h3>` +
      named.map(l=>`<div class="hotcard">
        <div>
          <strong>${l.name}</strong>
          <div class="meta">${l.temp}¬∞ ‚Ä¢ Dew ${l.dew}¬∞</div>
        </div>
        <div style="font-weight:900;color:var(--dummy-red)">Save üíæ</div>
      </div>`).join('');
  }else{
    results.innerHTML = `<div class="pill" style="text-align:center;color:var(--muted)">Nothing ideal at the moment ‚Äî try another vibe.</div>`;
  }
};

/* ============== App init ============== */
(async function init(){
  await getUserLocation();
  await updateHyperlocal();
  setInterval(()=>{ if(currentTab==='hyperlocal') updateHyperlocal(); }, 5*60*1000);
})();
</script>
</body>
</html>
