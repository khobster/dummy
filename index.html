<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dummy - Weather's Weird Side</title>

  <!-- Favicon to stop 404 -->
  <link rel="icon" href="dummy_logo.png"/>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --red:#dc2626; --blue:#3b82f6; --green:#10b981; --amber:#f59e0b;
      --gray:#f3f4f6; --dark:#0f172a; --muted:#64748b; --card:#ffffff;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;background:var(--gray);color:var(--dark)}

    header{background:var(--card);border-bottom:3px solid var(--red);padding:1rem;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:1000}
    .logo{display:flex;align-items:center;gap:.75rem}
    .logo img{height:40px;width:auto}
    h1{font-size:1.5rem;font-weight:900;color:var(--red);letter-spacing:-.02em}

    .location-control{display:flex;gap:.5rem;align-items:center;background:var(--gray);padding:.5rem 1rem;border-radius:999px}
    .location-control input{border:none;background:none;outline:none;width:200px}

    .tabs{display:flex;background:var(--card);padding:.5rem;gap:.5rem}
    .tab{padding:.75rem 1.5rem;border:0;background:transparent;font-weight:700;cursor:pointer;border-radius:.5rem;transition:.2s}
    .tab:hover{background:var(--gray)}
    .tab.active{background:var(--red);color:#fff}

    .content{max-width:1200px;margin:0 auto;padding:1rem}
    .section{display:none}
    .section.active{display:block}

    .card{background:var(--card);border-radius:1rem;padding:1.5rem;margin:1rem 0;box-shadow:0 4px 20px rgba(0,0,0,.08)}

    .metrics{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:1rem;margin:1.5rem 0}
    .metric{text-align:center;padding:1rem;background:var(--gray);border-radius:.75rem}
    .metric-value{font-size:2rem;font-weight:900;color:var(--red)}
    .metric-label{font-size:.75rem;text-transform:uppercase;color:var(--muted);margin-top:.25rem;display:flex;gap:.35rem;justify-content:center;align-items:center}

    .help{display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:50%;background:#e5e7eb;color:#334155;font-weight:900;font-size:.7rem;cursor:help;line-height:18px}
    .help:hover{background:#e2e8f0}

    .map{height:500px;border-radius:1rem;overflow:hidden;margin:1rem 0}

    .insight{background:linear-gradient(90deg,rgba(59,130,246,.1),transparent);border-left:3px solid var(--blue);padding:1rem;margin:1rem 0;border-radius:0 .5rem .5rem 0}
    .data-age{position:absolute;top:1rem;right:1rem;padding:.25rem .75rem;background:rgba(255,255,255,.9);border-radius:999px;font-size:.75rem;color:var(--muted)}

    .twin-card{background:var(--gray);padding:1rem;border-radius:.75rem;margin:.5rem 0;display:flex;justify-content:space-between;align-items:center}

    .loading{display:inline-block;width:20px;height:20px;border:3px solid rgba(0,0,0,.1);border-top-color:var(--red);border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    .timeline{display:flex;gap:.5rem;overflow:auto;padding:.25rem 0 .5rem}
    .bucket{min-width:86px;background:#f1f5f9;border:1px solid #e2e8f0;border-radius:10px;padding:.5rem;text-align:center}
    .bucket strong{display:block;font-size:.9rem}
    .bucket .tval{font-size:1.2rem;font-weight:900;color:var(--red)}
    .bucket .mini{font-size:.7rem;color:#64748b}

    /* Pure-emoji pins, no white disks */
    .emoji-pin{font-size:22px;line-height:22px;text-align:center;transform:translate(-50%,-50%);filter:drop-shadow(0 1px 2px rgba(0,0,0,.25))}
  </style>
</head>
<body>

<header>
  <div class="logo">
    <img src="dummy_logo.png" alt="DUMMY" onerror="this.style.display='none'">
    <h1>DUMMY</h1>
  </div>
  <div class="location-control">
    <span>üìç</span>
    <input type="text" id="locationInput" placeholder="Click map or enter coords">
    <button onclick="setLocation()">Set</button>
  </div>
</header>

<nav class="tabs">
  <button class="tab active" onclick="switchTab(event,'local')">Your Weather</button>
  <button class="tab" onclick="switchTab(event,'twins')">Weather Twins</button>
  <button class="tab" onclick="switchTab(event,'roulette')">Weather Roulette</button>
</nav>

<div class="content">
  <!-- Your Weather -->
  <section id="local" class="section active">
    <div class="card" style="position:relative">
      <div class="data-age" id="dataAge">Data: -- min old</div>
      <h2>Your Exact Weather</h2>
      <p style="color:var(--muted);margin-top:.5rem">Click anywhere on map to change location</p>

      <div class="metrics">
        <div class="metric">
          <div class="metric-value" id="temp">--¬∞</div>
          <div class="metric-label">Temperature</div>
        </div>
        <div class="metric">
          <div class="metric-value" id="wetbulb">--¬∞</div>
          <div class="metric-label">
            Wet Bulb
            <span class="help" title="Approx air temp felt by a wet surface as water evaporates. Great proxy for heat stress.">?</span>
          </div>
        </div>
        <div class="metric">
          <div class="metric-value" id="dewpoint">--¬∞</div>
          <div class="metric-label">
            Dew Point
            <span class="help" title="Moisture in the air: ~55¬∞F feels dry, 60‚Äì65¬∞ a bit humid, 70¬∞+ tropical.">?</span>
          </div>
        </div>
        <div class="metric">
          <div class="metric-value" id="vpd">-- kPa</div>
          <div class="metric-label">
            VPD
            <span class="help" title="Vapor Pressure Deficit: how ‚Äòthirsty‚Äô the air is. 0‚Äì0.5: saturated ‚Ä¢ 0.5‚Äì2: comfy ‚Ä¢ >2: very dry.">?</span>
          </div>
        </div>
        <div class="metric">
          <div class="metric-value" id="spread">--¬∞</div>
          <div class="metric-label">
            T‚ÄìTd Spread
            <span class="help" title="Gap between temp and dew point. Small gap = muggy & higher condensation risk.">?</span>
          </div>
        </div>
        <div class="metric">
          <div class="metric-value" id="pressure">-- hPa</div>
          <div class="metric-label">
            Pressure
            <span class="help" title="Sea-level pressure. ~1013 hPa is average. Higher: calm/clear. Lower: unsettled/stormy.">?</span>
          </div>
        </div>
      </div>

      <div class="insight" id="moistureInsight">Analyzing moisture dynamics...</div>
      <div class="insight" id="condensationRisk">Condensation risk assessment...</div>
      <div class="insight" id="firepitHint">Checking tonight's fire-pit potential‚Ä¶</div>

      <h3 style="margin-top:.5rem">Dew Point Forecast <span style="font-size:.8rem;color:var(--muted)">(NOAA-anchored)</span></h3>
      <p style="color:var(--muted);margin:.25rem 0 .5rem">Next 12 hours</p>
      <div id="dewTimeline" class="timeline"></div>
      <p style="color:var(--muted);margin:.5rem 0 .25rem">Next 5 days (min / max)</p>
      <div id="dewDays" class="timeline"></div>
      
      <h3 style="margin-top:1rem">Fire Pit Forecast</h3>
      <p style="color:var(--muted);margin:.25rem 0 .5rem">Best evenings this week for outdoor fires</p>
      <div id="fireDays" class="timeline"></div>

      <div id="localMap" class="map"></div>
    </div>
  </section>

  <!-- Weather Twins -->
  <section id="twins" class="section">
    <div class="card">
      <h2>Weather Twins</h2>
      <p style="color:var(--muted)">Places experiencing your weather profile right now</p>
      <div id="twinsList"><p style="text-align:center;color:var(--muted)">Click the tab to search for twins...</p></div>
      <div id="twinsMap" class="map"></div>
    </div>
  </section>

  <!-- Weather Roulette -->
  <section id="roulette" class="section">
    <div class="card">
      <h2>Weather Roulette</h2>
      <p style="color:var(--muted)">Click anywhere on the map for a 3-way comparison</p>
      <div id="rouletteMap" class="map"></div>
      <div id="rouletteResults"><p style="text-align:center;color:var(--muted)">Click on the map to spin the weather roulette!</p></div>
    </div>
  </section>
</div>

<script>
/* ========= US-only helpers ========= */
function approxUSLower48(lat, lon){
  if(lat<25 || lat>49.5 || lon<-125 || lon>-66) return false;
  if(lat<28.6 && lon>-97 && lon<-80) return false;     // Gulf
  if(lon>-78 && lat<34.6) return false;                // Atlantic shelf
  if(lat<31.3 && lon>-117 && lon<-98) return false;    // N. Mexico band
  return true;
}

const geocodeCache=new Map();
let geocodeQueue = Promise.resolve();

async function nameIfUSLand(lat, lon, includeState=false){
  const key=`${lat.toFixed(3)},${lon.toFixed(3)}_${includeState}`;
  if(geocodeCache.has(key)) return geocodeCache.get(key);

  return geocodeQueue = geocodeQueue.then(async () => {
    await new Promise(r=>setTimeout(r,100)); // gentle throttle
    try{
      const url=`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=12&addressdetails=1&accept-language=en&countrycodes=us`;
      const r=await fetch(url);
      if(!r.ok){ geocodeCache.set(key,null); return null; }
      const j=await r.json();
      const a=j.address||{};
      const waterWords=['Ocean','Gulf','Bay','Sound','Sea','Lagoon'];
      if(waterWords.some(w=>j.display_name?.includes(w))){ geocodeCache.set(key,null); return null; }
      let label=(a.city||a.town||a.village||a.hamlet||a.county||'').toString();
      if(!label && a.state) label=a.state;
      if(!label){ geocodeCache.set(key,null); return null; }
      if(includeState && a.state) label = `${label}, ${a.state}`;
      geocodeCache.set(key,label);
      return label;
    }catch{ geocodeCache.set(key,null); return null; }
  });
}

/* ========= Weather service ========= */
class Weather{
  constructor(){ this.cache=new Map(); this.CACHE=5*60*1000; }

  async get(lat,lon){
    const key=`${lat.toFixed(2)},${lon.toFixed(2)}`;
    const c=this.cache.get(key);
    if(c && Date.now()-c.t<this.CACHE) return c.d;

    // Try NOAA observation first for US land
    const useNOAA = approxUSLower48(lat,lon);
    if(useNOAA){
      try{
        const p = await fetch(`https://api.weather.gov/points/${lat.toFixed(4)},${lon.toFixed(4)}`,{
          headers:{'User-Agent':'dummy.app (github pages)'}
        });
        if(p.ok){
          const pj=await p.json();
          if(pj.properties && pj.properties.observationStations){
            const obs=await fetch(pj.properties.observationStations,{headers:{'User-Agent':'dummy.app (github pages)'}});
            if(obs.ok){
              const sj=await obs.json();
              const feats = (sj.features||[]).slice(0,6); // try a few stations
              for(const f of feats){
                const id=f.properties?.stationIdentifier;
                if(!id) continue;
                const latest=await fetch(`https://api.weather.gov/stations/${id}/observations/latest`,{headers:{'User-Agent':'dummy.app (github pages)'}});
                if(!latest.ok) continue;
                const lj=await latest.json();
                const props=lj.properties||{};
                const tC=props.temperature?.value;
                const tdC=props.dewpoint?.value;
                const pPa=props.barometricPressure?.value;
                if(tC!=null && tdC!=null && pPa!=null){
                  const out={
                    temp: Math.round(tC*9/5+32),
                    dewpoint: Math.round(tdC*9/5+32),
                    humidity: Math.round(props.relativeHumidity?.value ?? 50),
                    pressure: Math.round(pPa/100),
                    wind: Math.round(((props.windSpeed?.value)||0)*2.237),
                    timestamp: new Date(props.timestamp||Date.now()),
                    source: 'NOAA'
                  };
                  this.cache.set(key,{d:out,t:Date.now()});
                  return out;
                }
              }
            }
          }
        }
      }catch(e){ /* fall through to Open-Meteo */ }
    }

    // Open-Meteo fallback / rest-of-world
    try{
      const url=`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,dew_point_2m,surface_pressure,wind_speed_10m&temperature_unit=fahrenheit&wind_speed_unit=mph`;
      const r=await fetch(url);
      if(r.ok){
        const d=await r.json();
        const out={
          temp:Math.round(d.current.temperature_2m),
          dewpoint:Math.round(d.current.dew_point_2m),
          humidity:d.current.relative_humidity_2m,
          pressure:Math.round(d.current.surface_pressure),
          wind:Math.round(d.current.wind_speed_10m),
          timestamp:new Date(),
          source:'Open-Meteo'
        };
        this.cache.set(key,{d:out,t:Date.now()});
        return out;
      }
    }catch(e){ console.error(e); }

    return {temp:72,dewpoint:55,humidity:50,pressure:1013,wind:5,timestamp:new Date(),source:'Fallback'};
  }

  // Hourly model (dewpoint bias correction applied later)
  async hourly(lat,lon){
    const url=`https://api.open-meteo.com/v1/forecast`+
      `?latitude=${lat}&longitude=${lon}`+
      `&current=dew_point_2m`+
      `&hourly=dew_point_2m,temperature_2m,wind_speed_10m,precipitation_probability,cloud_cover`+
      `&temperature_unit=fahrenheit&wind_speed_unit=mph&timezone=auto`;
    const r=await fetch(url);
    const j=await r.json();

    const hours=(j.hourly.time||[]).map((t,i)=>({
      time:t,
      dp: Math.round(j.hourly.dew_point_2m?.[i] ?? NaN),
      temp: Math.round(j.hourly.temperature_2m?.[i] ?? NaN),
      wind: Math.round(j.hourly.wind_speed_10m?.[i] ?? 0),
      pop:  j.hourly.precipitation_probability?.[i] ?? null,
      clouds: j.hourly.cloud_cover?.[i] ?? null
    }));
    const omCurrentDp = (j.current && j.current.dew_point_2m!=null)
      ? Math.round(j.current.dew_point_2m)
      : null;

    return {hours, omCurrentDp, tz: j.timezone || 'UTC'};
  }
}
const weather=new Weather();

/* ========= Calcs ========= */
function wetBulb(tF,rh){const C=(tF-32)*5/9;const wb=C*Math.atan(0.151977*Math.sqrt(rh+8.313659))+Math.atan(C+rh)-Math.atan(rh-1.676331)+0.00391838*Math.pow(rh,1.5)*Math.atan(0.023101*rh)-4.686035;return Math.round(wb*9/5+32);}
function vpd(tF,rh){const C=(tF-32)*5/9;const svp=0.6108*Math.exp(17.27*C/(C+237.3));const avp=svp*rh/100;return (svp-avp).toFixed(2);}
const fmtTime = iso => new Date(iso).toLocaleTimeString('en-US',{hour:'numeric'});
const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
const dateKeyInTz=(iso,tz)=> new Date(iso).toLocaleDateString('en-CA',{timeZone:tz}); // YYYY-MM-DD
const todayKeyInTz=(tz)=> new Date().toLocaleDateString('en-CA',{timeZone:tz});

/* ========= State & maps ========= */
let userLocation={lat:40.7128,lon:-74.0060};
let maps={};
let rouletteLayer=null;

/* ========= Local panel ========= */
async function updateLocal(){
  // 1) Best current (ideally NOAA)
  const d=await weather.get(userLocation.lat,userLocation.lon);
  document.getElementById('temp').textContent=`${d.temp}¬∞`;
  document.getElementById('dewpoint').textContent=`${d.dewpoint}¬∞`;
  document.getElementById('wetbulb').textContent=`${wetBulb(d.temp,d.humidity)}¬∞`;
  document.getElementById('vpd').textContent=`${vpd(d.temp,d.humidity)}`;
  document.getElementById('spread').textContent=`${d.temp-d.dewpoint}¬∞`;
  document.getElementById('pressure').textContent=`${d.pressure}`;
  const age=Math.max(0,Math.round((Date.now()-d.timestamp)/60000));
  document.getElementById('dataAge').textContent=`Data: ${age} min old (${d.source})`;

  const spread=d.temp-d.dewpoint;
  const moist=spread<5?'‚ö†Ô∏è Near saturation ‚Äî fog/mist likely'
              :spread<10?'Very humid ‚Äî condensation on cold surfaces'
              :spread<20?'Comfortable moisture levels'
              :'Dry air ‚Äî static electricity likely';
  const dv=vpd(d.temp,d.humidity);
  document.getElementById('moistureInsight').innerHTML=
    `<strong>Moisture Status:</strong> ${moist}<br>`+
    `<strong>VPD ${dv} kPa:</strong> ${dv<0.5?'Air is saturated':dv>2?'Air is very thirsty':'Moderate moisture demand'}`;

  const surfaces=[{name:'Windows',temp:d.temp-15},{name:'Walls',temp:d.temp-8},{name:'Metal objects',temp:d.temp-20}];
  const risks=surfaces.filter(s=>s.temp<=d.dewpoint).map(s=>s.name);
  document.getElementById('condensationRisk').innerHTML=
    risks.length?`‚ö†Ô∏è <strong>Condensation likely on:</strong> ${risks.join(', ')}`:
                  `‚úì <strong>No condensation risk</strong> ‚Äî all surfaces above dew point`;

  // 2) Model hourly + dewpoint bias vs NOAA current
  const fc=await weather.hourly(userLocation.lat,userLocation.lon);
  const biasRaw = (fc.omCurrentDp!=null && Number.isFinite(d.dewpoint)) ? (d.dewpoint - fc.omCurrentDp) : 0;
  const bias = clamp(biasRaw, -8, 8);

  const correctedHours = fc.hours.map((h,idx)=>{
    const factor = idx<18 ? 1 : idx<48 ? 0.6 : 0.3; // taper bias farther out
    const dp = Math.round(clamp((h.dp||0) + bias*factor, -40, 85));
    return {...h, dp};
  });

  // 3) Next 12h dew (future only)
  const tl=document.getElementById('dewTimeline'); tl.innerHTML='';
  const nowAbs=new Date();
  const next12 = correctedHours.filter(h => new Date(h.time) > nowAbs).slice(0,12);
  (next12.length?next12:correctedHours.slice(0,12)).forEach(h=>{
    const el=document.createElement('div');
    el.className='bucket';
    el.innerHTML=`<strong>${fmtTime(h.time)}</strong>`+
                 `<div class="tval">${h.dp}¬∞</div>`+
                 `<div class="mini">${(h.pop??'‚Äì')}% precip ‚Ä¢ ${h.wind} mph</div>`;
    tl.appendChild(el);
  });

  // 4) Group by FORECAST LOCATION time zone (start today)
  const tz = fc.tz || 'UTC';
  const todayKey = todayKeyInTz(tz);
  const groups=new Map();
  correctedHours.forEach(h=>{
    const key=dateKeyInTz(h.time, tz);
    if(key>=todayKey){
      if(!groups.has(key)) groups.set(key,[]);
      groups.get(key).push(h);
    }
  });
  const dayKeys=[...groups.keys()].sort(); // ensure order

  // 5) 5-day min/max dew (corrected)
  const daysEl=document.getElementById('dewDays'); daysEl.innerHTML='';
  dayKeys.slice(0,5).forEach(k=>{
    const arr=groups.get(k);
    const min=Math.min(...arr.map(x=>x.dp));
    const max=Math.max(...arr.map(x=>x.dp));
    const el=document.createElement('div');
    el.className='bucket';
    el.innerHTML=`<strong>${new Date(k+'T12:00:00').toLocaleDateString('en-US',{weekday:'short', timeZone: tz})}</strong>`+
                 `<div class="tval">${min}¬∞ ‚Äì ${max}¬∞</div>`+
                 `<div class="mini">min / max dew</div>`;
    daysEl.appendChild(el);
  });

  // 6) Fire-pit score (evenings 6‚Äì11 PM, corrected dew)
  const fireEl=document.getElementById('fireDays'); fireEl.innerHTML='';
  dayKeys.forEach(k=>{
    const arr=(groups.get(k)||[]).filter(h=>{
      const hr=new Date(h.time).toLocaleString('en-US',{hour:'2-digit',hour12:false,timeZone:tz});
      const hInt=parseInt(hr,10);
      return hInt>=18 && hInt<=23;
    });
    if(!arr.length) return;

    const avgDew=Math.round(arr.reduce((a,b)=>a+b.dp,0)/arr.length);
    const avgTemp=Math.round(arr.reduce((a,b)=>a+b.temp,0)/arr.length);
    const maxWind=Math.max(...arr.map(h=>h.wind));
    const maxPop=Math.max(...arr.map(h=>h.pop??0));
    const avgClouds=Math.round(arr.reduce((a,b)=>a+(Number.isFinite(b.clouds)?b.clouds:50),0)/arr.length);

    let score=100;
    if(avgDew<35) score-= (35-avgDew)*2.5;
    if(avgDew>55) score-= (avgDew-55)*2.5;
    if(maxWind>10) score-= (maxWind-10)*3;
    if(maxWind>20) score=0;
    score-= maxPop*0.8;
    if(avgClouds>30) score-= (avgClouds-30)*0.5;
    if(avgTemp<55) score-= (55-avgTemp);
    if(avgTemp>75) score-= (avgTemp-75)*0.5;
    score=Math.max(0,Math.min(100,score));

    let rating='',color='';
    if(score>=80){rating='üî•üî•üî•';color='#10b981';}
    else if(score>=60){rating='üî•üî•';color='#f59e0b';}
    else if(score>=40){rating='üî•';color='#64748b';}
    else {rating='‚ùå';color='#dc2626';}

    const el=document.createElement('div');
    el.className='bucket';
    el.style.minWidth='100px';
    el.innerHTML=`<strong>${new Date(k+'T12:00:00').toLocaleDateString('en-US',{weekday:'short', timeZone: tz})}</strong>
      <div style="font-size:1.5rem">${rating}</div>
      <div class="mini" style="color:${color}">${Math.round(score)}% ideal</div>
      <div class="mini" style="font-size:.6rem">${avgTemp}¬∞F ‚Ä¢ ${maxWind}mph<br>${maxPop}% rain ‚Ä¢ ${avgClouds}% clouds</div>`;
    fireEl.appendChild(el);
  });

  // 7) Tonight quick hint (using location tz)
  const tonightKey = dayKeys[0];
  if(tonightKey){
    const tonightArr=(groups.get(tonightKey)||[]).filter(h=>{
      const hr=new Date(h.time).toLocaleString('en-US',{hour:'2-digit',hour12:false,timeZone:tz});
      const hInt=parseInt(hr,10);
      return hInt>=18 && hInt<=23;
    });
    if(tonightArr.length){
      const avgDP=Math.round(tonightArr.reduce((a,b)=>a+b.dp,0)/tonightArr.length);
      const maxWind=Math.max(...tonightArr.map(h=>h.wind));
      const maxPop=Math.max(...tonightArr.map(h=>h.pop??0));
      const good=(avgDP>=35&&avgDP<=55)&&maxWind<=12&&maxPop<25;
      document.getElementById('firepitHint').innerHTML=good
        ? `üî• <strong>Good fire-pit tonight:</strong> avg dew ${avgDP}¬∞, wind ‚â§${maxWind} mph, precip ‚â§${maxPop}%`
        : `ü™µ <strong>Meh for fire-pit:</strong> avg dew ${avgDP}¬∞, wind up to ${maxWind} mph, precip up to ${maxPop}%`;
    }else{
      document.getElementById('firepitHint').textContent='Fire-pit check: evening data not available yet.';
    }
  }else{
    document.getElementById('firepitHint').textContent='Fire-pit check: evening data not available yet.';
  }
}

/* ========= Twins ========= */
async function findTwins(){
  const me=await weather.get(userLocation.lat,userLocation.lon);
  const list=document.getElementById('twinsList');
  list.innerHTML='<div class="loading" style="margin:20px auto;display:block"></div>';

  if(maps.twins){
    maps.twins.eachLayer(l=>{ if(l instanceof L.Marker || l instanceof L.CircleMarker) maps.twins.removeLayer(l); });
  }

  const grid=[];
  for(let lat=26;lat<=48;lat+=3){
    for(let lon=-124;lon<=-67;lon+=4){
      if(approxUSLower48(lat,lon)) grid.push({lat,lon});
    }
  }

  const raw=[];
  for(const p of grid){
    const w=await weather.get(p.lat,p.lon);
    const sim=Math.abs(w.temp-me.temp)+Math.abs(w.dewpoint-me.dewpoint)+Math.abs(w.pressure-me.pressure)/10;
    if(sim<10) raw.push({lat:p.lat,lon:p.lon,weather:w,similarity:sim});
  }
  raw.sort((a,b)=>a.similarity-b.similarity);

  // Keep only first N that have a US land name
  const named=[];
  for(const r of raw){
    const nm=await nameIfUSLand(r.lat,r.lon,true);
    if(nm){ named.push({...r,name:nm}); if(named.length>=12) break; }
  }

  if(!named.length){ list.innerHTML='<p style="text-align:center;color:var(--muted)">No close US land twins found.</p>'; return; }

  list.innerHTML = named.slice(0,6).map(t=>`
    <div class="twin-card">
      <div><strong>${t.name}</strong><br>${t.weather.temp}¬∞F / ${t.weather.dewpoint}¬∞ dew / ${t.weather.pressure} hPa</div>
      <div style="color:var(--green);font-weight:bold">${Math.max(0,Math.min(100,Math.round(100 - t.similarity*10)))}% match</div>
    </div>`).join('');

  if(maps.twins){
    const youName=await nameIfUSLand(userLocation.lat,userLocation.lon,true) || 'Your location';
    L.marker([userLocation.lat,userLocation.lon]).bindPopup(`You: <strong>${youName}</strong>`).addTo(maps.twins);
    named.forEach(t=>{
      L.circleMarker([t.lat,t.lon],{radius:8,color:'#10b981',fillOpacity:.6})
       .bindPopup(`<strong>${t.name}</strong><br>${t.weather.temp}¬∞F / ${t.weather.dewpoint}¬∞ dew`)
       .addTo(maps.twins);
    });
    setTimeout(()=>maps.twins.invalidateSize(),0);
  }
}

/* ========= Roulette ========= */
function emojiDivIcon(char){ 
  return L.divIcon({className:'', html:`<div class="emoji-pin">${char}</div>`, iconSize:[22,22], iconAnchor:[11,11]}); 
}

async function roulette(lat, lon){
  document.getElementById('rouletteResults').innerHTML = '<div class="loading" style="margin:20px auto;display:block"></div>';

  const clicked = await weather.get(lat, lon);

  // Search opposite only in US land
  let maxDiff=-1, opposite=null;
  for(let tLat=26;tLat<=48;tLat+=5){
    for(let tLon=-124;tLon<=-67;tLon+=6){
      if(!approxUSLower48(tLat,tLon)) continue;
      const w=await weather.get(tLat,tLon);
      const diff = Math.abs(w.temp - clicked.temp) + Math.abs(w.dewpoint - clicked.dewpoint);
      if(diff>maxDiff){ maxDiff=diff; opposite={lat:tLat,lon:tLon,weather:w}; }
    }
  }

  // Random wildcard in US
  let wLat, wLon, wildcard=null, tries=0;
  while(tries<20 && !wildcard){
    wLat = 26 + Math.random()*22;
    wLon = -124 + Math.random()*57;
    if(approxUSLower48(wLat,wLon)){
      const w=await weather.get(wLat,wLon);
      wildcard={lat:wLat,lon:wLon,weather:w};
    }
    tries++;
  }

  const hereName = await nameIfUSLand(lat,lon,true) || `${lat.toFixed(1)}¬∞, ${Math.abs(lon).toFixed(1)}¬∞W`;
  const oppName = opposite ? (await nameIfUSLand(opposite.lat, opposite.lon, true) || `${opposite.lat.toFixed(1)}¬∞, ${Math.abs(opposite.lon).toFixed(1)}¬∞W`) : '‚Äî';
  const wildName = wildcard ? (await nameIfUSLand(wildcard.lat, wildcard.lon, true) || `${wildcard.lat.toFixed(1)}¬∞, ${Math.abs(wildcard.lon).toFixed(1)}¬∞W`) : '‚Äî';

  // Map pins (emoji only)
  if(rouletteLayer){ rouletteLayer.clearLayers(); } else { rouletteLayer=L.layerGroup().addTo(maps.roulette); }
  const youM = L.marker([lat,lon],{icon:emojiDivIcon('üéØ')}).bindPopup(`<strong>${hereName}</strong><br>${clicked.temp}¬∞F ‚Ä¢ dew ${clicked.dewpoint}¬∞`).addTo(rouletteLayer);
  let oppM,wildM;

  if(opposite){
    const isColder = opposite.weather.temp < clicked.temp;
    const em = isColder ? 'üßä' : 'üî•';
    oppM = L.marker([opposite.lat,opposite.lon],{icon:emojiDivIcon(em)})
      .bindPopup(`<strong>${oppName}</strong><br>${opposite.weather.temp}¬∞F ‚Ä¢ dew ${opposite.weather.dewpoint}¬∞`).addTo(rouletteLayer);
  }
  if(wildcard){
    wildM = L.marker([wildcard.lat,wildcard.lon],{icon:emojiDivIcon('üé≤')})
      .bindPopup(`<strong>${wildName}</strong><br>${wildcard.weather.temp}¬∞F ‚Ä¢ dew ${wildcard.weather.dewpoint}¬∞`).addTo(rouletteLayer);
  }

  // Fit bounds
  const bounds = L.latLngBounds([]);
  [youM, oppM, wildM].forEach(m=>{ if(m) bounds.extend(m.getLatLng()); });
  if(bounds.isValid()) maps.roulette.fitBounds(bounds.pad(0.2));

  // Results panel
  const diffT = opposite ? Math.abs(clicked.temp - opposite.weather.temp) : 0;
  const diffD = opposite ? Math.abs(clicked.dewpoint - opposite.weather.dewpoint) : 0;
  document.getElementById('rouletteResults').innerHTML = `
    <h3>üìç Your Click: ${hereName}</h3>
    <div class="twin-card"><div>${clicked.temp}¬∞F / ${clicked.dewpoint}¬∞ dew / ${clicked.pressure} hPa</div></div>
    <h3>üîÑ Weather Opposite: ${oppName}</h3>
    <div class="twin-card"><div>${opposite ? `${opposite.weather.temp}¬∞F / ${opposite.weather.dewpoint}¬∞ dew / ${opposite.weather.pressure} hPa` : '‚Äî'}</div>
    <div style="color: var(--amber); font-weight: bold;">${opposite ? `${diffT+diffD}¬∞ different!` : ''}</div></div>
    <h3>üé≤ Wildcard: ${wildName}</h3>
    <div class="twin-card"><div>${wildcard ? `${wildcard.weather.temp}¬∞F / ${wildcard.weather.dewpoint}¬∞ dew / ${wildcard.weather.pressure} hPa` : '‚Äî'}</div></div>
  `;
}

/* ========= Maps ========= */
function initMaps() {
  // Local map
  maps.local = L.map('localMap').setView([userLocation.lat, userLocation.lon], 8);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution: '¬© OpenStreetMap contributors'}).addTo(maps.local);
  const localMarker = L.marker([userLocation.lat, userLocation.lon]).addTo(maps.local);
  maps.local.on('click', async (e) => {
    userLocation = {lat: e.latlng.lat, lon: e.latlng.lng};
    localMarker.setLatLng(e.latlng);
    document.getElementById('locationInput').value = `${e.latlng.lat.toFixed(4)}, ${e.latlng.lng.toFixed(4)}`;
    await updateLocal();
  });

  // Twins map
  maps.twins = L.map('twinsMap').setView([39, -98], 4);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution: '¬© OpenStreetMap contributors'}).addTo(maps.twins);

  // Roulette map
  maps.roulette = L.map('rouletteMap').setView([39, -98], 4);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution: '¬© OpenStreetMap contributors'}).addTo(maps.roulette);
  maps.roulette.on('click', (e) => roulette(e.latlng.lat, e.latlng.lng));
}

/* ========= Tabs ========= */
window.switchTab = function(evt, tab){
  document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
  evt.target.classList.add('active');
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.getElementById(tab).classList.add('active');

  setTimeout(()=>{ if(maps[tab]) maps[tab].invalidateSize(); }, 100);
  if(tab==='twins') findTwins();
}

/* ========= Set location from input ========= */
window.setLocation = async function(){
  const input = document.getElementById('locationInput').value;
  const coords = input.split(',').map(s => parseFloat(s.trim()));
  if (coords.length === 2 && !isNaN(coords[0]) && !isNaN(coords[1])) {
    userLocation = {lat: coords[0], lon: coords[1]};
    if (maps.local) {
      maps.local.setView([userLocation.lat, userLocation.lon], 8);
      maps.local.eachLayer((layer) => {
        if (layer instanceof L.Marker) layer.setLatLng([userLocation.lat, userLocation.lon]);
      });
    }
    await updateLocal();
  } else {
    alert('Please enter coordinates as: latitude, longitude (e.g., 40.7128, -74.0060)');
  }
}

/* ========= Geolocation (optional) ========= */
function getUserLocation() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(async (pos)=>{
      userLocation={lat:pos.coords.latitude, lon:pos.coords.longitude};
      document.getElementById('locationInput').value = `${userLocation.lat.toFixed(4)}, ${userLocation.lon.toFixed(4)}`;
      if(maps.local){
        maps.local.setView([userLocation.lat, userLocation.lon], 8);
        maps.local.eachLayer((layer)=>{ if(layer instanceof L.Marker) layer.setLatLng([userLocation.lat, userLocation.lon]); });
      }
      await updateLocal();
    }, ()=>{/* user denied ‚Üí use default NYC */});
  }
}

/* ========= Init ========= */
window.addEventListener('DOMContentLoaded', async ()=>{
  initMaps();
  getUserLocation();
  await updateLocal(); // initial
});
</script>
</body>
</html>
