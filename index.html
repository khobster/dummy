<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dummy - Weather's Weird Side</title>

  <!-- Prevent favicon 404 -->
  <link rel="icon" href="dummy_logo.png"/>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Land-mask helpers -->
  <script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <style>
    :root{
      --red:#dc2626; --blue:#3b82f6; --green:#10b981; --amber:#f59e0b;
      --gray:#f3f4f6; --dark:#0f172a; --muted:#64748b; --card:#ffffff;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;background:var(--gray);color:var(--dark)}

    header{background:var(--card);border-bottom:3px solid var(--red);padding:1rem;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:1000}
    .logo{display:flex;align-items:center;gap:.75rem}
    .logo img{height:40px;width:auto}
    h1{font-size:1.5rem;font-weight:900;color:var(--red);letter-spacing:-.02em}

    .location-control{display:flex;gap:.5rem;align-items:center;background:var(--gray);padding:.5rem 1rem;border-radius:999px}
    .location-control input{border:none;background:none;outline:none;width:200px}

    .tabs{display:flex;background:var(--card);padding:.5rem;gap:.5rem}
    .tab{padding:.75rem 1.5rem;border:0;background:transparent;font-weight:700;cursor:pointer;border-radius:.5rem;transition:.2s}
    .tab:hover{background:var(--gray)}
    .tab.active{background:var(--red);color:#fff}

    .content{max-width:1200px;margin:0 auto;padding:1rem}
    .section{display:none}
    .section.active{display:block}

    .card{background:var(--card);border-radius:1rem;padding:1.5rem;margin:1rem 0;box-shadow:0 4px 20px rgba(0,0,0,.08)}

    .metrics{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:1rem;margin:1.5rem 0}
    .metric{text-align:center;padding:1rem;background:var(--gray);border-radius:.75rem}
    .metric-value{font-size:2rem;font-weight:900;color:var(--red)}
    .metric-label{font-size:.75rem;text-transform:uppercase;color:var(--muted);margin-top:.25rem}

    .map{height:500px;border-radius:1rem;overflow:hidden;margin:1rem 0}

    .insight{background:linear-gradient(90deg,rgba(59,130,246,.1),transparent);border-left:3px solid var(--blue);padding:1rem;margin:1rem 0;border-radius:0 .5rem .5rem 0}
    .data-age{position:absolute;top:1rem;right:1rem;padding:.25rem .75rem;background:rgba(255,255,255,.9);border-radius:999px;font-size:.75rem;color:var(--muted)}

    .twin-card{background:var(--gray);padding:1rem;border-radius:.75rem;margin:.5rem 0;display:flex;justify-content:space-between;align-items:center}

    .pressure-indicator{display:inline-block;padding:.25rem .75rem;border-radius:999px;font-weight:700;font-size:.875rem;margin:.25rem}
    .high-pressure{background:#fee2e2;color:#dc2626}
    .low-pressure{background:#dbeafe;color:#3b82f6}

    .loading{display:inline-block;width:20px;height:20px;border:3px solid rgba(0,0,0,.1);border-top-color:var(--red);border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    details{background:#f8fafc;border:1px solid #e2e8f0;border-radius:.75rem;padding:.75rem 1rem}
    details summary{cursor:pointer;font-weight:700}

    /* Emoji map pins */
    .emoji-pin{font-size:20px;line-height:20px;text-align:center;transform:translate(-50%,-50%)}
    .emoji-pin-bg{position:absolute;top:50%;left:50%;width:26px;height:26px;border-radius:50%;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,.15);transform:translate(-50%,-50%)}
  </style>
</head>
<body>

<header>
  <div class="logo">
    <img src="dummy_logo.png" alt="DUMMY" onerror="this.style.display='none'">
    <h1>DUMMY</h1>
  </div>
  <div class="location-control">
    <span>üìç</span>
    <input type="text" id="locationInput" placeholder="Click map or enter coords">
    <button onclick="setLocation()">Set</button>
  </div>
</header>

<nav class="tabs">
  <button class="tab active" onclick="switchTab(event,'local')">Your Weather</button>
  <button class="tab" onclick="switchTab(event,'twins')">Weather Twins</button>
  <button class="tab" onclick="switchTab(event,'pressure')">Pressure Chase</button>
  <button class="tab" onclick="switchTab(event,'roulette')">Weather Roulette</button>
</nav>

<div class="content">
  <!-- Your Weather -->
  <section id="local" class="section active">
    <div class="card" style="position:relative">
      <div class="data-age" id="dataAge">Data: -- min old</div>
      <h2>Your Exact Weather</h2>
      <p style="color:var(--muted);margin-top:.5rem">Click anywhere on map to change location</p>

      <div class="metrics">
        <div class="metric"><div class="metric-value" id="temp">--¬∞</div><div class="metric-label">Temperature</div></div>
        <div class="metric"><div class="metric-value" id="wetbulb">--¬∞</div><div class="metric-label">Wet Bulb</div></div>
        <div class="metric"><div class="metric-value" id="dewpoint">--¬∞</div><div class="metric-label">Dew Point</div></div>
        <div class="metric"><div class="metric-value" id="vpd">-- kPa</div><div class="metric-label">VPD</div></div>
        <div class="metric"><div class="metric-value" id="spread">--¬∞</div><div class="metric-label">T‚ÄìTd Spread</div></div>
        <div class="metric"><div class="metric-value" id="pressure">-- hPa</div><div class="metric-label">Pressure</div></div>
      </div>

      <div class="insight" id="moistureInsight">Analyzing moisture dynamics...</div>
      <div class="insight" id="condensationRisk">Condensation risk assessment...</div>

      <details>
        <summary>What do these mean?</summary>
        <ul style="margin:.5rem 0 0 1rem;line-height:1.5">
          <li><strong>Dew Point</strong>: moisture in air ‚Äî ~55¬∞F dry; 60‚Äì65¬∞ a bit humid; 70¬∞+ muggy.</li>
          <li><strong>Wet Bulb</strong>: temp ‚Äúfelt‚Äù if sweat evaporates perfectly ‚Äî crucial for heat stress.</li>
          <li><strong>T‚ÄìTd Spread</strong>: temp vs dewpoint gap. &lt;5¬∞ fog risk; 10‚Äì20¬∞ comfy; 20¬∞+ dry.</li>
          <li><strong>VPD</strong>: air‚Äôs thirst. &lt;0.5 kPa saturated; 0.5‚Äì2 moderate; &gt;2 very drying.</li>
          <li><strong>Pressure</strong>: higher ‚âà calmer/clear; lower ‚âà active/stormy.</li>
        </ul>
      </details>

      <div id="localMap" class="map"></div>
    </div>
  </section>

  <!-- Weather Twins -->
  <section id="twins" class="section">
    <div class="card">
      <h2>Weather Twins</h2>
      <p style="color:var(--muted)">Places experiencing your weather profile right now</p>
      <div id="twinsList"><p style="text-align:center;color:var(--muted)">Click the tab to search for twins...</p></div>
      <div id="twinsMap" class="map"></div>
    </div>
  </section>

  <!-- Pressure Chase -->
  <section id="pressure" class="section">
    <div class="card">
      <h2>Pressure Chase</h2>
      <p style="color:var(--muted)">Live pressure field across the Lower 48 (Open-Meteo surface pressure)</p>
      <div id="pressureMap" class="map"></div>
      <div id="pressureSystems"><p style="text-align:center;color:var(--muted)">Click the tab to load pressure data...</p></div>
    </div>
  </section>

  <!-- Weather Roulette -->
  <section id="roulette" class="section">
    <div class="card">
      <h2>Weather Roulette</h2>
      <p style="color:var(--muted)">Click anywhere on the map for a 3-way comparison</p>
      <div id="rouletteMap" class="map"></div>
      <div id="rouletteResults"><p style="text-align:center;color:var(--muted)">Click on the map to spin the weather roulette!</p></div>
    </div>
  </section>
</div>

<script>
/* ============== State, land mask & helpers ============== */
let userLocation={lat:40.7128,lon:-74.0060};
let maps={};
let rouletteLayer=null;
let usMaskPoly=null;          // Turf polygon after loading TopoJSON
const geocodeCache=new Map();

/* Load US land mask if present (CONUS TopoJSON at /us_land.topo.json) */
async function loadUSMask(){
  try{
    const resp = await fetch('us_land.topo.json', {cache:'force-cache'});
    if(!resp.ok) return;
    const topo = await resp.json();
    const objName = Object.keys(topo.objects)[0];
    const geo = topojson.feature(topo, topo.objects[objName]);
    usMaskPoly = (geo.type==='FeatureCollection') ? turf.union(...geo.features) : geo;
    console.log('US land mask loaded');
  }catch(e){
    console.log('US land mask not found; using heuristic filter.', e);
  }
}

/* Point-in-US check (mask first, fallback heuristic) */
function pointInUS(lat,lon){
  if(usMaskPoly){
    try{
      return turf.booleanPointInPolygon(turf.point([lon,lat]), usMaskPoly);
    }catch{ /* fallthrough */ }
  }
  // Heuristic fallback (keeps us off obvious ocean cells)
  const inBBox = (lat>=25 && lat<=49 && lon>=-124 && lon<=-67);
  const gulf = (lat<28 && lon>-92 && lon<-81);
  const atl  = (lon>-74 && lat<35);
  return inBBox && !gulf && !atl;
}

/* US grid that respects the mask when available */
function usGrid(stepLat=3, stepLon=4){
  const pts=[];
  for(let lat=25; lat<=49; lat+=stepLat){
    for(let lon=-124; lon<=-67; lon+=stepLon){
      if(pointInUS(lat,lon)) pts.push({lat:+lat.toFixed(2),lon:+lon.toFixed(2)});
    }
  }
  return pts;
}

/* Robust US-only reverse geocoder (Nominatim) */
async function reverseLookup(lat,lon){
  const key=`${lat.toFixed(2)},${lon.toFixed(2)}`;
  if(geocodeCache.has(key)) return geocodeCache.get(key);
  try{
    const url=`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=10&addressdetails=1&accept-language=en&countrycodes=us`;
    const r=await fetch(url);
    if(r.ok){
      const j=await r.json();
      const a=j.address||{};
      const name=a.city||a.town||a.village||a.hamlet||a.county||a.state||key;
      geocodeCache.set(key,name);
      return name;
    }
  }catch{}
  geocodeCache.set(key,key);
  return key;
}

/* Weather service (NOAA cautiously; Open-Meteo fallback/forced) */
class Weather{
  constructor(){ this.cache=new Map(); this.CACHE=5*60*1000; }
  async get(lat,lon,opts={}){
    const key=`${lat.toFixed(2)},${lon.toFixed(2)}`;
    const c=this.cache.get(key);
    if(c && Date.now()-c.t<this.CACHE) return c.d;

    const forceOM = opts.forceOpenMeteo || false;

    if(!forceOM){
      const useNOAA = lat>24.5 && lat<49.5 && lon>-125 && lon<-66.5 &&
                      !(lat<25.5 && lon<-81) && !(lat>42 && lon>-71);
      if(useNOAA){
        try{
          const p=await fetch(`https://api.weather.gov/points/${lat.toFixed(4)},${lon.toFixed(4)}`,{headers:{'User-Agent':'dummy.app (github pages)'}});
          if(p.ok){
            const j=await p.json();
            if(j.properties?.observationStations){
              const s=await fetch(j.properties.observationStations,{headers:{'User-Agent':'dummy.app (github pages)'}});
              if(s.ok){
                const st=await s.json();
                if(st.features?.length){
                  const id=st.features[0].properties.stationIdentifier;
                  const latest=await fetch(`https://api.weather.gov/stations/${id}/observations/latest`,{headers:{'User-Agent':'dummy.app (github pages)'}});
                  if(latest.ok){
                    const d=(await latest.json()).properties;
                    if(d.temperature && d.dewpoint && d.barometricPressure){
                      const out={
                        temp:Math.round(d.temperature.value*9/5+32),
                        dewpoint:Math.round(d.dewpoint.value*9/5+32),
                        humidity:d.relativeHumidity?.value||50,
                        pressure:Math.round(d.barometricPressure.value/100),
                        wind:Math.round((d.windSpeed?.value||0)*2.237),
                        timestamp:new Date(d.timestamp), source:'NOAA'
                      };
                      this.cache.set(key,{d:out,t:Date.now()}); return out;
                    }
                  }
                }
              }
            }
          }
        }catch(e){ /* fall through to OM */ }
      }
    }

    try{
      const url=`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,dew_point_2m,surface_pressure,wind_speed_10m&temperature_unit=fahrenheit&wind_speed_unit=mph`;
      const r=await fetch(url);
      if(r.ok){
        const d=await r.json();
        const out={
          temp:Math.round(d.current.temperature_2m),
          dewpoint:Math.round(d.current.dew_point_2m),
          humidity:d.current.relative_humidity_2m,
          pressure:Math.round(d.current.surface_pressure),
          wind:Math.round(d.current.wind_speed_10m),
          timestamp:new Date(), source:'Open-Meteo'
        };
        this.cache.set(key,{d:out,t:Date.now()}); return out;
      }
    }catch(e){ console.error('Open-Meteo fail',e); }

    return {temp:72,dewpoint:55,humidity:50,pressure:1013,wind:5,timestamp:new Date(),source:'Fallback'};
  }
}
const weather=new Weather();

/* Calcs */
function wetBulb(tF,rh){
  const C=(tF-32)*5/9;
  const wb=C*Math.atan(0.151977*Math.sqrt(rh+8.313659))+Math.atan(C+rh)-Math.atan(rh-1.676331)+0.00391838*Math.pow(rh,1.5)*Math.atan(0.023101*rh)-4.686035;
  return Math.round(wb*9/5+32);
}
function vpd(tF,rh){
  const C=(tF-32)*5/9; const svp=0.6108*Math.exp(17.27*C/(C+237.3)); const avp=svp*rh/100; return (svp-avp).toFixed(2);
}

/* ============== Local panel ============== */
async function updateLocal(){
  const d=await weather.get(userLocation.lat,userLocation.lon);
  document.getElementById('temp').textContent=`${d.temp}¬∞`;
  document.getElementById('dewpoint').textContent=`${d.dewpoint}¬∞`;
  document.getElementById('wetbulb').textContent=`${wetBulb(d.temp,d.humidity)}¬∞`;
  document.getElementById('vpd').textContent=`${vpd(d.temp,d.humidity)}`;
  document.getElementById('spread').textContent=`${d.temp-d.dewpoint}¬∞`;
  document.getElementById('pressure').textContent=`${d.pressure}`;

  const age=Math.round((Date.now()-d.timestamp)/60000);
  document.getElementById('dataAge').textContent=`Data: ${age} min old (${d.source})`;

  const spread=d.temp-d.dewpoint;
  const moist = spread<5?'‚ö†Ô∏è Near saturation ‚Äî fog/mist likely'
               : spread<10?'Very humid ‚Äî condensation on cold surfaces'
               : spread<20?'Comfortable moisture levels'
               : 'Dry air ‚Äî static electricity likely';
  const dv=vpd(d.temp,d.humidity);
  document.getElementById('moistureInsight').innerHTML =
    `<strong>Moisture Status:</strong> ${moist}<br><strong>VPD ${dv} kPa:</strong> ${dv<0.5?'Air is saturated':dv>2?'Air is very thirsty':'Moderate moisture demand'}`;

  const surfaces=[{name:'Windows',temp:d.temp-15},{name:'Walls',temp:d.temp-8},{name:'Metal objects',temp:d.temp-20}];
  const risks=surfaces.filter(s=>s.temp<=d.dewpoint).map(s=>s.name);
  document.getElementById('condensationRisk').innerHTML = risks.length
    ? `‚ö†Ô∏è <strong>Condensation likely on:</strong> ${risks.join(', ')}`
    : `‚úì <strong>No condensation risk</strong> ‚Äî all surfaces above dew point`;
}

/* ============== Twins ============== */
async function findTwins(){
  const me=await weather.get(userLocation.lat,userLocation.lon);
  const list=document.getElementById('twinsList');
  list.innerHTML='<div class="loading" style="margin:20px auto;display:block"></div>';

  if(maps.twins){
    maps.twins.eachLayer(l=>{ if(l instanceof L.Marker || l instanceof L.CircleMarker) maps.twins.removeLayer(l); });
  }

  const twins=[];
  const pts=usGrid(4,5);
  for(const p of pts){
    const w=await weather.get(p.lat,p.lon,{forceOpenMeteo:true});
    const sim=Math.abs(w.temp-me.temp)+Math.abs(w.dewpoint-me.dewpoint)+Math.abs(w.pressure-me.pressure)/10;
    if(sim<8) twins.push({lat:p.lat,lon:p.lon,weather:w,similarity:sim});
  }
  twins.sort((a,b)=>a.similarity-b.similarity);
  if(!twins.length){ list.innerHTML='<p style="text-align:center;color:var(--muted)">No close weather twins found.</p>'; return; }

  const top=twins.slice(0,10);
  const named=await Promise.all(top.map(async t=>({...t,name:await reverseLookup(t.lat,t.lon)})));

  list.innerHTML = named.slice(0,5).map(t=>`
    <div class="twin-card">
      <div><strong>${t.name}</strong><br>${t.weather.temp}¬∞F / ${t.weather.dewpoint}¬∞ dew / ${t.weather.pressure} hPa</div>
      <div style="color:var(--green);font-weight:bold">${Math.max(0,Math.min(100,Math.round(100 - t.similarity*10)))}% match</div>
    </div>`).join('');

  if(maps.twins){
    const youName=await reverseLookup(userLocation.lat,userLocation.lon);
    L.marker([userLocation.lat,userLocation.lon]).bindPopup(`You: <strong>${youName}</strong>`).addTo(maps.twins);
    named.forEach(t=>{
      L.circleMarker([t.lat,t.lon],{radius:8,color:'#10b981',fillOpacity:.6})
       .bindPopup(`<strong>${t.name}</strong><br>${t.weather.temp}¬∞F / ${t.weather.dewpoint}¬∞ dew`)
       .addTo(maps.twins);
    });
    setTimeout(()=>maps.twins.invalidateSize(),0);
  }
}

/* ============== Pressure (Open-Meteo only) ============== */
async function trackPressure(){
  const list=document.getElementById('pressureSystems');
  list.innerHTML='<div class="loading" style="margin:20px auto;display:block"></div>';

  if(maps.pressure){
    maps.pressure.eachLayer(l=>{ if(l instanceof L.Marker || l instanceof L.CircleMarker) maps.pressure.removeLayer(l); });
  }

  const systems=[];
  const pts=usGrid(3,4);
  for(const p of pts){
    const w=await weather.get(p.lat,p.lon,{forceOpenMeteo:true});
    systems.push({lat:p.lat,lon:p.lon,pressure:w.pressure});
  }

  systems.sort((a,b)=>b.pressure-a.pressure);
  const highs=systems.slice(0,6), lows=systems.slice(-6).reverse();

  // Render markers first so the view never feels blank
  highs.forEach(h=>{
    L.circleMarker([h.lat,h.lon],{radius:25,color:'#dc2626',fillOpacity:.3,weight:2})
      .bindPopup(`<strong>HIGH</strong><br>${h.pressure} hPa`).addTo(maps.pressure);
  });
  lows.forEach(l=>{
    L.circleMarker([l.lat,l.lon],{radius:25,color:'#3b82f6',fillOpacity:.3,weight:2})
      .bindPopup(`<strong>LOW</strong><br>${l.pressure} hPa`).addTo(maps.pressure);
  });
  setTimeout(()=>maps.pressure.invalidateSize(),0);

  // Name only the extremes (less reverse-geocoding)
  const namedHighs=await Promise.all(highs.map(async h=>({...h,name:await reverseLookup(h.lat,h.lon)})));
  const namedLows =await Promise.all(lows .map(async l=>({...l,name:await reverseLookup(l.lat,l.lon)})));

  list.innerHTML = `
    <h3>High Pressure Centers (Calmer/Clear)</h3>
    <div style="margin-bottom:1rem">${namedHighs.map(h=>`<span class="pressure-indicator high-pressure">${h.pressure} hPa ‚Äî ${h.name}</span>`).join(' ')}</div>
    <h3>Low Pressure Centers (Active/Stormy)</h3>
    <div>${namedLows.map(l=>`<span class="pressure-indicator low-pressure">${l.pressure} hPa ‚Äî ${l.name}</span>`).join(' ')}</div>`;
}

/* ============== Roulette (US-only + emoji pins) ============== */
function emojiIcon(emoji){
  return L.divIcon({
    className:'emoji-pin',
    html:`<div class="emoji-pin-bg"></div><div>${emoji}</div>`,
    iconSize:[26,26], iconAnchor:[13,13]
  });
}

async function roulette(lat,lon){
  const panel=document.getElementById('rouletteResults');
  panel.innerHTML='<div class="loading" style="margin:20px auto;display:block"></div>';

  const clicked=await weather.get(lat,lon,{forceOpenMeteo:true});
  const grid=usGrid(5,6);

  let maxDiff=-Infinity, opposite=null;
  for(const p of grid){
    const w=await weather.get(p.lat,p.lon,{forceOpenMeteo:true});
    const diff=Math.abs(w.temp-clicked.temp)+Math.abs(w.dewpoint-clicked.dewpoint);
    if(diff>maxDiff){ maxDiff=diff; opposite={lat:p.lat,lon:p.lon,weather:w}; }
  }
  const rand=grid[Math.floor(Math.random()*grid.length)];
  const wildcard=await weather.get(rand.lat,rand.lon,{forceOpenMeteo:true});

  const [nameClick,nameOpp,nameWild] = await Promise.all([
    reverseLookup(lat,lon), reverseLookup(opposite.lat,opposite.lon), reverseLookup(rand.lat,rand.lon)
  ]);

  if(!rouletteLayer) rouletteLayer=L.layerGroup().addTo(maps.roulette); else rouletteLayer.clearLayers();

  L.marker([lat,lon],     {icon:emojiIcon('üìç')}).bindPopup(`<strong>${nameClick}</strong><br>${clicked.temp}¬∞F / ${clicked.dewpoint}¬∞ dew`).addTo(rouletteLayer);
  L.marker([opposite.lat,opposite.lon],{icon:emojiIcon('üîÑ')}).bindPopup(`<strong>${nameOpp}</strong><br>${opposite.weather.temp}¬∞F / ${opposite.weather.dewpoint}¬∞ dew`).addTo(rouletteLayer);
  L.marker([rand.lat,rand.lon],        {icon:emojiIcon('üé≤')}).bindPopup(`<strong>${nameWild}</strong><br>${wildcard.temp}¬∞F / ${wildcard.dewpoint}¬∞ dew`).addTo(rouletteLayer);

  const bounds=L.latLngBounds([[lat,lon],[opposite.lat,opposite.lon],[rand.lat,rand.lon]]);
  maps.roulette.fitBounds(bounds,{padding:[30,30]});

  panel.innerHTML = `
    <h3>üìç Your Click: ${nameClick}</h3>
    <div class="twin-card"><div>${clicked.temp}¬∞F / ${clicked.dewpoint}¬∞ dew / ${clicked.pressure} hPa</div></div>
    <h3>üîÑ Weather Opposite: ${nameOpp}</h3>
    <div class="twin-card"><div>${opposite.weather.temp}¬∞F / ${opposite.weather.dewpoint}¬∞ dew / ${opposite.weather.pressure} hPa</div>
      <div style="color:var(--amber);font-weight:bold">${maxDiff}¬∞ different!</div></div>
    <h3>üé≤ Wildcard: ${nameWild}</h3>
    <div class="twin-card"><div>${wildcard.temp}¬∞F / ${wildcard.dewpoint}¬∞ dew / ${wildcard.pressure} hPa</div></div>`;
}

/* ============== Maps ============== */
function initMaps(){
  maps.local = L.map('localMap').setView([userLocation.lat,userLocation.lon],8);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap contributors'}).addTo(maps.local);
  const localMarker=L.marker([userLocation.lat,userLocation.lon]).addTo(maps.local);
  maps.local.on('click', async e=>{
    userLocation={lat:e.latlng.lat,lon:e.latlng.lng};
    localMarker.setLatLng(e.latlng);
    document.getElementById('locationInput').value=`${e.latlng.lat.toFixed(4)}, ${e.latlng.lng.toFixed(4)}`;
    await updateLocal();
  });
  setTimeout(()=>maps.local.invalidateSize(),0);

  maps.twins = L.map('twinsMap').setView([39,-98],4);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap contributors'}).addTo(maps.twins);

  maps.pressure = L.map('pressureMap').setView([39,-98],4);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap contributors'}).addTo(maps.pressure);

  maps.roulette = L.map('rouletteMap').setView([39,-98],4);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap contributors'}).addTo(maps.roulette);
  maps.roulette.on('click', e=>roulette(e.latlng.lat,e.latlng.lng));
}

/* ============== Tabs ============== */
window.switchTab=function(evt,tab){
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.getElementById(tab).classList.add('active');
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  if(evt?.currentTarget) evt.currentTarget.classList.add('active');

  setTimeout(()=>{ if(maps[tab]) maps[tab].invalidateSize(); },50);

  if(tab==='twins') findTwins();
  if(tab==='pressure') trackPressure();
};

/* ============== Location input & geolocation ============== */
window.setLocation=async function(){
  const txt=document.getElementById('locationInput').value;
  const parts=txt.split(',').map(s=>parseFloat(s.trim()));
  if(parts.length===2 && !isNaN(parts[0]) && !isNaN(parts[1])){
    userLocation={lat:parts[0],lon:parts[1]};
    if(maps.local){
      maps.local.setView([userLocation.lat,userLocation.lon],8);
      maps.local.eachLayer(l=>{ if(l instanceof L.Marker) l.setLatLng([userLocation.lat,userLocation.lon]); });
      setTimeout(()=>maps.local.invalidateSize(),0);
    }
    await updateLocal();
  }else{
    alert('Enter: latitude, longitude (e.g., 40.7128, -74.0060)');
  }
};

function getUserLocation(){
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(async pos=>{
      userLocation={lat:pos.coords.latitude,lon:pos.coords.longitude};
      document.getElementById('locationInput').value=`${userLocation.lat.toFixed(4)}, ${userLocation.lon.toFixed(4)}`;
      if(maps.local){
        maps.local.setView([userLocation.lat,userLocation.lon],8);
        maps.local.eachLayer(l=>{ if(l instanceof L.Marker) l.setLatLng([userLocation.lat,userLocation.lon]); });
        setTimeout(()=>maps.local.invalidateSize(),0);
      }
      await updateLocal();
    }, err=>console.log('Geolocation error:',err));
  }
}

/* ============== Init ============== */
window.addEventListener('DOMContentLoaded', async ()=>{
  await loadUSMask();   // if the file exists, great; if not, we still proceed
  initMaps();
  getUserLocation();
  updateLocal();
});
</script>
</body>
</html>
