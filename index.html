<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dummy - Weather's Weird Side</title>

  <link rel="icon" href="dummy_logo.png"/>

  <!-- Leaflet core -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Leaflet.draw (for buttons + shapes) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css">
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

  <!-- Arrowheads on polylines -->
  <script src="https://unpkg.com/leaflet-polylinedecorator@1.7.0/dist/leaflet.polylineDecorator.min.js"></script>

  <style>
    :root{
      --red:#dc2626; --blue:#3b82f6; --green:#10b981; --amber:#f59e0b;
      --gray:#f3f4f6; --dark:#0f172a; --muted:#64748b; --card:#ffffff; --tooltip:#111827;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;background:var(--gray);color:var(--dark)}

    header{background:var(--card);border-bottom:3px solid var(--red);padding:1rem;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:1000}
    .logo{display:flex;align-items:center;gap:.75rem}
    .logo img{height:40px;width:auto}
    h1{font-size:1.5rem;font-weight:900;color:var(--red);letter-spacing:-.02em}

    .location-control{display:flex;gap:.5rem;align-items:center;background:var(--gray);padding:.5rem 1rem;border-radius:999px}
    .location-control input{border:none;background:none;outline:none;width:220px}

    .tabs{display:flex;background:var(--card);padding:.5rem;gap:.5rem}
    .tab{padding:.75rem 1.5rem;border:0;background:transparent;font-weight:700;cursor:pointer;border-radius:.5rem;transition:.2s}
    .tab:hover{background:var(--gray)}
    .tab.active{background:var(--red);color:#fff}

    .content{max-width:1200px;margin:0 auto;padding:1rem}
    .section{display:none}
    .section.active{display:block}

    .card{background:var(--card);border-radius:1rem;padding:1.5rem;margin:1rem 0;box-shadow:0 4px 20px rgba(0,0,0,.08)}
    .map{height:520px;border-radius:1rem;overflow:hidden;margin:1rem 0}

    .metrics{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:1rem;margin:1.5rem 0}
    .metric{text-align:center;padding:1rem;background:var(--gray);border-radius:.75rem}
    .metric-value{font-size:2rem;font-weight:900;color:var(--red)}
    .metric-label{font-size:.75rem;text-transform:uppercase;color:var(--muted);margin-top:.25rem;display:flex;gap:.35rem;justify-content:center;align-items:center}

    .insight{background:linear-gradient(90deg,rgba(59,130,246,.1),transparent);border-left:3px solid var(--blue);padding:1rem;margin:1rem 0;border-radius:0 .5rem .5rem 0}
    .data-age{position:absolute;top:1rem;right:1rem;padding:.25rem .75rem;background:rgba(255,255,255,.9);border-radius:999px;font-size:.75rem;color:var(--muted)}

    .timeline{display:flex;gap:.5rem;overflow:auto;padding:.25rem 0 .5rem}
    .bucket{min-width:86px;background:#f1f5f9;border:1px solid #e2e8f0;border-radius:10px;padding:.5rem;text-align:center}
    .bucket strong{display:block;font-size:.9rem}
    .bucket .tval{font-size:1.2rem;font-weight:900;color:var(--red)}
    .bucket .mini{font-size:.7rem;color:#64748b}

    .help{display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:50%;background:#e5e7eb;color:#334155;font-weight:900;font-size:.7rem;cursor:help;line-height:18px;position:relative}
    .help[data-tip]::after{
      content:attr(data-tip);
      position:absolute; bottom:130%; left:50%; transform:translateX(-50%) translateY(4px);
      background:var(--tooltip); color:#fff; padding:.35rem .5rem; border-radius:.375rem; font-size:.72rem; white-space:nowrap; box-shadow:0 6px 20px rgba(0,0,0,.15);
      opacity:0; pointer-events:none; transition:opacity .15s, transform .15s; z-index:20;
    }
    .help[data-tip]::before{
      content:""; position:absolute; bottom:118%; left:50%; transform:translateX(-50%);
      border:6px solid transparent; border-top-color:var(--tooltip); opacity:0; transition:opacity .15s; z-index:19;
    }
    .help:hover::after,.help:focus::after{opacity:1; transform:translateX(-50%) translateY(0)}
    .help:hover::before,.help:focus::before{opacity:1}

    .emoji-pin{font-size:22px;line-height:22px;text-align:center;transform:translate(-50%,-50%);filter:drop-shadow(0 1px 2px rgba(0,0,0,.25))}

    /* Storm Lab toolbar */
    .radar-toolbar{display:flex;flex-wrap:wrap;gap:.5rem;align-items:center}
    .btn{background:#fff;border:1px solid #e5e7eb;border-radius:.5rem;padding:.5rem .75rem;cursor:pointer;font-weight:600}
    .btn.tog.active{background:#0ea5e9;color:#fff;border-color:#0ea5e9}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .sep{width:1px;height:28px;background:#e5e7eb;margin:0 .25rem}
    input[type="range"]{accent-color:#0ea5e9}
    .pill{background:#eef2ff;color:#374151;border-radius:999px;padding:.25rem .6rem;font-size:.78rem}
  </style>
</head>
<body>

<header>
  <div class="logo">
    <img src="dummy_logo.png" alt="DUMMY" onerror="this.style.display='none'">
    <h1>DUMMY</h1>
  </div>
  <div class="location-control">
    <span>üìç</span>
    <input type="text" id="locationInput" placeholder="Click map or enter coords (lat, lon)">
    <button class="btn" onclick="setLocation()">Set</button>
  </div>
</header>

<nav class="tabs">
  <button class="tab active" onclick="switchTab(event,'local')">Your Weather</button>
  <button class="tab" onclick="switchTab(event,'stormlab')">Storm Lab</button>
  <button class="tab" onclick="switchTab(event,'roulette')">Weather Roulette</button>
</nav>

<div class="content">
  <!-- Your Weather -->
  <section id="local" class="section active">
    <div class="card" style="position:relative">
      <div class="data-age" id="dataAge">Data: -- min old</div>
      <h2>Your Exact Weather</h2>
      <p style="color:var(--muted);margin-top:.5rem">Click anywhere on map to change location</p>

      <div class="metrics">
        <div class="metric"><div class="metric-value" id="temp">--¬∞</div><div class="metric-label">Temperature</div></div>
        <div class="metric">
          <div class="metric-value" id="wetbulb">--¬∞</div>
          <div class="metric-label">Wet Bulb <span class="help" tabindex="0" data-tip="Evaporative cooling benchmark; great proxy for heat stress.">?</span></div>
        </div>
        <div class="metric">
          <div class="metric-value" id="dewpoint">--¬∞</div>
          <div class="metric-label">Dew Point <span class="help" tabindex="0" data-tip="~55¬∞ dry ‚Ä¢ 60‚Äì65¬∞ a bit humid ‚Ä¢ 70¬∞+ tropical.">?</span></div>
        </div>
        <div class="metric">
          <div class="metric-value" id="vpd">-- kPa</div>
          <div class="metric-label">VPD <span class="help" tabindex="0" data-tip="Air ‚Äòthirst‚Äô. 0‚Äì0.5 saturated ‚Ä¢ 0.5‚Äì2 comfy ‚Ä¢ >2 very dry.">?</span></div>
        </div>
        <div class="metric"><div class="metric-value" id="spread">--¬∞</div><div class="metric-label">T‚ÄìTd Spread</div></div>
        <div class="metric"><div class="metric-value" id="pressure">-- hPa</div><div class="metric-label">Pressure</div></div>
      </div>

      <div class="insight" id="moistureInsight">Analyzing moisture dynamics...</div>
      <div class="insight" id="condensationRisk">Condensation risk assessment...</div>
      <div class="insight" id="firepitHint">Checking tonight's fire-pit potential‚Ä¶</div>

      <h3 style="margin-top:.5rem">Dew Point Forecast <span style="font-size:.8rem;color:var(--muted)">(NOAA-anchored)</span></h3>
      <p style="color:var(--muted);margin:.25rem 0 .5rem">Next 12 hours</p>
      <div id="dewTimeline" class="timeline"></div>
      <p style="color:var(--muted);margin:.5rem 0 .25rem">Next 5 days (min / max)</p>
      <div id="dewDays" class="timeline"></div>

      <h3 style="margin-top:1rem">Fire Pit Forecast</h3>
      <p style="color:var(--muted);margin:.25rem 0 .5rem">Best evenings this week for outdoor fires</p>
      <div id="fireDays" class="timeline"></div>

      <div id="localMap" class="map"></div>
    </div>
  </section>

  <!-- Storm Lab -->
  <section id="stormlab" class="section">
    <div class="card">
      <h2>Storm Lab ‚Äî Draw Your Own Forecast</h2>
      <p style="color:var(--muted);margin:.25rem 0 1rem">
        Watch the radar, then use the pen or arrow to sketch where you think the echoes will go. Shareable and fun.
      </p>

      <div class="radar-toolbar" style="margin-bottom:.5rem">
        <button id="prevFrame" class="btn">‚è™ Prev</button>
        <button id="playPause" class="btn tog">‚ñ∂Ô∏è Play</button>
        <button id="nextFrame" class="btn">‚è© Next</button>
        <span class="sep"></span>
        <span class="pill">Frame: <span id="radarTime">‚Äî</span></span>
        <span class="sep"></span>
        <label class="pill" style="display:flex;gap:.5rem;align-items:center">Opacity
          <input id="radarOpacity" type="range" min="20" max="100" value="75">
        </label>
        <span class="sep"></span>
        <button id="penBtn" class="btn tog">‚úèÔ∏è Pen</button>
        <button id="arrowBtn" class="btn tog">‚û°Ô∏è Arrow</button>
        <label class="pill" style="display:flex;gap:.35rem;align-items:center">Color
          <input id="inkColor" type="color" value="#ef4444" style="border:none;background:transparent;width:28px;height:28px;padding:0">
        </label>
        <button id="undoBtn" class="btn">‚Ü©Ô∏è Undo</button>
        <button id="clearBtn" class="btn">üßπ Clear</button>
      </div>

      <div id="radarMap" class="map"></div>
      <p style="color:var(--muted);font-size:.85rem;margin-top:.25rem">
        Sources: RainViewer (composite, nowcast) ‚Ä¢ Fallback: IEM/NEXRAD. Times are local. Drawing happens entirely in your browser.
      </p>
    </div>
  </section>

  <!-- Weather Roulette -->
  <section id="roulette" class="section">
    <div class="card">
      <h2>Weather Roulette</h2>
      <p style="color:var(--muted)">Click anywhere on the map for a 3-way comparison</p>
      <div id="rouletteMap" class="map"></div>
      <div id="rouletteResults"><p style="text-align:center;color:var(--muted)">Click on the map to spin the weather roulette!</p></div>
    </div>
  </section>
</div>

<script>
/* ========================= Small helpers & constants ========================= */
const R2D = Math.PI/180;
const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
const fmtTime = iso => new Date(iso).toLocaleTimeString('en-US',{hour:'numeric'});
const dateKeyInTz=(iso,tz)=> new Date(iso).toLocaleDateString('en-CA',{timeZone:tz});
const todayKeyInTz=(tz)=> new Date().toLocaleDateString('en-CA',{timeZone:tz});
const fetchJSON = async (url, timeoutMs=9000) => {
  const ctrl = new AbortController(); const t=setTimeout(()=>ctrl.abort('timeout'),timeoutMs);
  try{ const r=await fetch(url,{signal:ctrl.signal}); if(!r.ok) throw new Error('HTTP '+r.status); return await r.json(); }
  finally{ clearTimeout(t); }
};

function wetBulb(tF,rh){const C=(tF-32)*5/9;const wb=C*Math.atan(0.151977*Math.sqrt(rh+8.313659))+Math.atan(C+rh)-Math.atan(rh-1.676331)+0.00391838*Math.pow(rh,1.5)*Math.atan(0.023101*rh)-4.686035;return Math.round(wb*9/5+32);}
function vpd(tF,rh){const C=(tF-32)*5/9;const svp=0.6108*Math.exp(17.27*C/(C+237.3));const avp=svp*(rh??50)/100;return (svp-avp).toFixed(2);}
function dewpointFromTRH(tF, rh){const tC=(tF-32)*5/9;const a=17.625,b=243.04;const g=Math.log(Math.max(1e-6,rh/100))+(a*tC)/(b+tC);return (b*g)/(a-g)*9/5+32;}

function approxUSLower48(lat, lon){
  if(lat<25 || lat>49.5 || lon<-125 || lon>-66) return false;
  if(lat<28.6 && lon>-97 && lon<-80) return false;
  if(lon>-78 && lat<34.6) return false;
  if(lat<31.3 && lon>-117 && lon<-98) return false;
  return true;
}

/* ========================= Weather engine (NOAA ‚Üí OM fallback) ========================= */
class Weather{
  constructor(){ this.cache=new Map(); this.CACHE=5*60*1000; }

  async get(lat,lon,opts={bulk:false}){
    const key=`${lat.toFixed(2)},${lon.toFixed(2)}${opts.bulk?'|b':''}`;
    const c=this.cache.get(key); if(c && Date.now()-c.t<this.CACHE) return c.d;

    if(!opts.bulk && approxUSLower48(lat,lon)){
      try{
        const p=await fetchJSON(`https://api.weather.gov/points/${lat.toFixed(4)},${lon.toFixed(4)}`,8000);
        if(p?.properties?.observationStations){
          const stations=await fetchJSON(p.properties.observationStations,8000);
          for(const f of (stations.features||[]).slice(0,6)){
            try{
              const id=f.properties?.stationIdentifier; if(!id) continue;
              const ob=await fetchJSON(`https://api.weather.gov/stations/${id}/observations/latest`,8000);
              const pr=ob.properties||{};
              const tC=pr.temperature?.value, tdC=pr.dewpoint?.value, pPa=pr.barometricPressure?.value, rh=pr.relativeHumidity?.value;
              if(tC!=null && pPa!=null){
                let outDp=(tdC!=null)?(tdC*9/5+32):dewpointFromTRH(tC*9/5+32, rh??50);
                let out={ temp:Math.round(tC*9/5+32), dewpoint:Math.round(outDp), humidity:Math.round(rh??50),
                          pressure:Math.round(pPa/100), wind:Math.round(((pr.windSpeed?.value)||0)*2.237),
                          timestamp:new Date(pr.timestamp||Date.now()), source:'NOAA' };
                if(out.humidity<97 && Math.abs(out.temp-out.dewpoint)<=0){ out.dewpoint=Math.round(dewpointFromTRH(out.temp,out.humidity)); }
                this.cache.set(key,{d:out,t:Date.now()}); return out;
              }
            }catch{}
          }
        }
      }catch{}
    }
    try{
      const j=await fetchJSON(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,dew_point_2m,surface_pressure,wind_speed_10m&temperature_unit=fahrenheit&wind_speed_unit=mph`,9000);
      let out={ temp:Math.round(j.current.temperature_2m), dewpoint:Math.round(j.current.dew_point_2m), humidity:j.current.relative_humidity_2m,
                pressure:Math.round(j.current.surface_pressure), wind:Math.round(j.current.wind_speed_10m), timestamp:new Date(), source:'Open-Meteo' };
      if(out.humidity<97 && Math.abs(out.temp-out.dewpoint)<=0){ out.dewpoint=Math.round(dewpointFromTRH(out.temp,out.humidity)); }
      this.cache.set(key,{d:out,t:Date.now()}); return out;
    }catch{}
    return {temp:72,dewpoint:55,humidity:50,pressure:1013,wind:5,timestamp:new Date(),source:'Fallback'};
  }

  async hourly(lat,lon){
    const j=await fetchJSON(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=dew_point_2m&hourly=dew_point_2m,temperature_2m,relative_humidity_2m,wind_speed_10m,precipitation_probability,cloud_cover&temperature_unit=fahrenheit&wind_speed_unit=mph&timezone=auto`,9000);
    const hours=(j.hourly.time||[]).map((t,i)=>{
      const temp=Math.round(j.hourly.temperature_2m?.[i] ?? NaN);
      const rh=j.hourly.relative_humidity_2m?.[i] ?? null;
      let dp=Math.round(j.hourly.dew_point_2m?.[i] ?? NaN);
      if(Number.isNaN(dp) || (rh!=null && rh<97 && Math.abs((dp??0)-temp)<=0)){ if(rh!=null && Number.isFinite(temp)) dp=Math.round(dewpointFromTRH(temp,rh)); }
      return { time:t, dp, temp, rh, wind:Math.round(j.hourly.wind_speed_10m?.[i] ?? 0), pop:j.hourly.precipitation_probability?.[i] ?? null, clouds:j.hourly.cloud_cover?.[i] ?? null };
    });
    const omCurrentDp = (j.current && j.current.dew_point_2m!=null) ? Math.round(j.current.dew_point_2m) : null;
    return {hours, omCurrentDp, tz:j.timezone||'UTC'};
  }
}
const weather=new Weather();

/* ========================= State & maps ========================= */
let userLocation={lat:40.7128,lon:-74.0060};
let maps={}; let rouletteLayer=null;

/* ========================= Your Weather panel ========================= */
async function updateLocal(){
  const d=await weather.get(userLocation.lat,userLocation.lon,{bulk:false});
  document.getElementById('temp').textContent=`${d.temp}¬∞`;
  document.getElementById('dewpoint').textContent=`${d.dewpoint}¬∞`;
  document.getElementById('wetbulb').textContent=`${wetBulb(d.temp,d.humidity)}¬∞`;
  document.getElementById('vpd').textContent=`${vpd(d.temp,d.humidity)}`;
  document.getElementById('spread').textContent=`${d.temp-d.dewpoint}¬∞`;
  document.getElementById('pressure').textContent=`${d.pressure}`;
  const age=Math.max(0,Math.round((Date.now()-d.timestamp)/60000));
  document.getElementById('dataAge').textContent=`Data: ${age} min old (${d.source})`;

  const spread=d.temp-d.dewpoint;
  const moist=spread<5?'‚ö†Ô∏è Near saturation ‚Äî fog/mist likely':spread<10?'Very humid ‚Äî condensation on cold surfaces':spread<20?'Comfortable moisture levels':'Dry air ‚Äî static electricity likely';
  const dv=vpd(d.temp,d.humidity);
  document.getElementById('moistureInsight').innerHTML=`<strong>Moisture Status:</strong> ${moist}<br><strong>VPD ${dv} kPa:</strong> ${dv<0.5?'Air is saturated':dv>2?'Air is very thirsty':'Moderate moisture demand'}`;

  const surfaces=[{name:'Windows',temp:d.temp-15},{name:'Walls',temp:d.temp-8},{name:'Metal objects',temp:d.temp-20}];
  const risks=surfaces.filter(s=>s.temp<=d.dewpoint).map(s=>s.name);
  document.getElementById('condensationRisk').innerHTML=risks.length?`‚ö†Ô∏è <strong>Condensation likely on:</strong> ${risks.join(', ')}`:`‚úì <strong>No condensation risk</strong> ‚Äî all surfaces above dew point`;

  let fc; try{ fc=await weather.hourly(userLocation.lat,userLocation.lon);}catch{ fc={hours:[],omCurrentDp:null,tz:'UTC'}; }
  const biasRaw=(fc.omCurrentDp!=null && Number.isFinite(d.dewpoint))?(d.dewpoint-fc.omCurrentDp):0;
  const bias=clamp(biasRaw,-8,8);
  const corrected=(fc.hours||[]).map((h,idx)=>{ const f=idx<18?1:idx<48?0.6:0.3; const dp=Math.round(clamp((h.dp||0)+bias*f,-40,85)); return {...h,dp}; });

  const tl=document.getElementById('dewTimeline'); tl.innerHTML='';
  const now=new Date(); const next12=corrected.filter(h=>new Date(h.time)>now).slice(0,12);
  (next12.length?next12:corrected.slice(0,12)).forEach(h=>{
    const el=document.createElement('div'); el.className='bucket';
    el.innerHTML=`<strong>${fmtTime(h.time)}</strong><div class="tval">${h.dp}¬∞</div><div class="mini">${(h.pop??'‚Äì')}% precip ‚Ä¢ ${h.wind} mph</div>`;
    tl.appendChild(el);
  });

  const tz=fc.tz||'UTC', todayKey=todayKeyInTz(tz); const groups=new Map();
  corrected.forEach(h=>{ const k=dateKeyInTz(h.time,tz); if(k>=todayKey){ if(!groups.has(k)) groups.set(k,[]); groups.get(k).push(h);} });
  const keys=[...groups.keys()].sort();

  const dd=document.getElementById('dewDays'); dd.innerHTML='';
  keys.slice(0,5).forEach(k=>{ const arr=groups.get(k)||[]; if(!arr.length) return;
    const min=Math.min(...arr.map(x=>x.dp)), max=Math.max(...arr.map(x=>x.dp));
    const el=document.createElement('div'); el.className='bucket';
    el.innerHTML=`<strong>${new Date(k+'T12:00:00').toLocaleDateString('en-US',{weekday:'short',timeZone:tz})}</strong><div class="tval">${min}¬∞ ‚Äì ${max}¬∞</div><div class="mini">min / max dew</div>`;
    dd.appendChild(el);
  });

  const fire=document.getElementById('fireDays'); fire.innerHTML='';
  keys.forEach(k=>{
    const arr=(groups.get(k)||[]).filter(h=>{const hr=new Date(h.time).toLocaleString('en-US',{hour:'2-digit',hour12:false,timeZone:tz}); const h=parseInt(hr,10); return h>=18&&h<=23;});
    if(!arr.length) return;
    const avgDew=Math.round(arr.reduce((a,b)=>a+b.dp,0)/arr.length);
    const avgTemp=Math.round(arr.reduce((a,b)=>a+b.temp,0)/arr.length);
    const maxWind=Math.max(...arr.map(h=>h.wind));
    const maxPop=Math.max(...arr.map(h=>h.pop??0));
    const avgClouds=Math.round(arr.reduce((a,b)=>a+(Number.isFinite(b.clouds)?b.clouds:50),0)/arr.length);

    let score=100;
    if(avgDew<35) score-=(35-avgDew)*2.5; if(avgDew>55) score-=(avgDew-55)*2.5;
    if(maxWind>10) score-=(maxWind-10)*3; if(maxWind>20) score=0;
    score-=maxPop*0.8; if(avgClouds>30) score-=(avgClouds-30)*0.5;
    if(avgTemp<55) score-=(55-avgTemp); if(avgTemp>75) score-=(avgTemp-75)*0.5;
    score=clamp(Math.round(score),0,100);

    let rating='',color=''; if(score>=80){rating='üî•üî•üî•';color='#10b981';} else if(score>=60){rating='üî•üî•';color='#f59e0b';}
    else if(score>=40){rating='üî•';color='#64748b';} else {rating='‚ùå';color='#dc2626';}

    const el=document.createElement('div'); el.className='bucket'; el.style.minWidth='100px';
    el.innerHTML=`<strong>${new Date(k+'T12:00:00').toLocaleDateString('en-US',{weekday:'short',timeZone:tz})}</strong>
      <div style="font-size:1.5rem">${rating}</div>
      <div class="mini" style="color:${color}">${score}% ideal</div>
      <div class="mini" style="font-size:.6rem">${avgTemp}¬∞F ‚Ä¢ ${maxWind}mph<br>${maxPop}% rain ‚Ä¢ ${avgClouds}% clouds</div>`;
    fire.appendChild(el);
  });

  const tonightKey=keys[0];
  if(tonightKey){
    const arr=(groups.get(tonightKey)||[]).filter(h=>{const hr=new Date(h.time).toLocaleString('en-US',{hour:'2-digit',hour12:false,timeZone:tz}); const h=parseInt(hr,10); return h>=18&&h<=23;});
    if(arr.length){
      const avgDP=Math.round(arr.reduce((a,b)=>a+b.dp,0)/arr.length);
      const maxWind=Math.max(...arr.map(h=>h.wind));
      const maxPop=Math.max(...arr.map(h=>h.pop??0));
      const good=(avgDP>=35&&avgDP<=55)&&maxWind<=12&&maxPop<25;
      document.getElementById('firepitHint').innerHTML=good?`üî• <strong>Good fire-pit tonight:</strong> avg dew ${avgDP}¬∞, wind ‚â§${maxWind} mph, precip ‚â§${maxPop}%`:`ü™µ <strong>Meh for fire-pit:</strong> avg dew ${avgDP}¬∞, wind up to ${maxWind} mph, precip up to ${maxPop}%`;
    }else document.getElementById('firepitHint').textContent='Fire-pit check: evening data not available yet.';
  }else document.getElementById('firepitHint').textContent='Fire-pit check: evening data not available yet.';
}

/* ========================= Storm Lab: Radar + telestrator ========================= */
const Radar = {
  frames: [],    // {label, layer}
  idx: 0,        // current frame index
  timer: null,
  playing: false,
  opacity: 0.75,
  drawings: null, // L.FeatureGroup
  color: '#ef4444',
  penMode: false,
  arrowMode: false,
  penActive: null, // current polyline in pen mode
  arrowPts: []     // click-click for arrow line
};

// Build a set of radar layers (RainViewer nowcast 0..8 ‚Üí fallback IEM)
async function buildRadarLayers() {
  Radar.frames = [];
  // primary: RainViewer nowcast tiles (0=latest, higher=future)
  const tryRainviewer = (i) => L.tileLayer(`https://tilecache.rainviewer.com/v2/radar/nowcast_${i}/256/{z}/{x}/{y}/2/1_1.png`, {
    opacity: Radar.opacity, zIndex: 400, crossOrigin: true, errorTileUrl: ''
  });
  // fallback: IEM NEXRAD composite (static)
  const iem = () => L.tileLayer('https://mesonet.agron.iastate.edu/cache/tile.py/1.0.0/radar/{z}/{x}/{y}.png', {
    opacity: Radar.opacity, zIndex: 400, crossOrigin: true
  });

  // Probe RainViewer tile 0 once to see if it loads
  let rainviewerOK = true;
  await new Promise((resolve)=>{
    const probe=tryRainviewer(0);
    let settled=false;
    const done=(ok)=>{ if(!settled){ settled=true; rainviewerOK=ok; maps.radar.removeLayer(probe); resolve(); } };
    probe.on('tileerror',()=>done(false));
    probe.on('load',()=>done(true));
    probe.addTo(maps.radar);
    setTimeout(()=>done(true), 1200); // be optimistic after a second
  });

  if(rainviewerOK){
    // 0..8 frames (about ~+80 min nowcast where available)
    const count=9;
    for(let i=0;i<count;i++){
      const lyr=tryRainviewer(i);
      Radar.frames.push({label:(i===0?'Nowcast 0':'Nowcast '+i), layer:lyr});
    }
  }else{
    const lyr=iem();
    Radar.frames.push({label:'Composite', layer:lyr});
  }
}

function showRadarFrame(idx){
  if(!Radar.frames.length) return;
  Radar.idx = (idx + Radar.frames.length) % Radar.frames.length;
  // remove all radar layers first
  Radar.frames.forEach(f=>{ if(maps.radar.hasLayer(f.layer)) maps.radar.removeLayer(f.layer); });
  // add selected
  const f=Radar.frames[Radar.idx];
  f.layer.setOpacity(Radar.opacity);
  f.layer.addTo(maps.radar);
  document.getElementById('radarTime').textContent = f.label;
}

function playRadar(){
  if(Radar.playing || Radar.frames.length<=1) return;
  Radar.playing = true;
  document.getElementById('playPause').classList.add('active');
  document.getElementById('playPause').textContent='‚è∏Ô∏è Pause';
  Radar.timer = setInterval(()=> showRadarFrame(Radar.idx+1), 700);
}
function pauseRadar(){
  Radar.playing=false;
  document.getElementById('playPause').classList.remove('active');
  document.getElementById('playPause').textContent='‚ñ∂Ô∏è Play';
  if(Radar.timer){ clearInterval(Radar.timer); Radar.timer=null; }
}

/* ----- Drawing ----- */
function setInkColor(hex){ Radar.color = hex; }
function togglePen(btn){
  Radar.penMode = !Radar.penMode; Radar.arrowMode=false; Radar.arrowPts=[];
  document.getElementById('arrowBtn').classList.remove('active');
  btn.classList.toggle('active', Radar.penMode);
}
function toggleArrow(btn){
  Radar.arrowMode = !Radar.arrowMode; Radar.penMode=false;
  if(Radar.penActive){ maps.radar.removeLayer(Radar.penActive); Radar.penActive=null; }
  document.getElementById('penBtn').classList.remove('active');
  btn.classList.toggle('active', Radar.arrowMode);
}

function penStart(e){
  if(!Radar.penMode) return;
  maps.radar.dragging.disable();
  const line=L.polyline([e.latlng],{color:Radar.color,weight:4,opacity:0.95});
  line.addTo(Radar.drawings);
  Radar.penActive=line;
}
function penMove(e){
  if(Radar.penActive){ Radar.penActive.addLatLng(e.latlng); }
}
function penEnd(){
  if(Radar.penActive){ Radar.penActive=null; }
  maps.radar.dragging.enable();
}

function arrowClick(e){
  if(!Radar.arrowMode) return;
  Radar.arrowPts.push(e.latlng);
  if(Radar.arrowPts.length===2){
    const line=L.polyline(Radar.arrowPts,{color:Radar.color,weight:4,opacity:0.95});
    line.addTo(Radar.drawings);
    // add arrowhead
    L.polylineDecorator(line, {
      patterns: [{offset: '100%', repeat: 0, symbol: L.Symbol.arrowHead({pixelSize:14, polygon:false, pathOptions:{stroke:true,color:Radar.color,weight:4}})}]
    }).addTo(Radar.drawings);
    Radar.arrowPts=[];
  }
}

function undoDrawing(){
  const layers=Radar.drawings.getLayers();
  if(layers.length){
    const last=layers[layers.length-1];
    Radar.drawings.removeLayer(last);
  }
}
function clearDrawing(){ Radar.drawings.clearLayers(); }

/* ========================= Weather Roulette (unchanged) ========================= */
function emojiDivIcon(char){ return L.divIcon({className:'', html:`<div class="emoji-pin">${char}</div>`, iconSize:[22,22], iconAnchor:[11,11]}); }

async function roulette(lat, lon){
  document.getElementById('rouletteResults').innerHTML = '<div class="loading" style="margin:20px auto;display:block"></div>';
  const clicked = await weather.get(lat, lon,{bulk:false});
  let maxDiff=-1, opposite=null;
  for(let tLat=26;tLat<=48;tLat+=5){
    for(let tLon=-124;tLon<=-67;tLon+=6){
      if(!approxUSLower48(tLat,tLon)) continue;
      try{
        const w=await weather.get(tLat,tLon,{bulk:true});
        const diff = Math.abs(w.temp - clicked.temp) + Math.abs(w.dewpoint - clicked.dewpoint);
        if(diff>maxDiff){ maxDiff=diff; opposite={lat:tLat,lon:tLon,weather:w}; }
      }catch{}
    }
  }
  let wildcard=null, tries=0;
  while(tries<30 && !wildcard){
    const wLat=26+Math.random()*22, wLon=-124+Math.random()*57;
    if(approxUSLower48(wLat,wLon)){
      try{ wildcard={lat:wLat,lon:wLon,weather:await weather.get(wLat,wLon,{bulk:true})}; }catch{}
    }
    tries++;
  }

  const hereName=`${lat.toFixed(2)}, ${lon.toFixed(2)}`;
  const oppName=opposite?`${opposite.lat.toFixed(2)}, ${opposite.lon.toFixed(2)}`:'‚Äî';
  const wildName=wildcard?`${wildcard.lat.toFixed(2)}, ${wildcard.lon.toFixed(2)}`:'‚Äî';

  if(rouletteLayer){ rouletteLayer.clearLayers(); } else { rouletteLayer=L.layerGroup().addTo(maps.roulette); }
  const youM=L.marker([lat,lon],{icon:emojiDivIcon('üéØ')}).bindPopup(`<strong>${hereName}</strong><br>${clicked.temp}¬∞F ‚Ä¢ dew ${clicked.dewpoint}¬∞`).addTo(rouletteLayer);
  let oppM,wildM;
  if(opposite){ const em=(opposite.weather.temp<clicked.temp)?'üßä':'üî•';
    oppM=L.marker([opposite.lat,opposite.lon],{icon:emojiDivIcon(em)}).bindPopup(`<strong>${oppName}</strong><br>${opposite.weather.temp}¬∞F ‚Ä¢ dew ${opposite.weather.dewpoint}¬∞`).addTo(rouletteLayer); }
  if(wildcard){ wildM=L.marker([wildcard.lat,wildcard.lon],{icon:emojiDivIcon('üé≤')}).bindPopup(`<strong>${wildName}</strong><br>${wildcard.weather.temp}¬∞F ‚Ä¢ dew ${wildcard.weather.dewpoint}¬∞`).addTo(rouletteLayer); }

  const bounds=L.latLngBounds([]); [youM,oppM,wildM].forEach(m=>{ if(m) bounds.extend(m.getLatLng()); });
  if(bounds.isValid()) maps.roulette.fitBounds(bounds.pad(0.2));

  const diffT=opposite?Math.abs(clicked.temp-opposite.weather.temp):0;
  const diffD=opposite?Math.abs(clicked.dewpoint-opposite.weather.dewpoint):0;
  document.getElementById('rouletteResults').innerHTML = `
    <h3>üìç Your Click: ${hereName}</h3>
    <div class="twin-card"><div>${clicked.temp}¬∞F / ${clicked.dewpoint}¬∞ dew / ${clicked.pressure} hPa</div></div>
    <h3>üîÑ Weather Opposite: ${oppName}</h3>
    <div class="twin-card"><div>${opposite ? `${opposite.weather.temp}¬∞F / ${opposite.weather.dewpoint}¬∞ dew / ${opposite.weather.pressure} hPa` : '‚Äî'}</div>
    <div style="color: var(--amber); font-weight: bold;">${opposite ? `${diffT+diffD}¬∞ different!` : ''}</div></div>
    <h3>üé≤ Wildcard: ${wildName}</h3>
    <div class="twin-card"><div>${wildcard ? `${wildcard.weather.temp}¬∞F / ${wildcard.weather.dewpoint}¬∞ dew / ${wildcard.weather.pressure} hPa` : '‚Äî'}</div></div>`;
}

/* ========================= Maps & UI wiring ========================= */
function initMaps(){
  // Local
  maps.local=L.map('localMap').setView([userLocation.lat,userLocation.lon],8);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap contributors'}).addTo(maps.local);
  const localMarker=L.marker([userLocation.lat,userLocation.lon]).addTo(maps.local);
  maps.local.on('click', async (e)=>{ userLocation={lat:e.latlng.lat,lon:e.latlng.lng}; localMarker.setLatLng(e.latlng);
    document.getElementById('locationInput').value=`${e.latlng.lat.toFixed(4)}, ${e.latlng.lng.toFixed(4)}`; await updateLocal(); });

  // Storm Lab radar
  maps.radar=L.map('radarMap').setView([userLocation.lat,userLocation.lon],6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap contributors'}).addTo(maps.radar);
  Radar.drawings=L.featureGroup().addTo(maps.radar);

  // Pen events
  maps.radar.on('mousedown',penStart);
  maps.radar.on('mousemove',penMove);
  window.addEventListener('mouseup',penEnd);
  maps.radar.on('click',arrowClick);

  // Roulette
  maps.roulette=L.map('rouletteMap').setView([39,-98],4);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap contributors'}).addTo(maps.roulette);
  maps.roulette.on('click',(e)=>roulette(e.latlng.lat,e.latlng.lng));
}

function wireStormLabControls(){
  document.getElementById('prevFrame').onclick=()=>{ pauseRadar(); showRadarFrame(Radar.idx-1); };
  document.getElementById('nextFrame').onclick=()=>{ pauseRadar(); showRadarFrame(Radar.idx+1); };
  document.getElementById('playPause').onclick=()=>{ Radar.playing?pauseRadar():playRadar(); };
  document.getElementById('radarOpacity').oninput=(e)=>{ Radar.opacity=(+e.target.value)/100; if(Radar.frames[Radar.idx]) Radar.frames[Radar.idx].layer.setOpacity(Radar.opacity); };
  document.getElementById('penBtn').onclick=(e)=>togglePen(e.target);
  document.getElementById('arrowBtn').onclick=(e)=>toggleArrow(e.target);
  document.getElementById('inkColor').oninput=(e)=>setInkColor(e.target.value);
  document.getElementById('undoBtn').onclick=undoDrawing;
  document.getElementById('clearBtn').onclick=clearDrawing;
}

/* Tabs */
window.switchTab=function(evt,tab){
  document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
  evt.target.classList.add('active');
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.getElementById(tab).classList.add('active');
  setTimeout(()=>{ if(maps[tab]) maps[tab].invalidateSize(); },120);
};

/* Location setter */
window.setLocation=async function(){
  const v=document.getElementById('locationInput').value; const c=v.split(',').map(s=>parseFloat(s.trim()));
  if(c.length===2 && !isNaN(c[0]) && !isNaN(c[1])){
    userLocation={lat:c[0],lon:c[1]};
    if(maps.local){
      maps.local.setView([userLocation.lat,userLocation.lon],8);
      maps.local.eachLayer(l=>{ if(l instanceof L.Marker) l.setLatLng([userLocation.lat,userLocation.lon]); });
    }
    if(maps.radar){ maps.radar.setView([userLocation.lat,userLocation.lon],6); }
    await updateLocal();
  }else alert('Use: latitude, longitude   e.g., 40.7128, -74.0060');
};

/* Geolocate (optional) */
function getUserLocation(){
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(async pos=>{
      userLocation={lat:pos.coords.latitude,lon:pos.coords.longitude};
      document.getElementById('locationInput').value=`${userLocation.lat.toFixed(4)}, ${userLocation.lon.toFixed(4)}`;
      if(maps.local){
        maps.local.setView([userLocation.lat,userLocation.lon],8);
        maps.local.eachLayer(l=>{ if(l instanceof L.Marker) l.setLatLng([userLocation.lat,userLocation.lon]); });
      }
      if(maps.radar){ maps.radar.setView([userLocation.lat,userLocation.lon],6); }
      await updateLocal();
    }, ()=>{});
  }
}

/* Init */
window.addEventListener('DOMContentLoaded', async ()=>{
  initMaps();
  wireStormLabControls();
  getUserLocation();
  await updateLocal();

  // Build radar frames after map is live
  await buildRadarLayers();
  showRadarFrame(0); // start at first frame
});
</script>
</body>
</html>
