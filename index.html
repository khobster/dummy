<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dummy - Weather's Weird Side</title>

  <!-- prevent favicon 404 -->
  <link rel="icon" href="dummy_logo.png" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root {
      --red: #dc2626;
      --blue: #3b82f6;
      --green: #10b981;
      --amber: #f59e0b;
      --gray: #f3f4f6;
      --dark: #0f172a;
      --muted: #64748b;
      --card: #ffffff;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: system-ui, -apple-system, sans-serif; background: var(--gray); color: var(--dark); }

    header {
      background: var(--card);
      border-bottom: 3px solid var(--red);
      padding: 1rem;
      display: flex; justify-content: space-between; align-items: center;
      position: sticky; top: 0; z-index: 1000;
    }

    .logo { display: flex; align-items: center; gap: 0.75rem; }
    .logo img { height: 40px; width: auto; }
    h1 { font-size: 1.5rem; font-weight: 900; color: var(--red); letter-spacing: -0.02em; }

    .location-control { display: flex; gap: .5rem; align-items: center; background: var(--gray); padding: .5rem 1rem; border-radius: 999px; }
    .location-control input { border: none; background: none; outline: none; width: 200px; }

    .tabs { display: flex; background: var(--card); padding: .5rem; gap: .5rem; }
    .tab { padding: .75rem 1.5rem; border: none; background: transparent; font-weight: 700; cursor: pointer; border-radius: .5rem; transition: .2s; }
    .tab:hover { background: var(--gray); }
    .tab.active { background: var(--red); color: #fff; }

    .content { max-width: 1200px; margin: 0 auto; padding: 1rem; }
    .section { display: none; }
    .section.active { display: block; }

    .card { background: var(--card); border-radius: 1rem; padding: 1.5rem; margin: 1rem 0; box-shadow: 0 4px 20px rgba(0,0,0,.08); }

    .metrics { display: grid; grid-template-columns: repeat(auto-fit,minmax(150px,1fr)); gap: 1rem; margin: 1.5rem 0; }
    .metric { text-align: center; padding: 1rem; background: var(--gray); border-radius: .75rem; }
    .metric-value { font-size: 2rem; font-weight: 900; color: var(--red); }
    .metric-label { font-size: .75rem; text-transform: uppercase; color: var(--muted); margin-top: .25rem; }

    .map { height: 500px; border-radius: 1rem; overflow: hidden; margin: 1rem 0; }

    .insight { background: linear-gradient(90deg, rgba(59,130,246,.1), transparent);
      border-left: 3px solid var(--blue); padding: 1rem; margin: 1rem 0; border-radius: 0 .5rem .5rem 0; }

    .data-age { position: absolute; top: 1rem; right: 1rem; padding: .25rem .75rem; background: rgba(255,255,255,.9);
      border-radius: 999px; font-size: .75rem; color: var(--muted); }

    .twin-card { background: var(--gray); padding: 1rem; border-radius: .75rem; margin: .5rem 0; display: flex; justify-content: space-between; align-items: center; }

    .pressure-indicator { display:inline-block; padding:.25rem .75rem; border-radius:999px; font-weight:700; font-size:.875rem; margin:.25rem; }
    .high-pressure { background:#fee2e2; color:#dc2626; }
    .low-pressure  { background:#dbeafe; color:#3b82f6; }

    .loading { display:inline-block; width:20px; height:20px; border:3px solid rgba(0,0,0,.1); border-top-color:var(--red); border-radius:50%;
      animation:spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    details { background:#f8fafc; border:1px solid #e2e8f0; border-radius:.75rem; padding:.75rem 1rem; }
    details summary { cursor:pointer; font-weight:700; }

    @media (max-width:768px) {
      .location-control input { width: 120px; }
      .metrics { grid-template-columns: repeat(2,1fr); }
      .logo img { height: 30px; }
    }
  </style>
</head>
<body>

<header>
  <div class="logo">
    <img src="dummy_logo.png" alt="DUMMY" onerror="this.style.display='none'">
    <h1>DUMMY</h1>
  </div>
  <div class="location-control">
    <span>üìç</span>
    <input type="text" id="locationInput" placeholder="Click map or enter coords">
    <button onclick="setLocation()">Set</button>
  </div>
</header>

<nav class="tabs">
  <!-- pass the event explicitly -->
  <button class="tab active" onclick="switchTab(event,'local')">Your Weather</button>
  <button class="tab" onclick="switchTab(event,'twins')">Weather Twins</button>
  <button class="tab" onclick="switchTab(event,'pressure')">Pressure Chase</button>
  <button class="tab" onclick="switchTab(event,'roulette')">Weather Roulette</button>
</nav>

<div class="content">
  <!-- Your Weather -->
  <section id="local" class="section active">
    <div class="card" style="position: relative;">
      <div class="data-age" id="dataAge">Data: -- min old</div>
      <h2>Your Exact Weather</h2>
      <p style="color: var(--muted); margin-top: .5rem;">Click anywhere on map to change location</p>

      <div class="metrics">
        <div class="metric"><div class="metric-value" id="temp">--¬∞</div><div class="metric-label">Temperature</div></div>
        <div class="metric"><div class="metric-value" id="wetbulb">--¬∞</div><div class="metric-label">Wet Bulb</div></div>
        <div class="metric"><div class="metric-value" id="dewpoint">--¬∞</div><div class="metric-label">Dew Point</div></div>
        <div class="metric"><div class="metric-value" id="vpd">-- kPa</div><div class="metric-label">VPD</div></div>
        <div class="metric"><div class="metric-value" id="spread">--¬∞</div><div class="metric-label">T‚ÄìTd Spread</div></div>
        <div class="metric"><div class="metric-value" id="pressure">-- hPa</div><div class="metric-label">Pressure</div></div>
      </div>

      <div class="insight" id="moistureInsight">Analyzing moisture dynamics...</div>
      <div class="insight" id="condensationRisk">Condensation risk assessment...</div>

      <!-- quick explainer -->
      <details>
        <summary>What do these mean?</summary>
        <ul style="margin:.5rem 0 0 1rem; line-height:1.5;">
          <li><strong>Dew Point</strong>: measures moisture in the air. ~55¬∞F feels dry, 60‚Äì65¬∞ a bit humid, 70¬∞+ muggy.</li>
          <li><strong>Wet Bulb</strong>: temperature ‚Äúfelt‚Äù with evaporation at max efficiency ‚Äî critical for heat stress.</li>
          <li><strong>T‚ÄìTd Spread</strong>: gap between air temp and dew point. &lt;5¬∞ = foggy/misty risk; 10‚Äì20¬∞ comfy; 20¬∞+ dry.</li>
          <li><strong>VPD</strong> (Vapor Pressure Deficit): how ‚Äúthirsty‚Äù the air is. &lt;0.5 kPa saturated; 0.5‚Äì2 moderate; &gt;2 very drying.</li>
          <li><strong>Pressure</strong>: higher ‚âà calmer, sunnier; lower ‚âà active/stormy patterns.</li>
        </ul>
      </details>

      <div id="localMap" class="map"></div>
    </div>
  </section>

  <!-- Weather Twins -->
  <section id="twins" class="section">
    <div class="card">
      <h2>Weather Twins</h2>
      <p style="color: var(--muted);">Places experiencing your weather profile right now</p>
      <div id="twinsList"><p style="text-align:center;color:var(--muted);">Click the tab to search for twins...</p></div>
      <div id="twinsMap" class="map"></div>
    </div>
  </section>

  <!-- Pressure Chase -->
  <section id="pressure" class="section">
    <div class="card">
      <h2>Pressure Chase</h2>
      <p style="color: var(--muted);">Live pressure field across the Lower 48 (Open-Meteo surface pressure)</p>
      <div id="pressureMap" class="map"></div>
      <div id="pressureSystems"><p style="text-align:center;color:var(--muted);">Click the tab to load pressure data...</p></div>
    </div>
  </section>

  <!-- Weather Roulette -->
  <section id="roulette" class="section">
    <div class="card">
      <h2>Weather Roulette</h2>
      <p style="color: var(--muted);">Click anywhere on the map for a 3-way comparison</p>
      <div id="rouletteMap" class="map"></div>
      <div id="rouletteResults"><p style="text-align:center;color:var(--muted);">Click on the map to spin the weather roulette!</p></div>
    </div>
  </section>
</div>

<script>
/* ---------------- State ---------------- */
let userLocation = {lat: 40.7128, lon: -74.0060};
let maps = {};
const geocodeCache = new Map();

/* ---------------- Geocoding (name for lat/lon) ---------------- */
async function reverseLookup(lat, lon){
  const key = `${lat.toFixed(2)},${lon.toFixed(2)}`;
  if(geocodeCache.has(key)) return geocodeCache.get(key);

  // Open-Meteo reverse geocoding first (fast & free)
  try{
    const r = await fetch(`https://geocoding-api.open-meteo.com/v1/reverse?latitude=${lat}&longitude=${lon}&count=1&language=en`);
    if(r.ok){
      const j = await r.json();
      const g = j.results?.[0];
      if(g){
        const name = [g.name, g.admin1].filter(Boolean).join(', ');
        geocodeCache.set(key, name); return name;
      }
    }
  }catch{}

  // Fallback to Nominatim
  try{
    const r = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`);
    const j = await r.json();
    const name = j.address?.town || j.address?.city || j.address?.village || j.address?.county || key;
    geocodeCache.set(key, name); return name;
  }catch{
    return key;
  }
}

/* ---------------- Weather Service ---------------- */
class Weather {
  constructor(){ this.cache=new Map(); this.CACHE_TIME=5*60*1000; }
  async get(lat, lon, opts={}){
    const key=`${lat.toFixed(2)},${lon.toFixed(2)}`;
    const cached=this.cache.get(key);
    if(cached && Date.now()-cached.time<this.CACHE_TIME) return cached.data;

    const preferOpenMeteo = opts.forceOpenMeteo || false;

    if(!preferOpenMeteo){
      // conservative NOAA use (CONUS land-ish)
      const useNOAA = lat>24.5 && lat<49.5 && lon>-125 && lon<-66.5 &&
                      !(lat<25.5 && lon<-81) && !(lat>42 && lon>-71);
      if(useNOAA){
        try{
          const point=await fetch(`https://api.weather.gov/points/${lat.toFixed(4)},${lon.toFixed(4)}`, {headers:{'User-Agent':'dummy.app (github pages)'}});
          if(point.ok){
            const pData=await point.json();
            if(pData.properties?.observationStations){
              const obs=await fetch(pData.properties.observationStations, {headers:{'User-Agent':'dummy.app (github pages)'}});
              if(obs.ok){
                const stations=await obs.json();
                if(stations.features?.length){
                  const stationId=stations.features[0].properties.stationIdentifier;
                  const latest=await fetch(`https://api.weather.gov/stations/${stationId}/observations/latest`, {headers:{'User-Agent':'dummy.app (github pages)'}});
                  if(latest.ok){
                    const data=await latest.json();
                    const props=data.properties;
                    if(props.temperature && props.dewpoint && props.barometricPressure){
                      const res={
                        temp: Math.round(props.temperature.value*9/5+32),
                        dewpoint: Math.round(props.dewpoint.value*9/5+32),
                        humidity: props.relativeHumidity?.value || 50,
                        pressure: Math.round(props.barometricPressure.value/100), // hPa
                        wind: Math.round((props.windSpeed?.value || 0)*2.237),
                        timestamp: new Date(props.timestamp),
                        source:'NOAA'
                      };
                      this.cache.set(key,{data:res,time:Date.now()});
                      return res;
                    }
                  }
                }
              }
            }
          }
        }catch(e){ /* fall through to Open-Meteo */ }
      }
    }

    // Open-Meteo (global, robust)
    try{
      const url=`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,dew_point_2m,surface_pressure,wind_speed_10m&temperature_unit=fahrenheit&wind_speed_unit=mph`;
      const resp=await fetch(url);
      if(resp.ok){
        const d=await resp.json();
        const res={
          temp: Math.round(d.current.temperature_2m),
          dewpoint: Math.round(d.current.dew_point_2m),
          humidity: d.current.relative_humidity_2m,
          pressure: Math.round(d.current.surface_pressure), // hPa
          wind: Math.round(d.current.wind_speed_10m),
          timestamp: new Date(),
          source:'Open-Meteo'
        };
        this.cache.set(key,{data:res,time:Date.now()});
        return res;
      }
    }catch(e){ console.error('Weather fetch failed:', e); }

    // Fallback dummy
    return { temp:72, dewpoint:55, humidity:50, pressure:1013, wind:5, timestamp:new Date(), source:'Fallback' };
  }
}
const weather=new Weather();

/* ---------------- Calculations ---------------- */
function wetBulb(tempF,rh){
  const C=(tempF-32)*5/9;
  const wb=C*Math.atan(0.151977*Math.sqrt(rh+8.313659)) + Math.atan(C+rh) - Math.atan(rh-1.676331) +
           0.00391838*Math.pow(rh,1.5)*Math.atan(0.023101*rh) - 4.686035;
  return Math.round(wb*9/5+32);
}
function vaporPressureDeficit(tempF,rh){
  const C=(tempF-32)*5/9;
  const svp=0.6108*Math.exp(17.27*C/(C+237.3));
  const avp=svp*rh/100;
  return (svp-avp).toFixed(2);
}

/* ---------------- Local panel ---------------- */
async function updateLocal(){
  const d=await weather.get(userLocation.lat,userLocation.lon);
  document.getElementById('temp').textContent=`${d.temp}¬∞`;
  document.getElementById('dewpoint').textContent=`${d.dewpoint}¬∞`;
  document.getElementById('wetbulb').textContent=`${wetBulb(d.temp,d.humidity)}¬∞`;
  document.getElementById('vpd').textContent=`${vaporPressureDeficit(d.temp,d.humidity)}`;
  document.getElementById('spread').textContent=`${d.temp-d.dewpoint}¬∞`;
  document.getElementById('pressure').textContent=`${d.pressure}`;

  const ageMin=Math.round((Date.now()-d.timestamp)/60000);
  document.getElementById('dataAge').textContent=`Data: ${ageMin} min old (${d.source})`;

  const spread=d.temp-d.dewpoint;
  let moisture='';
  if(spread<5) moisture='‚ö†Ô∏è Near saturation ‚Äî fog/mist likely';
  else if(spread<10) moisture='Very humid ‚Äî condensation on cold surfaces';
  else if(spread<20) moisture='Comfortable moisture levels';
  else moisture='Dry air ‚Äî static electricity likely';

  const vpd=vaporPressureDeficit(d.temp,d.humidity);
  document.getElementById('moistureInsight').innerHTML =
    `<strong>Moisture Status:</strong> ${moisture}<br>
     <strong>VPD ${vpd} kPa:</strong> ${vpd<0.5 ? 'Air is saturated' : vpd>2 ? 'Air is very thirsty' : 'Moderate moisture demand'}`;

  const surfaces=[{name:'Windows',temp:d.temp-15},{name:'Walls',temp:d.temp-8},{name:'Metal objects',temp:d.temp-20}];
  const risks=surfaces.filter(s=>s.temp<=d.dewpoint).map(s=>s.name);
  document.getElementById('condensationRisk').innerHTML =
    risks.length?`‚ö†Ô∏è <strong>Condensation likely on:</strong> ${risks.join(', ')}`:`‚úì <strong>No condensation risk</strong> ‚Äî all surfaces above dew point`;
}

/* ---------------- Twins ---------------- */
async function findTwins(){
  const my=await weather.get(userLocation.lat,userLocation.lon);
  const list=document.getElementById('twinsList');
  list.innerHTML='<div class="loading" style="margin:20px auto;display:block;"></div>';

  if(maps.twins){
    maps.twins.eachLayer(l=>{ if(l instanceof L.CircleMarker || l instanceof L.Marker) maps.twins.removeLayer(l); });
  }

  const twins=[];
  for(let lat=26; lat<=47; lat+=4){
    for(let lon=-122; lon<=-72; lon+=5){
      const w=await weather.get(lat,lon,{forceOpenMeteo:true});
      const sim=Math.abs(w.temp-my.temp)+Math.abs(w.dewpoint-my.dewpoint)+Math.abs(w.pressure-my.pressure)/10;
      if(sim<8) twins.push({lat,lon,weather:w,similarity:sim});
    }
  }
  twins.sort((a,b)=>a.similarity-b.similarity);

  if(!twins.length){ list.innerHTML='<p style="text-align:center;color:var(--muted);">No close weather twins found.</p>'; return; }

  // name top entries
  const top = twins.slice(0,10);
  const named = await Promise.all(top.map(async t=>{
    const name = await reverseLookup(t.lat,t.lon);
    return {...t, name};
  }));

  // list
  list.innerHTML = named.slice(0,5).map(t=>`
    <div class="twin-card">
      <div><strong>${t.name}</strong><br>${t.weather.temp}¬∞F / ${t.weather.dewpoint}¬∞ dew / ${t.weather.pressure} hPa</div>
      <div style="color:var(--green);font-weight:bold;">${Math.max(0,Math.min(100,Math.round(100 - t.similarity*10)))}% match</div>
    </div>`).join('');

  // map
  if(maps.twins){
    const youName = await reverseLookup(userLocation.lat,userLocation.lon);
    L.marker([userLocation.lat,userLocation.lon])
      .bindPopup(`You: <strong>${youName}</strong>`)
      .addTo(maps.twins);

    named.forEach(t=>{
      L.circleMarker([t.lat,t.lon],{radius:8,color:'#10b981',fillOpacity:.6})
        .bindPopup(`<strong>${t.name}</strong><br>${t.weather.temp}¬∞F / ${t.weather.dewpoint}¬∞ dew<br>${Math.max(0,Math.min(100,Math.round(100 - t.similarity*10)))}% match`)
        .addTo(maps.twins);
    });
    setTimeout(()=>maps.twins.invalidateSize(),0);
  }
}

/* ---------------- Pressure (Open-Meteo only) ---------------- */
async function trackPressure(){
  const list=document.getElementById('pressureSystems');
  list.innerHTML='<div class="loading" style="margin:20px auto;display:block;"></div>';

  if(maps.pressure){
    maps.pressure.eachLayer(l=>{ if(l instanceof L.CircleMarker || l instanceof L.Marker) maps.pressure.removeLayer(l); });
  }

  const systems=[];
  for(let lat=26; lat<=47; lat+=3){
    for(let lon=-122; lon<=-72; lon+=4){
      const w=await weather.get(lat,lon,{forceOpenMeteo:true}); // <<< avoids NOAA 404/500
      systems.push({lat,lon,pressure:w.pressure});
    }
  }

  systems.sort((a,b)=>b.pressure-a.pressure);
  const highs=systems.slice(0,6), lows=systems.slice(-6).reverse();

  // label top highs/lows with towns
  const namedHighs = await Promise.all(highs.map(async h=>({...h, name: await reverseLookup(h.lat,h.lon)})));
  const namedLows  = await Promise.all(lows.map(async l=>({...l,  name: await reverseLookup(l.lat,l.lon)})));

  list.innerHTML = `
    <h3>High Pressure Centers (Calmer/Clear)</h3>
    <div style="margin-bottom:1rem;">${
      namedHighs.map(h=>`<span class="pressure-indicator high-pressure">${h.pressure} hPa ‚Äî ${h.name}</span>`).join(' ')
    }</div>
    <h3>Low Pressure Centers (Active/Stormy)</h3>
    <div>${
      namedLows.map(l=>`<span class="pressure-indicator low-pressure">${l.pressure} hPa ‚Äî ${l.name}</span>`).join(' ')
    }</div>`;

  if(maps.pressure){
    namedHighs.forEach(h=>L.circleMarker([h.lat,h.lon],{radius:25,color:'#dc2626',fillOpacity:.3,weight:2})
      .bindPopup(`<strong>HIGH</strong><br>${h.pressure} hPa<br>${h.name}`).addTo(maps.pressure));
    namedLows.forEach(l=>L.circleMarker([l.lat,l.lon],{radius:25,color:'#3b82f6',fillOpacity:.3,weight:2})
      .bindPopup(`<strong>LOW</strong><br>${l.pressure} hPa<br>${l.name}`).addTo(maps.pressure));
    setTimeout(()=>maps.pressure.invalidateSize(),0);
  }
}

/* ---------------- Roulette ---------------- */
let rouletteLayer = null;

async function roulette(lat,lon){
  const resultsEl=document.getElementById('rouletteResults');
  resultsEl.innerHTML='<div class="loading" style="margin:20px auto;display:block;"></div>';

  const clicked=await weather.get(lat,lon,{forceOpenMeteo:true});

  let maxDiff=0, opposite=null;
  for(let tLat=26; tLat<=47; tLat+=5){
    for(let tLon=-122; tLon<=-72; tLon+=6){
      const w=await weather.get(tLat,tLon,{forceOpenMeteo:true});
      const diff=Math.abs(w.temp-clicked.temp)+Math.abs(w.dewpoint-clicked.dewpoint);
      if(diff>maxDiff){ maxDiff=diff; opposite={lat:tLat,lon:tLon,weather:w}; }
    }
  }
  const wildLat=26+Math.random()*21, wildLon=-122+Math.random()*50;
  const wildcard=await weather.get(wildLat,wildLon,{forceOpenMeteo:true});

  // names
  const [nameClick, nameOpp, nameWild] = await Promise.all([
    reverseLookup(lat,lon),
    reverseLookup(opposite.lat, opposite.lon),
    reverseLookup(wildLat, wildLon)
  ]);

  // map markers
  if(rouletteLayer){ rouletteLayer.clearLayers(); }
  else { rouletteLayer = L.layerGroup().addTo(maps.roulette); }

  const m1 = L.marker([lat,lon], {title:'Your Click'}).bindPopup(`<strong>${nameClick}</strong><br>${clicked.temp}¬∞F / ${clicked.dewpoint}¬∞ dew`);
  const m2 = L.marker([opposite.lat,opposite.lon], {title:'Opposite'}).bindPopup(`<strong>${nameOpp}</strong><br>${opposite.weather.temp}¬∞F / ${opposite.weather.dewpoint}¬∞ dew`);
  const m3 = L.marker([wildLat,wildLon], {title:'Wildcard'}).bindPopup(`<strong>${nameWild}</strong><br>${wildcard.temp}¬∞F / ${wildcard.dewpoint}¬∞ dew`);

  rouletteLayer.addLayer(m1).addLayer(m2).addLayer(m3);
  const bounds = L.latLngBounds([ [lat,lon], [opposite.lat,opposite.lon], [wildLat,wildLon] ]);
  maps.roulette.fitBounds(bounds, {padding:[30,30]});

  // text panel
  resultsEl.innerHTML=`
    <h3>üìç Your Click: ${nameClick}</h3>
    <div class="twin-card"><div>${clicked.temp}¬∞F / ${clicked.dewpoint}¬∞ dew / ${clicked.pressure} hPa</div></div>
    <h3>üîÑ Weather Opposite: ${nameOpp}</h3>
    <div class="twin-card"><div>${opposite.weather.temp}¬∞F / ${opposite.weather.dewpoint}¬∞ dew / ${opposite.weather.pressure} hPa</div>
      <div style="color:var(--amber);font-weight:bold;">${maxDiff}¬∞ different!</div></div>
    <h3>üé≤ Wildcard: ${nameWild}</h3>
    <div class="twin-card"><div>${wildcard.temp}¬∞F / ${wildcard.dewpoint}¬∞ dew / ${wildcard.pressure} hPa</div></div>`;
}

/* ---------------- Maps ---------------- */
function initMaps(){
  maps.local = L.map('localMap').setView([userLocation.lat,userLocation.lon],8);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap contributors'}).addTo(maps.local);
  const localMarker=L.marker([userLocation.lat,userLocation.lon]).addTo(maps.local);
  maps.local.on('click', async e=>{
    userLocation={lat:e.latlng.lat,lon:e.latlng.lng};
    localMarker.setLatLng(e.latlng);
    document.getElementById('locationInput').value=`${e.latlng.lat.toFixed(4)}, ${e.latlng.lng.toFixed(4)}`;
    await updateLocal();
  });
  setTimeout(()=>maps.local.invalidateSize(),0);

  maps.twins = L.map('twinsMap').setView([39,-98],4);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap contributors'}).addTo(maps.twins);

  maps.pressure = L.map('pressureMap').setView([39,-98],4);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap contributors'}).addTo(maps.pressure);

  maps.roulette = L.map('rouletteMap').setView([39,-98],4);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap contributors'}).addTo(maps.roulette);
  maps.roulette.on('click', e=>roulette(e.latlng.lat,e.latlng.lng));
}

/* ---------------- Tabs ---------------- */
window.switchTab = function(evt, tab){
  // sections
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.getElementById(tab).classList.add('active');

  // tabs
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  if(evt && evt.currentTarget){ evt.currentTarget.classList.add('active'); }

  // fix Leaflet sizing after showing new container
  setTimeout(()=>{ if(maps[tab]) maps[tab].invalidateSize(); }, 50);

  // lazy-load data
  if(tab==='twins') findTwins();
  if(tab==='pressure') trackPressure();
};

/* ---------------- Location input ---------------- */
window.setLocation = async function(){
  const input=document.getElementById('locationInput').value;
  const parts=input.split(',').map(s=>parseFloat(s.trim()));
  if(parts.length===2 && !isNaN(parts[0]) && !isNaN(parts[1])){
    userLocation={lat:parts[0],lon:parts[1]};
    if(maps.local){
      maps.local.setView([userLocation.lat,userLocation.lon],8);
      maps.local.eachLayer(l=>{ if(l instanceof L.Marker) l.setLatLng([userLocation.lat,userLocation.lon]); });
      setTimeout(()=>maps.local.invalidateSize(),0);
    }
    await updateLocal();
  }else{
    alert('Please enter coordinates as: latitude, longitude (e.g., 40.7128, -74.0060)');
  }
};

/* ---------------- Geolocation ---------------- */
function getUserLocation(){
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(async pos=>{
      userLocation={lat:pos.coords.latitude,lon:pos.coords.longitude};
      document.getElementById('locationInput').value=`${userLocation.lat.toFixed(4)}, ${userLocation.lon.toFixed(4)}`;
      if(maps.local){
        maps.local.setView([userLocation.lat,userLocation.lon],8);
        maps.local.eachLayer(l=>{ if(l instanceof L.Marker) l.setLatLng([userLocation.lat,userLocation.lon]); });
        setTimeout(()=>maps.local.invalidateSize(),0);
      }
      await updateLocal();
    }, err=>{ console.log('Geolocation error:', err); });
  }
}

/* ---------------- Init ---------------- */
window.addEventListener('DOMContentLoaded', ()=>{
  initMaps();
  getUserLocation();
  updateLocal();
});
</script>
</body>
</html>
