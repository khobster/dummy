Totally‚Äîswitched everything to miles and replaced the AQ bar with a ‚ÄúFeels Like (Heat Index)‚Äù timeline. Also removed all AQI fetching/gating so things are snappier.

Here‚Äôs the full drop-in `index.html`:

```html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dummy - Weather's Weird Side</title>

  <!-- Favicon to stop 404 -->
  <link rel="icon" href="dummy_logo.png"/>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --red:#dc2626; --blue:#3b82f6; --green:#10b981; --amber:#f59e0b;
      --gray:#f3f4f6; --dark:#0f172a; --muted:#64748b; --card:#ffffff;
      --tooltip:#111827;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;background:var(--gray);color:var(--dark)}

    header{background:var(--card);border-bottom:3px solid var(--red);padding:1rem;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:1000}
    .logo{display:flex;align-items:center;gap:.75rem}
    .logo img{height:40px;width:auto}
    h1{font-size:1.5rem;font-weight:900;color:var(--red);letter-spacing:-.02em}

    .location-control{display:flex;gap:.5rem;align-items:center;background:var(--gray);padding:.5rem 1rem;border-radius:999px}
    .location-control input{border:none;background:none;outline:none;width:220px}

    .tabs{display:flex;background:var(--card);padding:.5rem;gap:.5rem}
    .tab{padding:.75rem 1.5rem;border:0;background:transparent;font-weight:700;cursor:pointer;border-radius:.5rem;transition:.2s}
    .tab:hover{background:var(--gray)}
    .tab.active{background:var(--red);color:#fff}

    .content{max-width:1200px;margin:0 auto;padding:1rem}
    .section{display:none}
    .section.active{display:block}

    .card{background:var(--card);border-radius:1rem;padding:1.5rem;margin:1rem 0;box-shadow:0 4px 20px rgba(0,0,0,.08)}

    .metrics{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:1rem;margin:1.5rem 0}
    .metric{text-align:center;padding:1rem;background:var(--gray);border-radius:.75rem}
    .metric-value{font-size:2rem;font-weight:900;color:var(--red)}
    .metric-label{font-size:.75rem;text-transform:uppercase;color:var(--muted);margin-top:.25rem;display:flex;gap:.35rem;justify-content:center;align-items:center}

    /* custom tooltips */
    .help{display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:50%;background:#e5e7eb;color:#334155;font-weight:900;font-size:.7rem;cursor:help;line-height:18px;position:relative}
    .help:hover{background:#e2e8f0}
    .help:focus{outline:2px solid #cbd5e1}
    .help[data-tip]::after{
      content:attr(data-tip);
      position:absolute; bottom:130%; left:50%; transform:translateX(-50%) translateY(4px);
      background:var(--tooltip); color:#fff; padding:.35rem .5rem; border-radius:.375rem; font-size:.72rem; white-space:nowrap; box-shadow:0 6px 20px rgba(0,0,0,.15);
      opacity:0; pointer-events:none; transition:opacity .15s, transform .15s; z-index:20;
    }
    .help[data-tip]::before{
      content:""; position:absolute; bottom:118%; left:50%; transform:translateX(-50%);
      border:6px solid transparent; border-top-color:var(--tooltip); opacity:0; transition:opacity .15s; z-index:19;
    }
    .help[data-tip]:hover::after,.help[data-tip]:focus::after{opacity:1; transform:translateX(-50%) translateY(0)}
    .help[data-tip]:hover::before,.help[data-tip]:focus::before{opacity:1}

    .controls{display:flex;gap:.75rem;align-items:center;flex-wrap:wrap;margin:.5rem 0 0}
    .controls label{font-size:.85rem;color:var(--muted)}
    select{padding:.4rem .6rem;border:1px solid #e2e8f0;border-radius:.5rem;background:#fff}

    .map{height:500px;border-radius:1rem;overflow:hidden;margin:1rem 0}

    .insight{background:linear-gradient(90deg,rgba(59,130,246,.1),transparent);border-left:3px solid var(--blue);padding:1rem;margin:1rem 0;border-radius:0 .5rem .5rem 0}
    .data-age{position:absolute;top:1rem;right:1rem;padding:.25rem .75rem;background:rgba(255,255,255,.9);border-radius:999px;font-size:.75rem;color:var(--muted)}

    .twin-card{background:var(--gray);padding:1rem;border-radius:.75rem;margin:.5rem 0;display:flex;justify-content:space-between;align-items:center}

    .loading{display:inline-block;width:20px;height:20px;border:3px solid rgba(0,0,0,.1);border-top-color:var(--red);border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    .timeline{display:flex;gap:.5rem;overflow:auto;padding:.25rem 0 .5rem}
    .bucket{min-width:86px;background:#f1f5f9;border:1px solid #e2e8f0;border-radius:10px;padding:.5rem;text-align:center}
    .bucket strong{display:block;font-size:.9rem}
    .bucket .tval{font-size:1.2rem;font-weight:900;color:var(--red)}
    .bucket .mini{font-size:.7rem;color:#64748b}

    .emoji-pin{font-size:22px;line-height:22px;text-align:center;transform:translate(-50%,-50%);filter:drop-shadow(0 1px 2px rgba(0,0,0,.25))}
  </style>
</head>
<body>

<header>
  <div class="logo">
    <img src="dummy_logo.png" alt="DUMMY" onerror="this.style.display='none'">
    <h1>DUMMY</h1>
  </div>
  <div class="location-control">
    <span>üìç</span>
    <input type="text" id="locationInput" placeholder="Click map or enter coords">
    <button onclick="setLocation()">Set</button>
  </div>
</header>

<nav class="tabs">
  <button class="tab active" onclick="switchTab(event,'local')">Your Weather</button>
  <button class="tab" onclick="switchTab(event,'escape')">Weather Escape</button>
</nav>

<div class="content">
  <!-- Your Weather -->
  <section id="local" class="section active">
    <div class="card" style="position:relative">
      <div class="data-age" id="dataAge">Data: -- min old</div>
      <h2>Your Exact Weather</h2>
      <p style="color:var(--muted);margin-top:.5rem">Click anywhere on map to change location</p>

      <div class="metrics">
        <div class="metric">
          <div class="metric-value" id="temp">--¬∞</div>
          <div class="metric-label">Temperature</div>
        </div>
        <div class="metric">
          <div class="metric-value" id="wetbulb">--¬∞</div>
          <div class="metric-label">
            Wet Bulb
            <span class="help" tabindex="0" data-tip="Approx air temp felt by a wet surface as water evaporates. Great proxy for heat stress.">?</span>
          </div>
        </div>
        <div class="metric">
          <div class="metric-value" id="dewpoint">--¬∞</div>
          <div class="metric-label">
            Dew Point
            <span class="help" tabindex="0" data-tip="Moisture in the air: ~55¬∞F feels dry, 60‚Äì65¬∞ a bit humid, 70¬∞+ tropical.">?</span>
          </div>
        </div>
        <div class="metric">
          <div class="metric-value" id="vpd">-- kPa</div>
          <div class="metric-label">
            VPD
            <span class="help" tabindex="0" data-tip="Vapor Pressure Deficit: how ‚Äòthirsty‚Äô the air is. 0‚Äì0.5: saturated ‚Ä¢ 0.5‚Äì2: comfy ‚Ä¢ >2: very dry.">?</span>
          </div>
        </div>
        <div class="metric">
          <div class="metric-value" id="spread">--¬∞</div>
          <div class="metric-label">
            T‚ÄìTd Spread
            <span class="help" tabindex="0" data-tip="Gap between temp and dew point. Small gap = muggy & higher condensation risk.">?</span>
          </div>
        </div>
        <div class="metric">
          <div class="metric-value" id="pressure">-- hPa</div>
          <div class="metric-label">
            Pressure
            <span class="help" tabindex="0" data-tip="Sea-level pressure. ~1013 hPa is average. Higher: calm/clear. Lower: unsettled/stormy.">?</span>
          </div>
        </div>
      </div>

      <!-- Outcome insights -->
      <div class="insight" id="wearAdvice">Figuring out what to wear‚Ä¶</div>
      <div class="insight" id="frizzRisk">Assessing frizz risk‚Ä¶</div>
      <div class="insight" id="windowsDown">Checking ‚Äúwindows-down driving‚Äù‚Ä¶</div>
      <div class="insight" id="runOutside">Finding the best run time‚Ä¶</div>
      <div class="insight" id="uvInsight">Checking UV peak‚Ä¶</div>
      <div class="insight" id="windowsOpen">Checking ‚Äúopen windows tonight?‚Äù‚Ä¶</div>
      <div class="insight" id="pressureTrend">Reading pressure trend‚Ä¶</div>
      <div class="insight" id="staticRisk">Static shock risk‚Ä¶</div>
      <div class="insight" id="dehumidify">Dehumidifier tonight?‚Ä¶</div>
      <div class="insight" id="laundryIndex">Estimating laundry drying conditions‚Ä¶</div>
      <div class="insight" id="moistureInsight">Analyzing moisture dynamics...</div>
      <div class="insight" id="condensationRisk">Condensation risk assessment...</div>
      <div class="insight" id="firepitHint">Checking tonight's fire-pit potential‚Ä¶</div>

      <h3 style="margin-top:.5rem">Feels Like (Heat Index)</h3>
      <p style="color:var(--muted);margin:.25rem 0 .5rem">Now & next 12 hours</p>
      <div id="hiTimeline" class="timeline"></div>

      <h3 style="margin-top:.5rem">Dew Point Forecast <span style="font-size:.8rem;color:var(--muted)">(NOAA-anchored)</span></h3>
      <p style="color:var(--muted);margin:.25rem 0 .5rem">Next 12 hours</p>
      <div id="dewTimeline" class="timeline"></div>
      <p style="color:var(--muted);margin:.5rem 0 .25rem">Next 5 days (min / max)</p>
      <div id="dewDays" class="timeline"></div>
      
      <h3 style="margin-top:1rem">Fire Pit Forecast</h3>
      <p style="color:var(--muted);margin:.25rem 0 .5rem">Best evenings this week for outdoor fires</p>
      <div id="fireDays" class="timeline"></div>

      <div id="localMap" class="map"></div>
    </div>
  </section>

  <!-- Weather Escape -->
  <section id="escape" class="section">
    <div class="card">
      <h2>Weather Escape</h2>
      <div class="controls">
        <label for="escapeRadius">Radius:</label>
        <select id="escapeRadius">
          <option value="200">Drive (‚âà200 mi)</option>
          <option value="500">Road trip (‚âà500 mi)</option>
          <option value="1200" selected>Flight (‚âà1200 mi)</option>
        </select>
      </div>
      <p style="color:var(--muted);margin-top:.25rem">Click anywhere on the map ‚Äî we‚Äôll find the best evening within the chosen radius for:
        <strong>Cooler</strong> ‚ùÑÔ∏è ‚Ä¢ <strong>Drier</strong> üå¨Ô∏è ‚Ä¢ <strong>Clearest skies</strong> ‚ú®</p>
      <div id="escapeMap" class="map"></div>
      <div id="escapeResults"><p style="text-align:center;color:var(--muted)">Click on the map to scout escapes!</p></div>
    </div>
  </section>
</div>

<script>
/* ========= small US place set (offline fallback for names) ========= */
const US_PLACES = [
  {n:"New York, NY",lat:40.7128,lon:-74.0060},{n:"Los Angeles, CA",lat:34.0522,lon:-118.2437},
  {n:"Chicago, IL",lat:41.8781,lon:-87.6298},{n:"Houston, TX",lat:29.7604,lon:-95.3698},
  {n:"Phoenix, AZ",lat:33.4484,lon:-112.0740},{n:"Philadelphia, PA",lat:39.9526,lon:-75.1652},
  {n:"San Antonio, TX",lat:29.4241,lon:-98.4936},{n:"San Diego, CA",lat:32.7157,lon:-117.1611},
  {n:"Dallas, TX",lat:32.7767,lon:-96.7970},{n:"San Jose, CA",lat:37.3382,lon:-121.8863},
  {n:"Austin, TX",lat:30.2672,lon:-97.7431},{n:"Jacksonville, FL",lat:30.3322,lon:-81.6557},
  {n:"San Francisco, CA",lat:37.7749,lon:-122.4194},{n:"Columbus, OH",lat:39.9612,lon:-82.9988},
  {n:"Charlotte, NC",lat:35.2271,lon:-80.8431},{n:"Indianapolis, IN",lat:39.7684,lon:-86.1581},
  {n:"Fort Worth, TX",lat:32.7555,lon:-97.3308},{n:"Seattle, WA",lat:47.6062,lon:-122.3321},
  {n:"Denver, CO",lat:39.7392,lon:-104.9903},{n:"Washington, DC",lat:38.9072,lon:-77.0369},
  {n:"Boston, MA",lat:42.3601,lon:-71.0589},{n:"Nashville, TN",lat:36.1627,lon:-86.7816},
  {n:"Portland, OR",lat:45.5152,lon:-122.6784},{n:"Oklahoma City, OK",lat:35.4676,lon:-97.5164},
  {n:"Las Vegas, NV",lat:36.1699,lon:-115.1398},{n:"Albuquerque, NM",lat:35.0844,lon:-106.6504},
  {n:"Atlanta, GA",lat:33.7490,lon:-84.3880},{n:"Miami, FL",lat:25.7617,lon:-80.1918},
  {n:"Tampa, FL",lat:27.9506,lon:-82.4572},{n:"Orlando, FL",lat:28.5383,lon:-81.3792},
  {n:"Kansas City, MO",lat:39.0997,lon:-94.5786},{n:"Minneapolis, MN",lat:44.9778,lon:-93.2650},
  {n:"St. Louis, MO",lat:38.6270,lon:-90.1994},{n:"Cincinnati, OH",lat:39.1031,lon:-84.5120},
  {n:"Cleveland, OH",lat:41.4993,lon:-81.6944},{n:"Pittsburgh, PA",lat:40.4406,lon:-79.9959},
  {n:"Buffalo, NY",lat:42.8864,lon:-78.8784},{n:"Raleigh, NC",lat:35.7796,lon:-78.6382},
  {n:"Richmond, VA",lat:37.5407,lon:-77.4360},{n:"Charleston, SC",lat:32.7765,lon:-79.9311},
  {n:"Columbia, SC",lat:34.0007,lon:-81.0348},{n:"Greenville, SC",lat:34.8526,lon:-82.3940},
  {n:"Savannah, GA",lat:32.0809,lon:-81.0912},{n:"Birmingham, AL",lat:33.5186,lon:-86.8104},
  {n:"New Orleans, LA",lat:29.9511,lon:-90.0715},{n:"Memphis, TN",lat:35.1495,lon:-90.0490},
  {n:"Louisville, KY",lat:38.2527,lon:-85.7585},{n:"Detroit, MI",lat:42.3314,lon:-83.0458},
  {n:"Milwaukee, WI",lat:43.0389,lon:-87.9065},{n:"Madison, WI",lat:43.0722,lon:-89.4008},
  {n:"Des Moines, IA",lat:41.5868,lon:-93.6250},{n:"Omaha, NE",lat:41.2565,lon:-95.9345},
  {n:"Boise, ID",lat:43.6150,lon:-116.2023},{n:"Salt Lake City, UT",lat:40.7608,lon:-111.8910},
  {n:"Phoenix, AZ",lat:33.4484,lon:-112.0740},{n:"Tucson, AZ",lat:32.2226,lon:-110.9747},
  {n:"El Paso, TX",lat:31.7619,lon:-106.4850},{n:"Honolulu, HI",lat:21.3099,lon:-157.8581},
  {n:"Anchorage, AK",lat:61.2181,lon:-149.9003},{n:"Fargo, ND",lat:46.8772,lon:-96.7898},
  {n:"Sioux Falls, SD",lat:43.5446,lon:-96.7311},{n:"Billings, MT",lat:45.7833,lon:-108.5007},
  {n:"Missoula, MT",lat:46.8721,lon:-113.9940},{n:"Spokane, WA",lat:47.6588,lon:-117.4260},
  {n:"Eugene, OR",lat:44.0521,lon:-123.0868},{n:"Fresno, CA",lat:36.7378,lon:-119.7871},
  {n:"Bakersfield, CA",lat:35.3733,lon:-119.0187},{n:"Sacramento, CA",lat:38.5816,lon:-121.4944},
  {n:"San Luis Obispo, CA",lat:35.2828,lon:-120.6596},{n:"Reno, NV",lat:39.5296,lon:-119.8138},
  {n:"Flagstaff, AZ",lat:35.1983,lon:-111.6513},{n:"Santa Fe, NM",lat:35.6870,lon:-105.9378},
  {n:"Lubbock, TX",lat:33.5779,lon:-101.8552},{n:"Amarillo, TX",lat:35.2219,lon:-101.8313},
  {n:"Tulsa, OK",lat:36.1539,lon:-95.9928},{n:"Little Rock, AR",lat:34.7465,lon:-92.2896},
  {n:"Knoxville, TN",lat:35.9606,lon:-83.9207},{n:"Baton Rouge, LA",lat:30.4515,lon:-91.1871},
  {n:"Mobile, AL",lat:30.6954,lon:-88.0399},{n:"Pensacola, FL",lat:30.4213,lon:-87.2169},
  {n:"Jackson, MS",lat:32.2988,lon:-90.1848},{n:"Chattanooga, TN",lat:35.0456,lon:-85.3097},
  {n:"Asheville, NC",lat:35.5951,lon:-82.5515},{n:"Greensboro, NC",lat:36.0726,lon:-79.7920},
  {n:"Virginia Beach, VA",lat:36.8529,lon:-75.9780},{n:"Norfolk, VA",lat:36.8508,lon:-76.2859},
  {n:"Richmond, VA",lat:37.5407,lon:-77.4360},{n:"Harrisburg, PA",lat:40.2732,lon:-76.8867},
  {n:"Albany, NY",lat:42.6526,lon:-73.7562},{n:"Syracuse, NY",lat:43.0481,lon:-76.1474},
  {n:"Rochester, NY",lat:43.1566,lon:-77.6088},{n:"Burlington, VT",lat:44.4759,lon:-73.2121},
  {n:"Manchester, NH",lat:42.9956,lon:-71.4548},{n:"Portland, ME",lat:43.6591,lon:-70.2568},
  {n:"Providence, RI",lat:41.8240,lon:-71.4128},{n:"Hartford, CT",lat:41.7658,lon:-72.6734},
  {n:"New Haven, CT",lat:41.3083,lon:-72.9279},{n:"Newark, NJ",lat:40.7357,lon:-74.1724},
  {n:"Jersey City, NJ",lat:40.7178,lon:-74.0431},{n:"Huger, SC",lat:33.0318,lon:-79.7287}
];

/* ========= helpers ========= */
const R2D = Math.PI/180;
function hav(a,b){const R=3959;const dLat=(b.lat-a.lat)*R2D;const dLon=(b.lon-a.lon)*R2D;const la1=a.lat*R2D;const la2=b.lat*R2D;const s1=Math.sin(dLat/2), s2=Math.sin(dLon/2);const c=2*Math.asin(Math.sqrt(s1*s1+Math.cos(la1)*Math.cos(la2)*s2*s2));return R*c;}
function bearing(a,b){const œÜ1=a.lat*Math.PI/180,œÜ2=b.lat*Math.PI/180,ŒîŒª=(b.lon-a.lon)*Math.PI/180;const y=Math.sin(ŒîŒª)*Math.cos(œÜ2);const x=Math.cos(œÜ1)*Math.sin(œÜ2)-Math.sin(œÜ1)*Math.cos(œÜ2)*Math.cos(ŒîŒª);let Œ∏=Math.atan2(y,x)*180/Math.PI;return (Œ∏+360)%360;}
function dir8(d){const dirs=['N','NE','E','SE','S','SW','W','NW','N'];return dirs[Math.round(d/45)];}
function nearestUSPlace(lat,lon){
  let best=null,bestD=1e9,pt={lat,lon};
  for(const p of US_PLACES){
    const d=hav(pt,{lat:p.lat,lon:p.lon});
    if(d<bestD){bestD=d; best=p;}
  }
  return (bestD<=75) ? best.n : null; // ~75 mi snap
}

/* ========= US-only helpers ========= */
function approxUSLower48(lat, lon){
  if(lat<25 || lat>49.5 || lon<-125 || lon>-66) return false;
  if(lat<28.6 && lon>-97 && lon<-80) return false;     // Gulf
  if(lon>-78 && lat<34.6) return false;                // Atlantic shelf
  if(lat<31.3 && lon>-117 && lon<-98) return false;    // N. Mexico band
  return true;
}

const geocodeCache=new Map();
let geocodeQueue = Promise.resolve();

async function nameIfUSLand(lat, lon, includeState=false){
  const offline = nearestUSPlace(lat,lon);
  if(offline) return offline;

  const key=`${lat.toFixed(3)},${lon.toFixed(3)}_${includeState}`;
  if(geocodeCache.has(key)) return geocodeCache.get(key);

  return geocodeQueue = geocodeQueue.then(async () => {
    await new Promise(r=>setTimeout(r,150));
    try{
      const url=`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=12&addressdetails=1&accept-language=en&countrycodes=us`;
      const r=await fetch(url,{method:'GET'});
      if(!r.ok){ geocodeCache.set(key,null); return null; }
      const j=await r.json();
      const a=j.address||{};
      const waterWords=['Ocean','Gulf','Bay','Sound','Sea','Lagoon'];
      if(waterWords.some(w=>j.display_name?.includes(w))){ geocodeCache.set(key,null); return null; }
      let label=(a.city||a.town||a.village||a.hamlet||a.county||'').toString();
      if(!label && a.state) label=a.state;
      if(!label){ geocodeCache.set(key,null); return null; }
      if(includeState && a.state) label = `${label}, ${a.state}`;
      geocodeCache.set(key,label);
      return label;
    }catch{ geocodeCache.set(key,null); return null; }
  });
}

/* ========= fetch helper with timeout ========= */
async function fetchJSON(url, timeoutMs=9000){
  const ctrl = new AbortController();
  const t = setTimeout(()=>ctrl.abort('timeout'), timeoutMs);
  try{
    const resp = await fetch(url,{signal:ctrl.signal});
    if(!resp.ok) throw new Error(`HTTP ${resp.status}`);
    return await resp.json();
  }finally{ clearTimeout(t); }
}

/* ========= thermo helpers ========= */
function dewpointFromTRH(tF, rh){
  const tC=(tF-32)*5/9;
  const a=17.625, b=243.04;
  const gamma = Math.log(Math.max(1e-6, rh/100)) + (a*tC)/(b+tC);
  const dpC = (b*gamma)/(a-gamma);
  return dpC*9/5+32;
}

function heatIndex(tF, RH){
  const T=tF, R=Math.max(0,Math.min(100, RH??50));
  if(T<80 || R<40){
    // simple adjustment (NOAA)
    const adj = -42.379 + 2.04901523*T + 10.14333127*R - 0.22475541*T*R - 6.83783e-3*T*T - 5.481717e-2*R*R + 1.22874e-3*T*T*R + 8.5282e-4*T*R*R - 1.99e-6*T*T*R*R;
    return Math.round(0.7*adj + 0.3*T);
  }
  let HI= -42.379 + 2.04901523*T + 10.14333127*R - 0.22475541*T*R - 6.83783e-3*T*T - 5.481717e-2*R*R + 1.22874e-3*T*T*R + 8.5282e-4*T*R*R - 1.99e-6*T*T*R*R;
  // adjustments
  if(R<13 && (T>=80 && T<=112)) HI -= ((13-R)/4)*Math.sqrt((17-Math.abs(T-95))/17);
  if(R>85 && (T>=80 && T<=87))   HI += ((R-85)/10)*((87-T)/5);
  return Math.round(HI);
}

/* ========= Weather service ========= */
class Weather{
  constructor(){ this.cache=new Map(); this.CACHE=5*60*1000; }

  async get(lat,lon,opts={bulk:false}){
    const key=`${lat.toFixed(2)},${lon.toFixed(2)}${opts.bulk?'|b':''}`;
    const c=this.cache.get(key);
    if(c && Date.now()-c.t<this.CACHE) return c.d;

    // Prefer NOAA for "current" when not bulk
    if(!opts.bulk && approxUSLower48(lat,lon)){
      try{
        const p = await fetchJSON(`https://api.weather.gov/points/${lat.toFixed(4)},${lon.toFixed(4)}`,8000);
        if(p?.properties?.observationStations){
          const stations = await fetchJSON(p.properties.observationStations,8000);
          const feats=(stations.features||[]).slice(0,6);
          for(const f of feats){
            const id=f.properties?.stationIdentifier;
            if(!id) continue;
            try{
              const ob = await fetchJSON(`https://api.weather.gov/stations/${id}/observations/latest`,8000);
              const props=ob.properties||{};
              const tC=props.temperature?.value;
              const tdC=props.dewpoint?.value;
              const pPa=props.barometricPressure?.value;
              const rh = props.relativeHumidity?.value;
              if(tC!=null && pPa!=null){
                let outDpF = (tdC!=null) ? (tdC*9/5+32) : dewpointFromTRH(tC*9/5+32, rh ?? 50);
                const out={
                  temp: Math.round(tC*9/5+32),
                  dewpoint: Math.round(outDpF),
                  humidity: Math.round(rh ?? 50),
                  pressure: Math.round(pPa/100),
                  wind: Math.round(((props.windSpeed?.value)||0)*2.237),
                  timestamp: new Date(props.timestamp||Date.now()),
                  source: 'NOAA'
                };
                if(out.humidity!=null && out.humidity<97 && Math.abs(out.temp - out.dewpoint)<=0){
                  out.dewpoint = Math.round(dewpointFromTRH(out.temp, out.humidity));
                }
                this.cache.set(key,{d:out,t:Date.now()});
                return out;
              }
            }catch{/* try next station */}
          }
        }
      }catch{/* fall through */}
    }

    // Open-Meteo fallback / bulk
    try{
      const j = await fetchJSON(
        `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}`+
        `&current=temperature_2m,relative_humidity_2m,dew_point_2m,surface_pressure,wind_speed_10m`+
        `&temperature_unit=fahrenheit&wind_speed_unit=mph`,9000);
      let out={
        temp:Math.round(j.current.temperature_2m),
        dewpoint:Math.round(j.current.dew_point_2m),
        humidity:j.current.relative_humidity_2m,
        pressure:Math.round(j.current.surface_pressure),
        wind:Math.round(j.current.wind_speed_10m),
        timestamp:new Date(),
        source:'Open-Meteo'
      };
      if(out.humidity!=null && out.humidity<97 && Math.abs(out.temp - out.dewpoint)<=0){
        out.dewpoint = Math.round(dewpointFromTRH(out.temp, out.humidity));
      }
      this.cache.set(key,{d:out,t:Date.now()});
      return out;
    }catch(e){ /* network issue */ }

    return {temp:72,dewpoint:55,humidity:50,pressure:1013,wind:5,timestamp:new Date(),source:'Fallback'};
  }

  // Hourly (dewpoint guard + bias) + uv + pressure
  async hourly(lat,lon){
    const j = await fetchJSON(
      `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}`+
      `&current=dew_point_2m`+
      `&hourly=dew_point_2m,temperature_2m,relative_humidity_2m,wind_speed_10m,precipitation_probability,cloud_cover,uv_index,surface_pressure`+
      `&temperature_unit=fahrenheit&wind_speed_unit=mph&timezone=auto`,9000);

    const hours=(j.hourly.time||[]).map((t,i)=>{
      const temp = Math.round(j.hourly.temperature_2m?.[i] ?? NaN);
      const rh   = j.hourly.relative_humidity_2m?.[i] ?? null;
      let dp  = Math.round(j.hourly.dew_point_2m?.[i] ?? NaN);
      if(Number.isNaN(dp) || (rh!=null && rh<97 && Math.abs((dp??0) - temp)<=0)){
        if(rh!=null && Number.isFinite(temp)) dp = Math.round(dewpointFromTRH(temp, rh));
      }
      return {
        time:t,
        dp,
        temp,
        rh: rh,
        wind: Math.round(j.hourly.wind_speed_10m?.[i] ?? 0),
        pop:  j.hourly.precipitation_probability?.[i] ?? null,
        clouds: j.hourly.cloud_cover?.[i] ?? null,
        uv: j.hourly.uv_index?.[i] ?? null,
        press: j.hourly.surface_pressure?.[i] ?? null
      };
    });

    const omCurrentDp = (j.current && j.current.dew_point_2m!=null)
      ? Math.round(j.current.dew_point_2m)
      : null;

    return {hours, omCurrentDp, tz: j.timezone || 'UTC'};
  }
}
const weather=new Weather();

/* ========= Calcs ========= */
function wetBulb(tF,rh){const C=(tF-32)*5/9;const wb=C*Math.atan(0.151977*Math.sqrt(rh+8.313659))+Math.atan(C+rh)-Math.atan(rh-1.676331)+0.00391838*Math.pow(rh,1.5)*Math.atan(0.023101*rh)-4.686035;return Math.round(wb*9/5+32);}
function vpd(tF,rh){const C=(tF-32)*5/9;const svp=0.6108*Math.exp(17.27*C/(C+237.3));const avp=svp*(rh??50)/100;return (svp-avp).toFixed(2);}
const fmtTime = iso => new Date(iso).toLocaleTimeString('en-US',{hour:'numeric'});
const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
const dateKeyInTz=(iso,tz)=> new Date(iso).toLocaleDateString('en-CA',{timeZone:tz}); // YYYY-MM-DD
const todayKeyInTz=(tz)=> new Date().toLocaleDateString('en-CA',{timeZone:tz});

/* ========= State & maps ========= */
let userLocation={lat:40.7128,lon:-74.0060};
let maps={};
let escapeLayer=null;

/* ========= Outcome helpers ========= */
function wearAdviceText(t, dp, wind, pop){
  let parts=[];
  if(t>=85) parts.push("Lightweight tee/tank & shorts, breathable fabrics");
  else if(t>=70) parts.push("T-shirt & shorts or light pants");
  else if(t>=55) parts.push("Long sleeves or light sweater; pants");
  else if(t>=40) parts.push("Jacket/hoodie; consider beanie after dark");
  else parts.push("Insulated coat, hat & gloves");

  if(wind>=15) parts.push("Add a windbreaker");
  if(pop>=40) parts.push("Pack a light rain layer");
  if(dp>=70) parts.push("Very humid ‚Äî sweat-wicking fabrics");
  else if(dp>=60) parts.push("Humid ‚Äî avoid heavy cotton");
  else if(dp<=35) parts.push("Dry air ‚Äî moisturizer/lip balm");

  return "üëï " + parts.join(" ‚Ä¢ ");
}
function frizzText(dp){
  if(dp>=65) return "üíá Frizz risk: <strong>High</strong> ‚Äî keep styles up, use anti-humectant products.";
  if(dp>=56) return "üíá Frizz risk: <strong>Moderate</strong> ‚Äî light hold helps, avoid glycerin-heavy products.";
  if(dp>=40) return "üíá Frizz risk: <strong>Low</strong> ‚Äî styles hold well.";
  return "üíá Frizz risk: <strong>Very low</strong> ‚Äî air is dry (add a bit of moisture to avoid static).";
}
function laundryText(vpdVal, wind){
  const v = parseFloat(vpdVal||"0");
  let rate = (v<0.5?"slow":v<1?"moderate":v<2?"fast":"very fast");
  if(wind>=12) rate = rate==="slow"?"moderate":rate==="moderate"?"fast":"very fast";
  return `üß∫ Laundry drying: <strong>${rate}</strong> (VPD ${v.toFixed(2)} kPa, wind ${wind} mph)`;
}

/* ========= Local panel ========= */
async function updateLocal(){
  const d=await weather.get(userLocation.lat,userLocation.lon,{bulk:false});
  document.getElementById('temp').textContent=`${d.temp}¬∞`;
  document.getElementById('dewpoint').textContent=`${d.dewpoint}¬∞`;
  document.getElementById('wetbulb').textContent=`${wetBulb(d.temp,d.humidity)}¬∞`;
  document.getElementById('vpd').textContent=`${vpd(d.temp,d.humidity)}`;
  document.getElementById('spread').textContent=`${d.temp-d.dewpoint}¬∞`;
  document.getElementById('pressure').textContent=`${d.pressure}`;
  const age=Math.max(0,Math.round((Date.now()-d.timestamp)/60000));
  document.getElementById('dataAge').textContent=`Data: ${age} min old (${d.source})`;

  // hourly forecast + bias to current Td
  let fc;
  try { fc=await weather.hourly(userLocation.lat,userLocation.lon); }
  catch { fc={hours:[],omCurrentDp:null,tz:'UTC'}; }

  const biasRaw = (fc.omCurrentDp!=null && Number.isFinite(d.dewpoint)) ? (d.dewpoint - fc.omCurrentDp) : 0;
  const bias = clamp(biasRaw, -8, 8);
  const correctedHours = (fc.hours||[]).map((h,idx)=>{
    const factor = idx<18 ? 1 : idx<48 ? 0.6 : 0.3;
    let dp = h.dp;
    if(Number.isFinite(dp)) dp = Math.round(clamp(dp + bias*factor, -40, 85));
    return {...h, dp};
  });

  /* What to wear (next 6h averages) */
  const next6 = correctedHours.filter(h => new Date(h.time)>new Date()).slice(0,6);
  const avgTemp = Math.round((next6.reduce((a,b)=>a+(b.temp||d.temp),0)/(next6.length||1))||d.temp);
  const avgDp   = Math.round((next6.reduce((a,b)=>a+(b.dp||d.dewpoint),0)/(next6.length||1))||d.dewpoint);
  const maxWind = Math.max(d.wind||0, ...(next6.map(h=>h.wind||0)));
  const maxPop  = Math.max(...next6.map(h=>h.pop??0),0);
  document.getElementById('wearAdvice').innerHTML = wearAdviceText(avgTemp, avgDp, maxWind, maxPop);
  document.getElementById('frizzRisk').innerHTML = frizzText(avgDp);
  document.getElementById('laundryIndex').innerHTML = laundryText(vpd(d.temp,d.humidity), d.wind||0);

  /* UV insight (now & peak next 6h) */
  const next6uv = next6.map(h=>({t:h.time,uv:h.uv??0}));
  const uvNow = correctedHours.find(h=>new Date(h.time).getHours()===new Date().getHours())?.uv ?? null;
  const uvPeak = next6uv.reduce((m,c)=> c.uv>m.uv?c:m, {uv:-1,t:null});
  const uvTxt = (uvPeak.uv<=0)? "Low UV for the next few hours."
              : `UV now ${uvNow!=null?Math.round(uvNow):"‚Äì"}; peak ~${Math.round(uvPeak.uv)} around ${uvPeak.t?fmtTime(uvPeak.t):"‚Äî"}. SPF 30+, sunglasses recommended.`;
  document.getElementById('uvInsight').innerHTML = `‚òÄÔ∏è ${uvTxt}`;

  /* pressure trend (past 6h) */
  const past6 = correctedHours.filter(h=>new Date(h.time)<=new Date()).slice(-6);
  let pTrend = "‚Äì";
  if(past6.every(h=>h.press!=null)){
    const dp = past6[past6.length-1].press - past6[0].press;
    pTrend = dp>1 ? "rising (calmer/clearer)" : dp<-1 ? "falling (more unsettled)" : "steady";
  }
  document.getElementById('pressureTrend').innerHTML = `üß≠ Pressure trend: <strong>${pTrend}</strong>`;

  /* windows-open tonight (10pm‚Äì6am local) */
  const tz = fc.tz || 'UTC';
  const overnight = correctedHours.filter(h=>{
    const t=new Date(h.time);
    const hr = parseInt(t.toLocaleString('en-US',{hour:'2-digit',hour12:false,timeZone:tz}),10);
    const inNext24 = t - Date.now() > 0 && t - Date.now() <= 24*3600*1000;
    return inNext24 && (hr>=22 || hr<=6);
  });
  if(overnight.length){
    const ok = overnight.map(h=>{
      const goodTemp = (h.temp>=60 && h.temp<=72);
      const goodDp   = (h.dp>=45 && h.dp<=60);
      const lowRain  = (h.pop??0) <= 30;
      return (goodTemp && goodDp && lowRain) ? 1 : 0;
    }).reduce((a,b)=>a+b,0);
    const pct = Math.round(100*ok/overnight.length);
    document.getElementById('windowsOpen').innerHTML =
      pct>=60 ? `ü™ü Open-windows tonight: <strong>Yes (${pct}% of overnight hours look comfy)</strong>` :
                `ü™ü Open-windows tonight: <strong>Meh (${pct}% comfy hours)</strong> ‚Äî target a dehumidified room.`;
  }else{
    document.getElementById('windowsOpen').innerHTML = 'ü™ü Open-windows tonight: data not available yet.';
  }

  /* WINDOWS-DOWN DRIVING (next 4h) */
  const next4 = correctedHours.filter(h => new Date(h.time)>new Date()).slice(0,4);
  if(next4.length){
    let comfy=0, borderline=0;
    next4.forEach(h=>{
      const rainOk = (h.pop??0) <= 20;
      const rainBorder = (h.pop??0) <= 35;
      const tOk = h.temp>=62 && h.temp<=82;
      const tBorder = h.temp>=55 && h.temp<=85;
      const dpOk = h.dp<=62;
      const dpBorder = h.dp<=67;
      const windOk = h.wind<=18;
      const windBorder = h.wind<=25;
      if(tOk && dpOk && rainOk && windOk) comfy++;
      else if(tBorder && dpBorder && rainBorder && windBorder) borderline++;
    });
    const note = `(${comfy}/${next4.length} great ‚Ä¢ ${borderline} borderline)`;
    document.getElementById('windowsDown').innerHTML =
      comfy>=2 ? `üöó Windows-down: <strong>Yes</strong> ${note}` :
      (comfy+borderline>=2 ? `üöó Windows-down: <strong>Maybe</strong> ${note}` :
      `üöó Windows-down: <strong>Nope</strong> ‚Äî sticky, windy, or rainy in the next few hours.`);
  }else{
    document.getElementById('windowsDown').textContent='üöó Windows-down: not enough data yet.';
  }

  /* RUN OUTSIDE (best hour next 12h) */
  const next12 = correctedHours.filter(h => new Date(h.time)>new Date()).slice(0,12);
  if(next12.length){
    const scored = next12.map(h=>{
      let s=100;
      if(h.temp<35) s -= (35-h.temp)*2;
      else if(h.temp<45) s -= (45-h.temp)*1;
      else if(h.temp>70 && h.temp<=80) s -= (h.temp-70)*2;
      else if(h.temp>80) s -= (h.temp-80)*4;
      if(h.dp>60 && h.dp<=70) s -= (h.dp-60)*2;
      else if(h.dp>70) s -= (h.dp-70)*3.5;
      if(h.wind>15) s -= (h.wind-15)*2;
      if((h.pop??0)>40) s = 0; else s -= (h.pop??0)*0.5;
      if((h.uv??0)>6) s -= (h.uv-6)*3;
      return {...h, score:Math.max(0,Math.min(100,Math.round(s)))};
    }).sort((a,b)=>b.score-a.score);
    const best=scored[0];
    const when=fmtTime(best.time);
    document.getElementById('runOutside').innerHTML =
      `üèÉ ${best.score>=75?"Go around":best.score>=50?"Better around":"If you must, try"} <strong>${when}</strong> ‚Äî score ${best.score}/100 (${best.temp}¬∞F, Td ${best.dp}¬∞, wind ${best.wind} mph)`;
  }else{
    document.getElementById('runOutside').textContent='üèÉ Best run time: not enough data yet.';
  }

  /* Static shock + Dehumidifier */
  const vpdNow = parseFloat(vpd(d.temp,d.humidity));
  let staticTxt = '‚ö° Static risk: <strong>Low</strong>.';
  if(vpdNow>2 && d.dewpoint<35) staticTxt = '‚ö° Static risk: <strong>High</strong> ‚Äî moisturize & use fabric softener.';
  else if(vpdNow>1.2 && d.dewpoint<40) staticTxt = '‚ö° Static risk: <strong>Moderate</strong>.';
  document.getElementById('staticRisk').innerHTML = staticTxt;

  if(overnight.length){
    const avgNightDp = Math.round(overnight.reduce((a,b)=>a+(b.dp||0),0)/overnight.length);
    const muggyHours = overnight.filter(h=>h.dp>=65).length;
    const pct = Math.round(100*muggyHours/overnight.length);
    document.getElementById('dehumidify').innerHTML =
      avgNightDp>=65 || pct>=50
        ? `üíß Dehumidifier tonight: <strong>Yes</strong> (avg overnight Td ${avgNightDp}¬∞, ${pct}% of hours ‚â•65¬∞).`
        : `üíß Dehumidifier tonight: <strong>No need</strong> (avg overnight Td ${avgNightDp}¬∞).`;
  }else{
    document.getElementById('dehumidify').textContent='üíß Dehumidifier tonight: data not available yet.';
  }

  /* moisture insights */
  const spreadNow=d.temp-d.dewpoint;
  const moist=spreadNow<5?'‚ö†Ô∏è Near saturation ‚Äî fog/mist likely'
              :spreadNow<10?'Very humid ‚Äî condensation on cold surfaces'
              :spreadNow<20?'Comfortable moisture levels'
              :'Dry air ‚Äî static electricity likely';
  const dv=vpd(d.temp,d.humidity);
  document.getElementById('moistureInsight').innerHTML=
    `<strong>Moisture Status:</strong> ${moist}<br>`+
    `<strong>VPD ${dv} kPa:</strong> ${dv<0.5?'Air is saturated':dv>2?'Air is very thirsty':'Moderate moisture demand'}`;

  const surfaces=[{name:'Windows',temp:d.temp-15},{name:'Walls',temp:d.temp-8},{name:'Metal objects',temp:d.temp-20}];
  const risks=surfaces.filter(s=>s.temp<=d.dewpoint).map(s=>s.name);
  document.getElementById('condensationRisk').innerHTML=
    risks.length?`‚ö†Ô∏è <strong>Condensation likely on:</strong> ${risks.join(', ')}`:
                  `‚úì <strong>No condensation risk</strong> ‚Äî all surfaces above dew point`;

  /* Heat Index timeline (now + next 12h) */
  const hiEl=document.getElementById('hiTimeline'); hiEl.innerHTML='';
  const next12hHI = correctedHours.filter(h => new Date(h.time)>new Date()).slice(0,12);
  (next12hHI.length?next12hHI:correctedHours.slice(0,12)).forEach(h=>{
    const hi = Number.isFinite(h.temp) ? heatIndex(h.temp, h.rh) : null;
    const el=document.createElement('div');
    el.className='bucket';
    el.innerHTML=`<strong>${fmtTime(h.time)}</strong>`+
                 `<div class="tval">${hi!=null?hi:'‚Äì'}¬∞</div>`+
                 `<div class="mini">${(h.rh??'‚Äì')}% RH ‚Ä¢ ${h.wind} mph</div>`;
    hiEl.appendChild(el);
  });

  /* Dew timelines */
  const tl=document.getElementById('dewTimeline'); tl.innerHTML='';
  const nowAbs=new Date();
  const next12h = correctedHours.filter(h => new Date(h.time) > nowAbs).slice(0,12);
  (next12h.length?next12h:correctedHours.slice(0,12)).forEach(h=>{
    const el=document.createElement('div');
    el.className='bucket';
    el.innerHTML=`<strong>${fmtTime(h.time)}</strong>`+
                 `<div class="tval">${h.dp}¬∞</div>`+
                 `<div class="mini">${(h.pop??'‚Äì')}% precip ‚Ä¢ ${h.wind} mph</div>`;
    tl.appendChild(el);
  });

  // Group by forecast tz, start TODAY
  const todayKey = todayKeyInTz(tz);
  const groups=new Map();
  correctedHours.forEach(h=>{
    const key=dateKeyInTz(h.time, tz);
    if(key>=todayKey){
      if(!groups.has(key)) groups.set(key,[]);
      groups.get(key).push(h);
    }
  });
  const dayKeys=[...groups.keys()].sort();

  // 5-day min/max dew
  const daysEl=document.getElementById('dewDays'); daysEl.innerHTML='';
  dayKeys.slice(0,5).forEach(k=>{
    const arr=groups.get(k)||[];
    if(!arr.length) return;
    const min=Math.min(...arr.map(x=>x.dp));
    const max=Math.max(...arr.map(x=>x.dp));
    const el=document.createElement('div');
    el.className='bucket';
    el.innerHTML=`<strong>${new Date(k+'T12:00:00').toLocaleDateString('en-US',{weekday:'short', timeZone: tz})}</strong>`+
                 `<div class="tval">${min}¬∞ ‚Äì ${max}¬∞</div>`+
                 `<div class="mini">min / max dew</div>`;
    daysEl.appendChild(el);
  });

  // Fire-pit evenings (6‚Äì11 PM)
  const fireEl=document.getElementById('fireDays'); fireEl.innerHTML='';
  dayKeys.forEach(k=>{
    const arr=(groups.get(k)||[]).filter(h=>{
      const hr=new Date(h.time).toLocaleString('en-US',{hour:'2-digit',hour12:false,timeZone:tz});
      const hInt=parseInt(hr,10);
      return hInt>=18 && hInt<=23;
    });
    if(!arr.length) return;

    const avgDew=Math.round(arr.reduce((a,b)=>a+b.dp,0)/arr.length);
    const avgTemp=Math.round(arr.reduce((a,b)=>a+b.temp,0)/arr.length);
    const maxWind=Math.max(...arr.map(h=>h.wind));
    const maxPop=Math.max(...arr.map(h=>h.pop??0));
    const avgClouds=Math.round(arr.reduce((a,b)=>a+(Number.isFinite(b.clouds)?b.clouds:50),0)/arr.length);

    let score=100;
    if(avgDew<35) score-= (35-avgDew)*2.5;
    if(avgDew>55) score-= (avgDew-55)*2.5;
    if(maxWind>10) score-= (maxWind-10)*3;
    if(maxWind>20) score=0;
    score-= maxPop*0.8;
    if(avgClouds>30) score-= (avgClouds-30)*0.5;
    if(avgTemp<55) score-= (55-avgTemp);
    if(avgTemp>75) score-= (avgTemp-75)*0.5;
    score=Math.max(0,Math.min(100,score));

    let rating='',color='';
    if(score>=80){rating='üî•üî•üî•';color='#10b981';}
    else if(score>=60){rating='üî•üî•';color='#f59e0b';}
    else if(score>=40){rating='üî•';color='#64748b';}
    else {rating='‚ùå';color='#dc2626';}

    const el=document.createElement('div');
    el.className='bucket';
    el.style.minWidth='110px';
    el.innerHTML=`<strong>${new Date(k+'T12:00:00').toLocaleDateString('en-US',{weekday:'short', timeZone: tz})}</strong>
      <div style="font-size:1.5rem">${rating}</div>
      <div class="mini" style="color:${color}">${Math.round(score)}% ideal</div>
      <div class="mini" style="font-size:.6rem">${avgTemp}¬∞F ‚Ä¢ ${maxWind}mph<br>${maxPop}% rain ‚Ä¢ ${avgClouds}% clouds</div>`;
    fireEl.appendChild(el);
  });

  // Tonight hint
  const tonightKey = dayKeys[0];
  if(tonightKey){
    const tonightArr=(groups.get(tonightKey)||[]).filter(h=>{
      const hr=new Date(h.time).toLocaleString('en-US',{hour:'2-digit',hour12:false,timeZone:tz});
      const hInt=parseInt(hr,10);
      return hInt>=18 && hInt<=23;
    });
    if(tonightArr.length){
      const avgDP=Math.round(tonightArr.reduce((a,b)=>a+b.dp,0)/tonightArr.length);
      const maxWind2=Math.max(...tonightArr.map(h=>h.wind));
      const maxPop2=Math.max(...tonightArr.map(h=>h.pop??0));
      const good=(avgDP>=35&&avgDP<=55)&&maxWind2<=12&&maxPop2<25;
      document.getElementById('firepitHint').innerHTML=good
        ? `üî• <strong>Good fire-pit tonight:</strong> avg dew ${avgDP}¬∞, wind ‚â§${maxWind2} mph, precip ‚â§${maxPop2}%`
        : `ü™µ <strong>Meh for fire-pit:</strong> avg dew ${avgDP}¬∞, wind up to ${maxWind2} mph, precip up to ${maxPop2}%`;
    }else{
      document.getElementById('firepitHint').textContent='Fire-pit check: evening data not available yet.';
    }
  }else{
    document.getElementById('firepitHint').textContent='Fire-pit check: evening data not available yet.';
  }
}

/* ========= Weather Escape (miles) ========= */
function emojiDivIcon(char){ 
  return L.divIcon({className:'', html:`<div class="emoji-pin">${char}</div>`, iconSize:[22,22], iconAnchor:[11,11]}); 
}

async function escapeRoulette(lat, lon){
  const resEl=document.getElementById('escapeResults');
  resEl.innerHTML = '<div class="loading" style="margin:20px auto;display:block"></div>';

  const here = await weather.get(lat, lon,{bulk:false});
  const hereName = await nameIfUSLand(lat,lon,true) || `${lat.toFixed(1)}¬∞, ${Math.abs(lon).toFixed(1)}¬∞W`;

  const radiusMi = parseInt(document.getElementById('escapeRadius').value,10) || 1200;
  const pts=[];
  const DEG_MI = 69; // ~ miles per degree latitude
  const candidateCount=Math.min(70, Math.max(24, Math.round(radiusMi/25)));
  for(let i=0;i<candidateCount;i++){
    const r = Math.random()*radiusMi;
    const theta = Math.random()*Math.PI*2;
    const dlat = (r*Math.cos(theta))/DEG_MI;
    const dlon = (r*Math.sin(theta))/(DEG_MI*Math.cos(lat*Math.PI/180));
    const plat = lat + dlat;
    const plon = lon + dlon;
    if(approxUSLower48(plat,plon)) pts.push({lat:plat,lon:plon});
  }
  if(!pts.length){ resEl.innerHTML='<p style="text-align:center;color:var(--muted)">No nearby land points to sample.</p>'; return; }

  const evals=[];
  for(const p of pts){
    try{
      const fc = await weather.hourly(p.lat,p.lon);
      const tz = fc.tz || 'UTC';
      const ev = (fc.hours||[]).filter(h=>{
        const hr=new Date(h.time).toLocaleString('en-US',{hour:'2-digit',hour12:false,timeZone:tz});
        const hInt=parseInt(hr,10);
        return hInt>=18 && hInt<=23 && new Date(h.time)>new Date();
      });
      if(!ev.length) continue;
      const avgT = Math.round(ev.reduce((a,b)=>a+(b.temp||0),0)/ev.length);
      const avgD = Math.round(ev.reduce((a,b)=>a+(b.dp||0),0)/ev.length);
      const avgC = Math.round(ev.reduce((a,b)=>a+(Number.isFinite(b.clouds)?b.clouds:50),0)/ev.length);
      const maxP = Math.max(...ev.map(h=>h.pop??0),0);
      const maxW = Math.max(...ev.map(h=>h.wind||0),0);
      const dist = Math.round(hav({lat,lon},{lat:p.lat,lon:p.lon}));
      const brg = bearing({lat,lon},{lat:p.lat,lon:p.lon});
      const name = await nameIfUSLand(p.lat,p.lon,true) || `${p.lat.toFixed(1)}¬∞, ${Math.abs(p.lon).toFixed(1)}¬∞W`;
      evals.push({...p, name, avgT, avgD, avgC, maxP, maxW, dist, brg});
    }catch{/* skip */}
  }
  if(!evals.length){ resEl.innerHTML='<p style="text-align:center;color:var(--muted)">Couldn‚Äôt sample forecasts within the radius.</p>'; return; }

  const coolest = [...evals].sort((a,b)=>a.avgT-b.avgT)[0];
  const driest  = [...evals].sort((a,b)=>a.avgD-b.avgD)[0];
  const clearest= [...evals].sort((a,b)=> (a.avgC + (a.maxP*2)) - (b.avgC + (b.maxP*2)) )[0];

  if(escapeLayer){ escapeLayer.clearLayers(); } else { escapeLayer=L.layerGroup().addTo(maps.escape); }
  const youM = L.marker([lat,lon],{icon:emojiDivIcon('üéØ')}).bindPopup(`<strong>${hereName}</strong><br>${here.temp}¬∞F ‚Ä¢ dew ${here.dewpoint}¬∞`).addTo(escapeLayer);
  const coolM = coolest ? L.marker([coolest.lat,coolest.lon],{icon:emojiDivIcon('‚ùÑÔ∏è')}).bindPopup(`<strong>${coolest.name}</strong><br>${coolest.avgT}¬∞F ‚Ä¢ dew ${coolest.avgD}¬∞ ‚Ä¢ ${coolest.avgC}% clouds`).addTo(escapeLayer) : null;
  const dryM  = driest  ? L.marker([driest.lat,driest.lon],{icon:emojiDivIcon('üå¨Ô∏è')}).bindPopup(`<strong>${driest.name}</strong><br>${driest.avgT}¬∞F ‚Ä¢ dew ${driest.avgD}¬∞`).addTo(escapeLayer) : null;
  const clearM= clearest? L.marker([clearest.lat,clearest.lon],{icon:emojiDivIcon('‚ú®')}).bindPopup(`<strong>${clearest.name}</strong><br>${clearest.avgT}¬∞F ‚Ä¢ ${clearest.avgC}% clouds ‚Ä¢ ${clearest.maxP}% rain`).addTo(escapeLayer) : null;

  const bounds = L.latLngBounds([]);
  [youM, coolM, dryM, clearM].forEach(m=>{ if(m) bounds.extend(m.getLatLng()); });
  if(bounds.isValid()) maps.escape.fitBounds(bounds.pad(0.2));

  function line(label, val, note){ return `<div class="twin-card"><div><strong>${label}</strong><br>${val}</div><div style="color:var(--muted);font-size:.85rem">${note||''}</div></div>`; }
  function dirDist(e){ return `${dir8(e.brg)} ‚Ä¢ ${e.dist} mi away`; }

  document.getElementById('escapeResults').innerHTML = `
    <h3>üìç Start: ${hereName}</h3>
    ${line("Now", `${here.temp}¬∞F ‚Ä¢ dew ${here.dewpoint}¬∞ ‚Ä¢ wind ${here.wind??0} mph ‚Ä¢ pressure ${here.pressure} hPa`, "")}
    ${coolest ? `<h3>‚ùÑÔ∏è Coolest Nearby</h3>${line(coolest.name, `${coolest.avgT}¬∞F evening ‚Ä¢ dew ${coolest.avgD}¬∞ ‚Ä¢ ${coolest.maxW} mph ‚Ä¢ ${coolest.avgC}% clouds`, dirDist(coolest))}` : ""}
    ${driest ? `<h3>üå¨Ô∏è Driest Nearby</h3>${line(driest.name, `dew ${driest.avgD}¬∞ ‚Ä¢ ${driest.avgT}¬∞F ‚Ä¢ ${driest.maxW} mph`, dirDist(driest))}` : ""}
    ${clearest ? `<h3>‚ú® Clearest Skies</h3>${line(clearest.name, `${clearest.avgC}% clouds ‚Ä¢ ${clearest.maxP}% rain ‚Ä¢ ${clearest.avgT}¬∞F`, dirDist(clearest))}` : ""}
  `;
}

/* ========= Maps ========= */
function initMaps() {
  // Local map
  maps.local = L.map('localMap').setView([userLocation.lat, userLocation.lon], 8);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution: '¬© OpenStreetMap contributors'}).addTo(maps.local);
  const localMarker = L.marker([userLocation.lat, userLocation.lon]).addTo(maps.local);
  maps.local.on('click', async (e) => {
    userLocation = {lat: e.latlng.lat, lon: e.latlng.lng};
    localMarker.setLatLng(e.latlng);
    document.getElementById('locationInput').value = `${e.latlng.lat.toFixed(4)}, ${e.latlng.lng.toFixed(4)}`;
    await updateLocal();
  });

  // Weather Escape map
  maps.escape = L.map('escapeMap').setView([39, -98], 4);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution: '¬© OpenStreetMap contributors'}).addTo(maps.escape);
  maps.escape.on('click', (e) => escapeRoulette(e.latlng.lat, e.latlng.lng));
}

/* ========= Tabs ========= */
window.switchTab = function(evt, tab){
  document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
  evt.target.classList.add('active');
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.getElementById(tab).classList.add('active');
  setTimeout(()=>{ if(maps[tab]) maps[tab].invalidateSize(); }, 100);
}

/* ========= Set location from input ========= */
window.setLocation = async function(){
  const input = document.getElementById('locationInput').value;
  const coords = input.split(',').map(s => parseFloat(s.trim()));
  if (coords.length === 2 && !isNaN(coords[0]) && !isNaN(coords[1])) {
    userLocation = {lat: coords[0], lon: coords[1]};
    if (maps.local) {
      maps.local.setView([userLocation.lat, userLocation.lon], 8);
      maps.local.eachLayer((layer) => {
        if (layer instanceof L.Marker) layer.setLatLng([userLocation.lat, userLocation.lon]);
      });
    }
    await updateLocal();
  } else {
    alert('Please enter coordinates as: latitude, longitude (e.g., 40.7128, -74.0060)');
  }
}

/* ========= Geolocation (optional) ========= */
function getUserLocation() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(async (pos)=>{
      userLocation={lat:pos.coords.latitude, lon:pos.coords.longitude};
      document.getElementById('locationInput').value = `${userLocation.lat.toFixed(4)}, ${userLocation.lon.toFixed(4)}`;
      if(maps.local){
        maps.local.setView([userLocation.lat, userLocation.lon], 8);
        maps.local.eachLayer((layer)=>{ if(layer instanceof L.Marker) layer.setLatLng([userLocation.lat, userLocation.lon]); });
      }
      await updateLocal();
    }, ()=>{/* user denied ‚Üí keep default */});
  }
}

/* ========= Init ========= */
window.addEventListener('DOMContentLoaded', async ()=>{
  initMaps();
  getUserLocation();
  await updateLocal(); // initial
});
</script>
</body>
</html>
